<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Daily Quest</title>
<!-- PWA Manifest -->
<link href="manifest.json?v=1757559779" rel="manifest"/>
<!-- PWA Meta Tags -->
<meta content="#111111" name="theme-color"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="default" name="apple-mobile-web-app-status-bar-style"/>
<meta content="Task Rock" name="apple-mobile-web-app-title"/>
<meta content="Task Rock" name="application-name"/>
<meta content="#9AE34A" name="msapplication-TileColor"/>
<!-- Icons for Browser Tabs and Mobile -->
<link href="assets/icons/icon-16.png" rel="icon" sizes="16x16" type="image/png"/>
<link href="assets/icons/icon-32.png" rel="icon" sizes="32x32" type="image/png"/>
<link href="assets/icons/icon-48.png" rel="icon" sizes="48x48" type="image/png"/>
<link href="assets/icons/icon-96.png" rel="icon" sizes="96x96" type="image/png"/>
<link href="assets/icons/icon-192.png" rel="icon" sizes="192x192" type="image/png"/>
<link href="assets/icons/apple-touch-icon-180.png" rel="apple-touch-icon" sizes="180x180"/>
<link href="assets/icons/icon-32.png" rel="shortcut icon"/>
<!-- SEO Meta Tags -->
<meta content="Daily Quest - An RPG productivity game with Jerry the Rock, your virtual pet companion" name="description"/>
<meta content="task manager, productivity, pet rock, jerry, tasks, todo" name="keywords"/>
<meta content="Task Rock" name="author"/>
<!-- Open Graph Meta Tags -->
<meta content="Daily Quest - RPG Productivity Game" property="og:title"/>
<meta content="A fun task management app with Jerry the Rock, your virtual pet companion" property="og:description"/>
<meta content="assets/images/icon-512x512.png" property="og:image"/>
<meta content="https://storygrid00.github.io/Task_Rock" property="og:url"/>
<meta content="website" property="og:type"/>
<!-- Twitter Card Meta Tags -->
<meta content="summary_large_image" name="twitter:card"/>
<meta content="Daily Quest - RPG Productivity Game" name="twitter:title"/>
<meta content="A fun task management app with Jerry the Rock, your virtual pet companion" name="twitter:description"/>
<meta content="assets/images/icon-512x512.png" name="twitter:image"/>

<style>
        :root {
    /* Daily Challenge complete color */
    --challenge-complete: #ccff00; /* neon green-yellow */

            /* Quick Task action button background token */
            --quick-action-bg: #ffffff;
            /* Daily Challenge (scoped) */
            --daily-card-purple: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --daily-card-green:  linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            --daily-card-orange-gradient: linear-gradient(135deg, #ea580c 0%, #f59e0b 100%);
        
            /* Dark theme colors (default and only) */
            --bg-primary: #f8f9fa;
            --bg-secondary: white;
            --bg-tertiary: #e0e0e0;
            --text-primary: #333;
            --text-secondary: #666;
            --text-tertiary: #999;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --modal-overlay: rgba(0, 0, 0, 0.5);
            --scrollbar-track: #f9fafb;
            --scrollbar-thumb: #d1d5db;
            --scrollbar-thumb-hover: #9ca3af;
            --health-bar-bg: #e0e0e0;
            --section-bg: white;
            --task-item-bg: white;
            --button-hover-bg: #f0f0f0;
            --congrats-bg: white;
            --achievement-locked-bg: #f5f5f5;
            --achievement-locked-text: #999;
            
            /* Modern additions */
            --accent-primary: #D0FF00;
            --accent-secondary: #B8E600;
            --accent-tertiary: #A0CC00;
            --border-light: #e8eaed;
            --border-medium: #dadce0;
            --border-dark: #c4c7cc;
            --success: #34d399;
            --warning: #fbbf24;
            --error: #f87171;
            --info: #60a5fa;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-full: 9999px;
            --transition-fast: 0.15s ease-out;
            --transition-normal: 0.25s ease-out;
            --transition-slow: 0.35s ease-out;
        }

        [data-theme="dark"] {
            --quick-action-bg: #0f1611;
            /* Dark theme colors (Task Rock dark per screenshot) */
            --bg-primary: #101712;
            --bg-secondary: #101712;
            --bg-tertiary: #101712;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-tertiary: #999999;
            --border-color: #404040;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --modal-overlay: rgba(0, 0, 0, 0.7);
            --accent-primary: #D0FF00;
            --accent-secondary: #B8E600;
            --accent-tertiary: #A0CC00;
            --border-light: #223127;
            --border-medium: #1b271f;
            --border-dark: #132018;
            --scrollbar-track: #2d2d2d;
            --scrollbar-thumb: #555555;
            --scrollbar-thumb-hover: #777777;
            --health-bar-bg: #404040;
            --section-bg: #101712;
            --task-item-bg: #101712;
            --button-hover-bg: #1a241d;
            --congrats-bg: #101712;
            --achievement-locked-bg: #333333;
            --achievement-locked-text: #666666;
            --border-light: #374151;
            --border-medium: #4b5563;
            --border-dark: #6b7280;
            --shadow-sm: 0 1px 2px 0 rgba(255, 255, 255, 0.03);
            --shadow-md: 0 4px 6px -1px rgba(255, 255, 255, 0.06), 0 2px 4px -1px rgba(255, 255, 255, 0.04);
            --shadow-lg: 0 10px 15px -3px rgba(255, 255, 255, 0.06), 0 4px 6px -2px rgba(255, 255, 255, 0.03);
            --shadow-xl: 0 20px 25px -5px rgba(255, 255, 255, 0.06), 0 10px 10px -5px rgba(255, 255, 255, 0.03);
        }

        /* Speech bubble removed - replaced with  system */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Rounded', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 420px;
            margin: 0 auto;
            background: var(--bg-secondary);
            min-height: 100vh;
            position: relative;
            box-shadow: var(--shadow-xl);
        }

        /* Pet Rock Header with Theme Background */
        .pet-rock-header {
            background: var(--bg-secondary);
            padding: 24px 20px;
            text-align: center;
            position: relative;
            border-bottom: 1px solid var(--border-light);
        }

        /* Brand logo styling */
        .app-title {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 0 16px;
        }

        .brand-logo {
            height: 60px;
            width: auto;
            display: block;
            margin: 0 auto;
        }

        .brand-logo.dark {
            display: none;
        }

        @media (min-width: 640px) {
            .brand-logo {
                height: 80px;
            }
        }

        [data-theme="dark"] .brand-logo.light {
            display: none;
        }

        [data-theme="dark"] .brand-logo.dark {
            display: block;
        }

        .creature-container {
            position: relative;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Task Pal Tooltip */
        .task-pal-tooltip {
            position: absolute;
            top: 85%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 30, 30, 0.95);
            color: white;
            font-size: 0.9rem;
            padding: 12px 16px;
            border-radius: 12px;
            text-align: center;
            white-space: normal;
            max-width: 280px;
            pointer-events: auto;
            opacity: 0;
            transition: opacity 0.3s ease;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .task-pal-tooltip.visible {
            display: block;
            opacity: 1;
        }
        
        .mood-options {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 8px;
        }
        
        .mood-options button {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 28px;
            width: 50px;
            height: 50px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mood-options button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }
        
        .mood-options button:active {
            transform: scale(0.95);
        }

        .creature-image {
            width: 200px;
            height: 200px;
            margin: 0 auto 12px;
            display: block;
            border-radius: 20px;
            object-fit: contain;
            background: transparent;
            transition: transform var(--transition-normal);
        }

        .creature-image:hover {
            transform: scale(1.05);
        }

        .name-edit-wrap {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .creature-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            cursor: pointer;
            transition: color 0.2s ease;
            color: var(--text-primary);
            text-align: center;
        }

        .creature-name:hover {
            color: #007AFF;
        }

        .edit-name-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            padding: 0;
            margin: 0;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            opacity: 0.8;
            transition: opacity var(--transition-fast);
        }

        .edit-name-btn:hover {
            opacity: 1;
        }

        .creature-name-input {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            border: none;
            background: transparent;
            text-align: center;
            outline: none;
            border-bottom: 2px solid #007AFF;
            font-family: 'SF Pro Rounded', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            color: var(--text-primary);
        }

        .health-bar-container {
            margin-bottom: 15px;
            width: 100%;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        .health-bar {
            width: 100%;
            height: 20px;
            background: var(--health-bar-bg);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 5px;
            transition: background-color 0.3s ease;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444 0%, #ffaa00 50%, #44ff44 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .health-text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .task-points {
            background: #007AFF;
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 400;
            display: inline-block;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
            display: none !important;
        }

        .loading-brand {
            height: 40px;
            margin-bottom: 20px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-light);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Success Message */
        .success-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: var(--success);
            color: white;
            padding: 12px 20px;
            border-radius: 8px;
            font-weight: 500;
            z-index: 1000;
            box-shadow: var(--shadow-lg);
            white-space: pre-line;
            text-align: center;
            max-width: calc(100vw - 40px);
            word-wrap: break-word;
        }

        /* Task Rock: Budget-look reskin (scoped) */
        #plannerSection {
            margin-top: 12px;
            padding-bottom: 100px; /* Space for FAB */
        }

        /* Expandable Stats Section */
        #plannerSection .stats-section {
            margin: 0 16px 16px;
            background: var(--section-bg);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        #plannerSection .stats-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid var(--border-light);
        }

        #plannerSection .stats-header:hover {
            background: var(--button-hover-bg);
        }

        #plannerSection .stats-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        #plannerSection .stats-toggle {
            font-size: 14px;
            color: var(--text-secondary);
            transition: transform 0.2s ease;
        }

        #plannerSection .stats-toggle.expanded {
            transform: rotate(180deg);
        }

        /* Daily Challenge Expandable Section */
        #plannerSection .daily-challenge-section {
            margin: 0 16px 16px;
            background: var(--section-bg);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        #plannerSection .daily-challenge-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid var(--border-light);
        }

        #plannerSection .daily-challenge-header:hover {
            background: var(--button-hover-bg);
        }

        #plannerSection .daily-challenge-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        #plannerSection .daily-challenge-toggle {
            font-size: 14px;
            color: var(--text-secondary);
            transition: transform 0.2s ease;
        }

        #plannerSection .daily-challenge-toggle.expanded {
            transform: rotate(180deg);
        }

        #plannerSection .daily-challenge-content {
            padding: 16px 20px;
        }

        /* Daily Challenge Card Styling */
        .daily-challenge-card {
            background: var(--daily-card-purple);
            border-radius: 16px;
            padding: 20px;
            color: white;
            text-align: center;
        }

        .challenge-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .challenge-desc {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 16px;
        }

        .challenge-progress-container {
            margin-bottom: 12px;
        }

        .challenge-progress-label {
            font-size: 12px;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .challenge-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .challenge-progress-fill {
            height: 100%;
            background: var(--accent-tertiary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .challenge-reward {
            font-size: 12px;
            opacity: 0.8;
        }

        .challenge-completed {
            background: var(--daily-card-green) !important;
        }

        /* Collapsed stats: 3 cards in a row */
        #plannerSection .stats-row {
            display: grid;
            gap: 8px;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            padding: 12px 16px;
        }

        @media (max-width: 900px) {
            #plannerSection .stats-row {
                grid-template-columns: repeat(3, minmax(0, 1fr));
                gap: 6px;
            }
        }

        @media (max-width: 320px) {
            #plannerSection .stats-row {
                grid-template-columns: repeat(3, minmax(0, 1fr));
                gap: 4px;
                padding: 8px 12px;
            }
        }

        /* Expanded stats: Grid layout like the screenshot */
        #plannerSection .stats-grid {
            display: grid;
            gap: 12px;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            padding: 16px;
        }

        @media (max-width: 900px) {
            #plannerSection .stats-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr)); /* Maintain 3 columns */
                gap: 8px;
                padding: 12px;
            }
        }

        @media (max-width: 520px) {
            #plannerSection .stats-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr)); /* Maintain 3 columns */
                gap: 6px;
                padding: 10px;
            }
        }

        @media (max-width: 400px) {
            #plannerSection .stats-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr)); /* Maintain 3 columns */
                gap: 4px;
                padding: 8px;
            }
            #plannerSection .stat-tile {
                padding: 6px 3px; /* Reduced padding for stat tiles */
                border-radius: 8px;
                gap: 1px;
            }
            #plannerSection .stat-icon {
                font-size: 9px; /* Reduced icon size */
            }
            #plannerSection .stat-value {
                font-size: 9px; /* Reduced value font size */
            }
            #plannerSection .stat-label {
                font-size: 5px; /* Reduced label font size */
                min-height: 9px;
            }
        }

        #plannerSection .stat-tile {
            background: var(--bg-secondary);
            border: none; /* Remove border in light mode */
            border-radius: 12px;
            padding: 16px 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 4px rgba(0, 0, 0, 0.04);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            aspect-ratio: 1;
            justify-content: center;
            min-height: 0;
            overflow: hidden;
        }

        @media (max-width: 400px) {
            #plannerSection .stat-tile {
                padding: 10px 6px; /* Reduced padding */
                border-radius: 10px;
                gap: 2px;
            }
            #plannerSection .stat-icon {
                font-size: 12px; /* Reduced icon size */
            }
            #plannerSection .stat-value {
                font-size: 11px; /* Reduced value font size */
            }
            #plannerSection .stat-label {
                font-size: 7px; /* Reduced label font size */
                min-height: 12px;
            }
        }

        @media (max-width: 320px) {
            #plannerSection .stat-tile {
                padding: 6px 3px; /* Further reduced padding */
                border-radius: 8px;
                gap: 1px;
            }
            #plannerSection .stat-icon {
                font-size: 9px; /* Further reduced icon size */
            }
            #plannerSection .stat-value {
                font-size: 9px; /* Further reduced value font size */
            }
            #plannerSection .stat-label {
                font-size: 5px; /* Further reduced label font size */
                min-height: 9px;
            }
        }

        /* Dark mode enhanced borders */
        [data-theme="dark"] #plannerSection .stat-tile {
            border: 1px solid rgba(255, 255, 255, 0.1); /* Keep border in dark mode */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3), 0 1px 4px rgba(0, 0, 0, 0.2);
        }

        /* Low completion rate warning */
        #plannerSection .stat-tile.low-completion {
            border-color: #ff4444;
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.3), 0 2px 8px rgba(0, 0, 0, 0.08);
            animation: pulse-red 2s infinite;
        }

        [data-theme="dark"] #plannerSection .stat-tile.low-completion {
            border-color: #ff6666;
            box-shadow: 0 0 25px rgba(255, 102, 102, 0.4), 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        @keyframes pulse-red {
            0%, 100% {
                box-shadow: 0 0 20px rgba(255, 68, 68, 0.3), 0 2px 8px rgba(0, 0, 0, 0.08);
            }
            50% {
                box-shadow: 0 0 30px rgba(255, 68, 68, 0.5), 0 2px 8px rgba(0, 0, 0, 0.08);
            }
        }

        [data-theme="dark"] @keyframes pulse-red {
            0%, 100% {
                box-shadow: 0 0 25px rgba(255, 102, 102, 0.4), 0 2px 8px rgba(0, 0, 0, 0.3);
            }
            50% {
                box-shadow: 0 0 35px rgba(255, 102, 102, 0.6), 0 2px 8px rgba(0, 0, 0, 0.3);
            }
        }

        #plannerSection .stat-tile:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12), 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        #plannerSection .stat-icon {
            font-size: 16px;
            margin-bottom: 0;
            flex-shrink: 0;
        }

        #plannerSection .stat-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0;
            line-height: 1.1;
        }

        #plannerSection .stat-label {
            font-size: 9px;
            color: var(--text-secondary);
            font-weight: 500;
            text-align: center;
            line-height: 1.1;
            padding: 0 1px;
            white-space: normal;
            word-break: keep-all;
            overflow-wrap: break-word;
            hyphens: none;
            max-width: 100%;
            min-height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 400px) {
            #plannerSection .stat-icon {
                font-size: 14px;
            }
            
            #plannerSection .stat-value {
                font-size: 12px;
            }
            
            #plannerSection .stat-label {
                font-size: 8px;
                min-height: 14px;
            }
        }

        @media (max-width: 320px) {
            #plannerSection .stat-icon {
                font-size: 12px;
            }
            
            #plannerSection .stat-value {
                font-size: 11px;
            }
            
            #plannerSection .stat-label {
                font-size: 7px;
                min-height: 12px;
                padding: 0;
            }
        }

        /* Improved Pill Tab Navigation CSS */
        /* Pill tab bar - Enhanced container */
        #plannerSection .pill-tabs {
            display: flex;
            gap: 6px;
            margin: 0 16px 16px;
            padding: 6px;
            border-radius: 20px;
            background: var(--section-bg);
            box-shadow: var(--shadow-sm);
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        /* Individual pill tab buttons - Improved spacing and alignment */
        #plannerSection .pill-tab {
            padding: 12px 10px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 14px;
            border: 0;
            background: transparent;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            flex: 0 1 auto;
            text-align: center;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 0;
            line-height: 1.2;
            position: relative;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: fit-content;
        }

        /* Selected tab state - Enhanced visual prominence */
        #plannerSection .pill-tab[aria-selected="true"] {
            background: var(--accent-primary);
            color: #000000;
            font-weight: 700;
            padding: 12px 12px;
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(208, 255, 0, 0.3);
        }

        /* Hover state for unselected tabs */
        #plannerSection .pill-tab:hover:not([aria-selected="true"]) {
            background: var(--button-hover-bg);
            color: var(--text-primary);
        }

        /* Generic card shell */
        #plannerSection .card {
            background: var(--section-bg);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            padding: 20px;
            margin: 0 16px 16px;
            box-shadow: var(--shadow-sm);
        }

        #plannerSection .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        #plannerSection .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Tab content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Centered FAB (create task) */
        #plannerSection .fab-center {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
            z-index: 500;
            background: var(--accent-primary);
            color: #000000;
            border: none;
            font-size: 24px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #plannerSection .fab-center:hover {
            transform: translateX(-50%) scale(1.1);
        }

        /* Task Cards */
        .task-card {
            background: var(--task-item-bg);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: all var(--transition-fast);
            position: relative;
            overflow: hidden;
        }

        .task-card:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .task-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
            position: relative;
        }

        .task-emoji {
            font-size: 20px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            flex-shrink: 0;
        }

        .task-content {
            flex: 1;
            min-width: 0;
        }

        .task-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .task-meta {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .task-due-date {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            background: #E3F2FD;
            color: #007AFF;
            padding: 3px 6px;
            border-radius: 6px;
            font-size: 10px;
            font-weight: 500;
            white-space: nowrap;
        }

        .task-due-date.warning {
            background: transparent;
            color: #FF3B30;
            border: none;
        }

        .task-badge {
            padding: 2px 8px;
            border-radius: 12px;
            font-size: 10px;
            font-weight: 500;
            white-space: nowrap;
        }

        .task-badge.priority-high {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .task-badge.priority-medium {
            background: rgba(251, 191, 36, 0.1);
            color: #D97706;
        }

        .task-badge.priority-low {
            background: rgba(52, 211, 153, 0.1);
            color: var(--success);
        }

        .task-badge.difficulty-hard {
            background: rgba(239, 68, 68, 0.1);
            color: var(--error);
        }

        .task-badge.difficulty-medium {
            background: rgba(251, 191, 36, 0.1);
            color: #D97706;
        }

        .task-badge.difficulty-easy {
            background: rgba(52, 211, 153, 0.1);
            color: var(--success);
        }

        .task-actions {
            display: flex;
            gap: 8px;
            margin-top: 12px;
        }

        .btn-primary {
            background: var(--accent-primary);
            color: #000000;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background: var(--accent-secondary);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-secondary:hover {
            background: var(--button-hover-bg);
            transform: translateY(-1px);
        }

        /* Quick Tasks */
        .quick-task-item {
            background: var(--task-item-bg);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .quick-task-item:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .quick-task-emoji {
            font-size: 20px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            flex-shrink: 0;
        }

        .quick-task-content {
            flex: 1;
            min-width: 0;
        }

        .quick-task-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .quick-task-category {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .quick-task-points {
            font-size: 10px;
            font-weight: 600;
            color: white;
            background: #007AFF;
            padding: 3px 6px;
            border-radius: 6px;
            margin-right: 8px;
            white-space: nowrap;
        }

        .quick-task-actions {
            display: flex;
            gap: 4px;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
        }

        .action-complete {
            background: var(--success);
            color: white;
        }

        .action-complete:hover {
            background: #059669;
        }

        .action-remove {
            background: var(--error);
            color: white;
        }

        .action-remove:hover {
            background: #dc2626;
        }

        /* Daily Challenge */
        .daily-challenge-card {
            background: var(--daily-card-purple);
            border-radius: 16px;
            padding: 20px;
            color: white;
            text-align: center;
        }

        .challenge-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .challenge-desc {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 16px;
        }

        .challenge-progress-container {
            margin-bottom: 12px;
        }

        .challenge-progress-label {
            font-size: 12px;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .challenge-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .challenge-progress-fill {
            height: 100%;
            background: var(--accent-tertiary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .challenge-reward {
            font-size: 12px;
            opacity: 0.8;
        }

        .challenge-completed {
            background: var(--daily-card-green) !important;
        }

        /* Achievements */
        .achievement-card {
            background: var(--task-item-bg);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .achievement-card.unlocked {
            border-color: var(--success);
            background: rgba(52, 211, 153, 0.05);
        }

        .achievement-card.locked {
            opacity: 0.6;
        }

        .achievement-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            flex-shrink: 0;
        }

        .achievement-content {
            flex: 1;
            min-width: 0;
        }

        .achievement-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .achievement-desc {
            font-size: 12px;
            color: var(--text-secondary);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .achievement-status {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 8px;
        }

        .achievement-status.unlocked {
            background: var(--success);
            color: white;
        }

        .achievement-status.locked {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        /* Shop Items */
        .shop-grid {
            display: flex;
            overflow-x: auto;
            gap: 16px;
            margin-top: 16px;
            margin-bottom: 24px;
            padding-bottom: 8px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .shop-grid::-webkit-scrollbar {
            height: 6px;
        }

        .shop-grid::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 3px;
        }

        .shop-grid::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 3px;
        }

        .shop-grid::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }

        .shop-item {
            background: var(--task-item-bg);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            min-height: 140px;
            min-width: 120px;
            flex-shrink: 0;
        }

        .shop-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .shop-item.equipped {
            border: 2px solid #A5F247;
            box-shadow: 0 0 0 2px rgba(165, 242, 71, 0.35), 0 6px 18px rgba(165, 242, 71, 0.20);
        }

        .shop-item.owned {
            /* No special border for owned but unequipped items */
        }

        .shop-item.expensive {
            opacity: 0.6;
        }

        .shop-item-emoji {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .shop-item-image {
            max-width: 60px;
            height: auto;
            margin-bottom: 8px;
        }

        .shop-item-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .shop-item-price {
            font-size: 12px;
            color: var(--text-secondary);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Settings */
        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .settings-toggle {
            width: 50px;
            height: 28px;
            background: var(--bg-tertiary);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .settings-toggle.active {
            background: var(--accent-primary);
        }

        .settings-toggle-slider {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .settings-toggle.active .settings-toggle-slider {
            transform: translateX(22px);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 24px 0;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--button-hover-bg);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 0 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 16px 24px 24px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-light);
            position: sticky;
            bottom: 0;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s ease;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--accent-tertiary);
            box-shadow: 0 0 0 3px rgba(160, 204, 0, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Dark mode datetime-local calendar icon fix */
        [data-theme="dark"] input[type="datetime-local"]::-webkit-calendar-picker-indicator,
        [data-theme="dark"] .form-input[type="datetime-local"]::-webkit-calendar-picker-indicator,
        [data-theme="dark"] #taskDueDate::-webkit-calendar-picker-indicator {
            filter: invert(1) !important;
            cursor: pointer;
            opacity: 1 !important;
        }

        /* Light mode - ensure icon is black */
        [data-theme="light"] input[type="datetime-local"]::-webkit-calendar-picker-indicator,
        [data-theme="light"] .form-input[type="datetime-local"]::-webkit-calendar-picker-indicator,
        [data-theme="light"] #taskDueDate::-webkit-calendar-picker-indicator,
        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            filter: none !important;
            cursor: pointer;
            opacity: 1 !important;
        }

        /* For Firefox */
        [data-theme="dark"] input[type="datetime-local"],
        [data-theme="dark"] .form-input[type="datetime-local"],
        [data-theme="dark"] #taskDueDate {
            color-scheme: dark;
        }

        [data-theme="light"] input[type="datetime-local"],
        [data-theme="light"] .form-input[type="datetime-local"],
        [data-theme="light"] #taskDueDate {
            color-scheme: light;
        }

        .selection-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        @media (max-width: 420px) {
            .selection-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .selection-item {
            background: var(--bg-secondary);
            border: 2px solid var(--border-light);
            border-radius: 12px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .selection-item:hover {
            border-color: var(--accent-tertiary);
            background: rgba(160, 204, 0, 0.05);
        }

        .selection-item.selected {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
            color: #000000;
            font-weight: 600;
        }

        .selection-item-emoji {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .selection-item-text {
            font-size: 12px;
            font-weight: 500;
            word-wrap: break-word;
            overflow-wrap: break-word;
            text-align: center;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state-text {
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-state-subtext {
            font-size: 14px;
            opacity: 0.8;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .app-container {
                max-width: 100%;
            }

            #plannerSection .card {
                margin: 0 12px 12px;
                padding: 16px;
            }

            #plannerSection .stats-row {
                margin: 0 12px 12px;
            }

            #plannerSection .pill-tabs {
                margin: 0 12px 12px;
                padding: 5px;
                gap: 4px;
            }
            
            #plannerSection .pill-tab {
                padding: 10px 8px;
                font-size: 13px;
            }
            
            #plannerSection .pill-tab[aria-selected="true"] {
                padding: 12px 10px;
            }

            .task-title,
            .quick-task-title,
            .achievement-name {
                font-size: 15px;
            }

            .shop-grid {
                gap: 12px;
            }
        }

        /* Ensure text never overflows containers */
        .task-title,
        .quick-task-title,
        .achievement-name,
        .shop-item-name,
        .challenge-title,
        .challenge-desc {
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            max-width: 100%;
        }

        /* Prevent horizontal scroll */
        body,
        html {
            overflow-x: hidden;
        }

        .app-container {
            overflow-x: hidden;
        }

    @keyframes hero-idle-anim {
      from { object-position: 0 0; }
      to { object-position: -128px 0; }
    }
    
    @keyframes hero-hurt-anim {
      from { object-position: 0 0; }
      to { object-position: -128px 0; }
    }
    
    @keyframes hero-jump-anim {
      from { object-position: 0 0; }
      to { object-position: -256px 0; }
    }
    
    </style>

</head>
<body>
<!-- Confetti Canvas -->
<canvas id="confetti-canvas" style="position: fixed; inset: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 9999;"></canvas>

<!-- Loading Screen -->
<div class="loading-screen" id="loadingScreen">
    <img alt="Daily Quest" class="loading-brand" src="assets/logo/loading-logo.png"/>
    <div class="loading-spinner"></div>
    <div class="loading-text">Loading Daily Quest...</div>
</div>

<div class="app-container">
    <!-- Pet Rock Header -->
    <div class="pet-rock-header" style="position: relative; background-image: url('assets/backgrounds/default-bg.png'); background-size: cover; background-position: center; padding: 40px 20px 30px 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.3);">

        <div class="creature-container" style="position: relative; z-index: 10; display: flex; flex-direction: column; align-items: center; gap: 8px; margin-top: 40px;">
            <div style="width: 140px; height: 140px; margin: 50px auto 0; overflow: visible; position: relative; display: flex; align-items: center; justify-content: center;">
                <!-- Task Pal Tooltip -->
                <div id="taskPalTooltip" class="task-pal-tooltip"></div>
                <img alt="Hero" id="heroSprite" src="assets/heroes/hero-idle.png" style="width: 32px; height: 32px; image-rendering: pixelated; object-fit: none; object-position: 0 0; transform: scale(4); transform-origin: center center; animation: hero-idle-anim 0.8s steps(4) infinite;"/>
            </div>
            
            <!-- RPG Stat Gauges -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 16px auto 0; max-width: 500px; padding: 0 10px;">
                <!-- Energy Gauge -->
                <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 12px; padding: 16px 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2);">
                    <div style="font-size: 28px; text-align: center; margin-bottom: 8px;"></div>
                    <div style="font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.7); text-align: center; margin-bottom: 8px; letter-spacing: 0.5px;">ENERGY</div>
                    <div style="width: 100%; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                        <div id="energyFill" style="height: 100%; background: linear-gradient(90deg, #10b981 0%, #3b82f6 100%); width: 75%; transition: width 0.3s ease-in-out;"></div>
                    </div>
                    <div id="energyText" style="font-size: 14px; font-weight: 700; color: #fff; text-align: center;">75/100</div>
                </div>
                
                <!-- Attack Gauge -->
                <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 12px; padding: 16px 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2);">
                    <div style="font-size: 28px; text-align: center; margin-bottom: 8px;"></div>
                    <div style="font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.7); text-align: center; margin-bottom: 8px; letter-spacing: 0.5px;">ATTACK</div>
                    <div style="width: 100%; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                        <div id="attackFill" style="height: 100%; background: linear-gradient(90deg, #ef4444 0%, #f97316 50%, #ec4899 100%); width: 60%; transition: width 0.3s ease-in-out;"></div>
                    </div>
                    <div id="attackText" style="font-size: 14px; font-weight: 700; color: #fff; text-align: center;">60/100</div>
                </div>
                
                <!-- Defense Gauge -->
                <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 12px; padding: 16px 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2);">
                    <div style="font-size: 28px; text-align: center; margin-bottom: 8px;"></div>
                    <div style="font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.7); text-align: center; margin-bottom: 8px; letter-spacing: 0.5px;">DEFENSE</div>
                    <div style="width: 100%; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                        <div id="defenseFill" style="height: 100%; background: linear-gradient(90deg, #8b5cf6 0%, #3b82f6 100%); width: 85%; transition: width 0.3s ease-in-out;"></div>
                    </div>
                    <div id="defenseText" style="font-size: 14px; font-weight: 700; color: #fff; text-align: center;">85/100</div>
                </div>
            </div>
            
            <!-- XP Bar -->
            <div style="margin: 16px auto 0; max-width: 500px; padding: 0 10px;">
                <div style="padding: 16px; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2);">
                    <!-- Level | Name Header -->
                    <div id="levelLabel" style="text-align: center; font-size: 14px; font-weight: 600; color: rgba(255,255,255,0.9); text-shadow: 1px 1px 2px rgba(0,0,0,0.5); margin-bottom: 8px; letter-spacing: 0.3px;">Level 1 | Hero</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 16px;">
                        <div style="font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.9); white-space: nowrap;">Experience Points</div>
                        <div id="xpText" style="font-size: 13px; font-weight: 700; color: #fff; white-space: nowrap;">0 / 1,000 XP</div>
                    </div>
                    <div style="width: 100%; height: 12px; background: rgba(0,0,0,0.3); border-radius: 6px; overflow: hidden;">
                        <div id="xpFill" style="height: 100%; background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%); width: 0%; transition: width 0.3s ease-in-out;"></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Planner Section with Budget-style design -->
    <section id="plannerSection">
        <!-- Expandable Stats Section -->
        <div class="stats-section">
            <div class="stats-header" onclick="toggleStatsExpansion()">
                <div class="stats-title"> Statistics</div>
                <div class="stats-toggle" id="statsToggle"></div>
            </div>
            
            <!-- Collapsed view: 3 main stats -->
            <div class="stats-row stats-collapsed" id="statsCollapsed">
                <div class="stat-tile">
                    <div class="stat-icon"></div>
                    <div class="stat-value" id="quickTasksDisplay">0</div>
                    <div class="stat-label">Pending Quick Tasks</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon"></div>
                    <div class="stat-value" id="pendingTasksDisplay">0</div>
                    <div class="stat-label">Pending Tasks</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon"></div>
                    <div class="stat-value" id="completedTasksDisplay">0</div>
                    <div class="stat-label">Completed Tasks</div>
                </div>
            </div>
            
            <!-- Expanded view: All stats -->
            <div class="stats-grid stats-expanded" id="statsExpanded" style="display: none;">
                <div class="stat-tile">
                    <div class="stat-icon"></div>
                    <div class="stat-value" id="quickTasksDisplayExp">0</div>
                    <div class="stat-label">Pending Quick Tasks</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon"></div>
                    <div class="stat-value" id="pendingTasksDisplayExp">0</div>
                    <div class="stat-label">Pending Tasks</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon"></div>
                    <div class="stat-value" id="completedTasksDisplayExp">0</div>
                    <div class="stat-label">Completed Tasks</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon"></div>
                    <div class="stat-value" id="completedQuickTasksDisplayExp">0</div>
                    <div class="stat-label">Completed Quick Tasks</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon"></div>
                    <div class="stat-value" id="completionRateDisplay">0%</div>
                    <div class="stat-label">Completion Rate</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon"></div>
                    <div class="stat-value" id="totalTasksDisplay">0</div>
                    <div class="stat-label">Total Tasks</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon"></div>
                    <div class="stat-value" id="currentStreakDisplay">0</div>
                    <div class="stat-label">Current Streak</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon"></div>
                    <div class="stat-value" id="bestStreakDisplay">0</div>
                    <div class="stat-label">Best Streak</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon"></div>
                    <div class="stat-value" id="rockLevelDisplay">1</div>
                    <div class="stat-label">Hero Level</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon"></div>
                    <div class="stat-value" id="experienceDisplay">0/100 XP</div>
                    <div class="stat-label">Experience</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon"></div>
                    <div class="stat-value" id="achievementsDisplay">0/10</div>
                    <div class="stat-label">Achievements</div>
                </div>
            </div>
        </div>

        <!-- Pill tab bar -->
        <div class="pill-tabs">
            <button class="pill-tab" aria-selected="true" onclick="switchToTab('home')">Home</button>
            <button class="pill-tab" aria-selected="false" onclick="switchToTab('achievements')">Achievements</button>
            <button class="pill-tab" aria-selected="false" onclick="switchToTab('inventory')">Inventory</button>
            <button class="pill-tab" aria-selected="false" onclick="switchToTab('settings')">Settings</button>
        </div>

        <!-- Home tab content -->
        <div id="homeTab" class="tab-content active">
            

            <!-- Daily Challenge - Expandable Section -->
            <div class="daily-challenge-section">
                <div class="daily-challenge-header" onclick="toggleDailyChallengeExpansion()">
                    <div class="daily-challenge-title"> Daily Challenge</div>
                    <div class="daily-challenge-toggle" id="dailyChallengeToggle"></div>
                </div>
                <div class="daily-challenge-content" id="dailyChallengeContent" style="display: block;">
                    <div id="dailyChallengeDisplay">
                        <!-- Daily challenge will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Your Tasks -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"> Your Tasks</div>
                    <button class="btn-primary" onclick="openCreateTaskModal()">+ Add</button>
                </div>
                <div id="tasksList">
                    <!-- Tasks will be populated here -->
                </div>
            </div>

            <!-- Quick Tasks -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title"> Quick Tasks</div>
                    <button class="btn-primary" onclick="openQuickTaskModal()">+ Add</button>
                </div>
                <div id="quickTasksList">
                    <!-- Quick tasks will be populated here -->
                </div>
            </div>
        </div>

        <!-- Achievements tab content -->
        <div id="achievementsTab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title"> Achievements</div>
                </div>
                <div id="achievementsList">
                    <!-- Achievements will be populated here -->
                </div>
            </div>
        </div>

        <!-- Rock Shop tab content -->
        <div id="inventoryTab" class="tab-content">

            <div class="card">
                <div class="card-header">
                    <div class="card-title"> Inventory</div>
                </div>
                <div id="inventorySection" style="padding: 40px 20px; text-align: center; color: #999;">
                    <p style="font-size: 16px;">Your inventory is empty.</p>
                    <p style="font-size: 14px; margin-top: 12px;">Complete quests to earn items!</p>
                </div>
            </div>

        </div>

        <!-- Settings tab content -->
        <div id="settingsTab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title"> Settings</div>
                </div>

                <div class="settings-item">
                    <div class="settings-label">Notifications</div>
                    <div class="settings-toggle" id="notificationsToggle" onclick="toggleNotifications()">
                        <div class="settings-toggle-slider"></div>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="settings-label">Share Etsy Store</div>
                    <button class="btn-secondary" onclick="shareEtsyStore()">Share</button>
                </div>
                <div class="settings-item">
                    <div class="settings-label"> Change Task Pal's Name</div>
                    <button class="btn-secondary" onclick="openChangeNameModal()">Edit</button>
                </div>

                <div class="settings-item">
                    <div class="settings-label">Reset Progress</div>
                    <button style="background: var(--error); color: white;" class="btn-secondary" onclick="showResetOptions()">Reset</button>
                </div>
            </div>
        </div>

        <!-- Centered FAB -->
        <button class="fab-center" onclick="openCreateTaskModal()">+</button>
    </section>
</div>

<!-- Create Task Modal -->
<div class="modal" id="createTaskModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Create Task</h2>
            <button class="modal-close" onclick="closeModal()"></button>
        </div>
        <div class="modal-body">
            <form id="taskForm">
                <div class="form-group">
                    <label class="form-label">Task Title</label>
                    <input class="form-input" id="taskTitle" placeholder="Enter task title" required type="text"/>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description (Optional)</label>
                    <textarea class="form-textarea" id="taskDescription" placeholder="Enter task description"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <div class="selection-grid">
                        <div class="selection-item" data-category="work" onclick="selectCategory('work')">
                            <div class="selection-item-emoji"></div>
                            <div class="selection-item-text">Work</div>
                        </div>
                        <div class="selection-item" data-category="learning" onclick="selectCategory('learning')">
                            <div class="selection-item-emoji"></div>
                            <div class="selection-item-text">Learning</div>
                        </div>
                        <div class="selection-item" data-category="home" onclick="selectCategory('home')">
                            <div class="selection-item-emoji"></div>
                            <div class="selection-item-text">Home</div>
                        </div>
                        <div class="selection-item" data-category="finance" onclick="selectCategory('finance')">
                            <div class="selection-item-emoji"></div>
                            <div class="selection-item-text">Finance</div>
                        </div>
                        <div class="selection-item" data-category="goals" onclick="selectCategory('goals')">
                            <div class="selection-item-emoji"></div>
                            <div class="selection-item-text">Goals</div>
                        </div>
                        <div class="selection-item" data-category="projects" onclick="selectCategory('projects')">
                            <div class="selection-item-emoji"></div>
                            <div class="selection-item-text">Projects</div>
                        </div>
                        <div class="selection-item" data-category="errands" onclick="selectCategory('errands')">
                            <div class="selection-item-emoji"></div>
                            <div class="selection-item-text">Errands</div>
                        </div>
                        <div class="selection-item" data-category="digital" onclick="selectCategory('digital')">
                            <div class="selection-item-emoji"></div>
                            <div class="selection-item-text">Digital</div>
                        </div>
                        <div class="selection-item" data-category="creative" onclick="selectCategory('creative')">
                            <div class="selection-item-emoji"></div>
                            <div class="selection-item-text">Creative</div>
                        </div>
                        <div class="selection-item" data-category="social" onclick="selectCategory('social')">
                            <div class="selection-item-emoji"></div>
                            <div class="selection-item-text">Social</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Difficulty</label>
                    <div class="selection-grid">
                        <div class="selection-item" data-difficulty="easy" onclick="selectDifficulty('easy')">
                            <div class="selection-item-emoji"></div>
                            <div class="selection-item-text">Easy (2 pts)</div>
                        </div>
                        <div class="selection-item" data-difficulty="medium" onclick="selectDifficulty('medium')">
                            <div class="selection-item-emoji"></div>
                            <div class="selection-item-text">Medium (5 pts)</div>
                        </div>
                        <div class="selection-item" data-difficulty="hard" onclick="selectDifficulty('hard')">
                            <div class="selection-item-emoji"></div>
                            <div class="selection-item-text">Hard (10 pts)</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <div class="selection-grid">
                        <div class="selection-item" data-priority="low" onclick="selectPriority('low')">
                            <div class="selection-item-emoji"></div>
                            <div class="selection-item-text">Low Priority</div>
                        </div>
                        <div class="selection-item" data-priority="medium" onclick="selectPriority('medium')">
                            <div class="selection-item-emoji"></div>
                            <div class="selection-item-text">Medium Priority</div>
                        </div>
                        <div class="selection-item" data-priority="high" onclick="selectPriority('high')">
                            <div class="selection-item-emoji"></div>
                            <div class="selection-item-text">High Priority</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Due Date (Optional)</label>
                    <input class="form-input" id="taskDueDate" type="datetime-local"/>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-primary" style="width: 100%;" onclick="createTask()">Create Task</button>
        </div>
    </div>
</div>

<!-- Quick Task Modal -->
<div class="modal" id="quickTaskModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Add Quick Task</h2>
            <button class="modal-close" onclick="closeQuickTaskModal()"></button>
        </div>
        <div class="modal-body">
            <div id="quickTaskCategories">
                <!-- Quick task categories will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- Change Name Modal -->
<div class="modal" id="changeNameModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Change Task Pal's Name</div>
            <button class="modal-close" onclick="closeChangeNameModal()"></button>
        </div>
        <div class="modal-body">
            <label for="newCreatureName" class="form-label">Enter new name:</label>
            <input id="newCreatureName" type="text" class="form-input" maxlength="20" placeholder="e.g., Jerry 2.0" />
        </div>
        <div class="modal-footer">
            <button class="btn-primary" onclick="saveNewCreatureName()">Save</button>
        </div>
    </div>
</div>

<script>
        // Game state
        let gameState = {
            rockName: 'Jerry',
            health: 100,
            jerryLevel: 1,
            jerryXP: 0,
            jerryXPToNext: 100,
            taskPoints: 0,
            tasks: [],
            completedTasks: 0,
            completedTasksToday: 0,
            totalTasksCreated: 0,
            currentStreak: 0,
            longestStreak: 0,
            bestStreak: 0,
            streakMultiplier: 1,
            lastCompletionDate: null,
            lastDayTracked: null,
            darkMode: false,
            notifications: false,
            selectedQuickTasks: [],
            completedQuickTasks: [],
            lastQuickTasksDate: null,
            dailyChallenge: null,
            dailyChallengeCompleted: false,
            lastDailyChallengeDate: null,
            isDead: false,
            revivalPoints: 0,
            ownedItems: [],
            funFactsUnlocked: false,
            currentOutfit: {
                hat: null,
                glasses: null,
                mustache: null,
                paint: null
            }
        };

        // Task creation variables
        let selectedCategory = null;
        let selectedDifficulty = null;
        let selectedPriority = null;
        let selectedRecurring = 'none';
        let selectedInterval = 1;
        let selectedWeekdays = [];
        let editingTaskIndex = null;

        // Category mapping
        const categoryMap = {
            'work': { name: 'Work & Career', emoji: '' },
            'learning': { name: 'Learning & Education', emoji: '' },
            'home': { name: 'Home & Family', emoji: '' },
            'finance': { name: 'Finance & Planning', emoji: '' },
            'goals': { name: 'Personal Goals', emoji: '' },
            'projects': { name: 'Projects & Hobbies', emoji: '' },
            'errands': { name: 'Errands & Appointments', emoji: '' },
            'digital': { name: 'Digital & Technology', emoji: '' },
            'creative': { name: 'Creative & Arts', emoji: '' },
            'social': { name: 'Social & Relationships', emoji: '' }
        };

        // Quick Tasks Database
        const quickTasksDatabase = {
            'self-care': {
                name: 'Self-Care & Wellness',
                emoji: '',
                tasks: [
                    { id: 'brush_teeth', title: 'Brush teeth', emoji: '', points: 2 },
                    { id: 'wash_face', title: 'Wash my face', emoji: '', points: 2 },
                    { id: 'drink_water', title: 'Drink a glass of water', emoji: '', points: 2 },
                    { id: 'take_vitamins', title: 'Take vitamins', emoji: '', points: 3 },
                    { id: 'skincare', title: 'Do skincare routine', emoji: '', points: 4 },
                    { id: 'shower', title: 'Take a shower', emoji: '', points: 4 },
                    { id: 'moisturize', title: 'Moisturize skin', emoji: '', points: 3 },
                    { id: 'floss', title: 'Floss teeth', emoji: '', points: 3 }
                ]
            },
            'physical': {
                name: 'Physical Activity',
                emoji: '',
                tasks: [
                    { id: 'pushups', title: 'Do 10 push-ups', emoji: '', points: 4 },
                    { id: 'squats', title: 'Do 15 squats', emoji: '', points: 4 },
                    { id: 'plank', title: 'Hold plank for 30 seconds', emoji: '', points: 4 },
                    { id: 'walk', title: 'Take a 10-minute walk', emoji: '', points: 5 },
                    { id: 'stretch', title: 'Stretch for 5 minutes', emoji: '', points: 3 },
                    { id: 'yoga', title: 'Do yoga poses', emoji: '', points: 5 }
                ]
            },
            'sleep': {
                name: 'Sleep & Rest',
                emoji: '',
                tasks: [
                    { id: 'screen_warmth', title: 'Turn on screen warmth', emoji: '', points: 2 },
                    { id: 'no_caffeine', title: 'No caffeine after 2 PM', emoji: '', points: 3 },
                    { id: 'bedtime_routine', title: 'Start bedtime routine', emoji: '', points: 4 },
                    { id: 'read_book', title: 'Read before bed', emoji: '', points: 4 },
                    { id: 'meditation', title: 'Do 5-min meditation', emoji: '', points: 4 }
                ]
            },
            'tidy': {
                name: 'Tidy Up',
                emoji: '',
                tasks: [
                    { id: 'laundry', title: 'Put laundry away', emoji: '', points: 4 },
                    { id: 'trash', title: 'Take out trash', emoji: '', points: 3 },
                    { id: 'dishes', title: 'Wash the dishes', emoji: '', points: 4 },
                    { id: 'make_bed', title: 'Make the bed', emoji: '', points: 3 },
                    { id: 'desk_clean', title: 'Clean desk/workspace', emoji: '', points: 4 }
                ]
            },
            'mindfulness': {
                name: 'Mindfulness & Mental Health',
                emoji: '',
                tasks: [
                    { id: 'deep_breaths', title: 'Take 5 deep breaths', emoji: '', points: 2 },
                    { id: 'gratitude', title: 'Think of 3 things grateful for', emoji: '', points: 3 },
                    { id: 'compliment_self', title: 'Give myself a compliment', emoji: '', points: 3 },
                    { id: 'mindful_moment', title: 'Have a mindful moment', emoji: '', points: 4 }
                ]
            }
        };

        // Shop Items
        const shopItems = {
            hats: [
                { id: 'blue_cap', name: 'Blue Cap', price: 50, emoji: '' },
                { id: 'top_hat', name: 'Black Top Hat', price: 100, emoji: '' },
                { id: 'army_helmet', name: 'Army Helmet', price: 200, emoji: '' },
                { id: 'wizard_hat', name: 'Wizard Hat', price: 400, emoji: '' }
            ],
            items: [
                { id: 'mustache', name: 'Mustache', price: 350, emoji: '' },
                { id: 'glasses', name: 'Glasses', price: 300, emoji: '' }
            ],
            paints: [
                { id: 'buddy_paint', name: 'Buddy Paint', price: 800, emoji: '' },
                { id: 'rock_star', name: 'Rock Star', price: 1000, emoji: '' },
                { id: 'makeup', name: 'Makeup', price: 1100, emoji: '' }
            ]
        };

        // Achievements
        const achievements = [
            { id: 'hot_streak', name: 'Hot Streak', desc: 'Complete tasks for 3 days in a row', icon: '', requirement: 3, type: 'streak' },
            { id: 'week_warrior', name: 'Week Warrior', desc: 'Complete tasks for 7 days in a row', icon: '', requirement: 7, type: 'streak' },
            { id: 'month_master', name: 'Month Master', desc: 'Complete tasks for 30 days in a row', icon: '', requirement: 30, type: 'streak' },
            { id: 'getting_started', name: 'Getting Started', desc: 'Complete 10 tasks', icon: '', requirement: 10, type: 'tasks' },
            { id: 'task_crusher', name: 'Task Crusher', desc: 'Complete 50 tasks', icon: '', requirement: 50, type: 'tasks' },
            { id: 'century_club', name: 'Century Club', desc: 'Complete 100 tasks', icon: '', requirement: 100, type: 'tasks' },
            { id: 'task_legend', name: 'Task Legend', desc: 'Complete 500 tasks', icon: '', requirement: 500, type: 'tasks' },
            { id: 'rising_star', name: 'Rising Star', desc: 'Reach Level 5 with Jerry', icon: '', requirement: 5, type: 'level' },
            { id: 'experienced_rock', name: 'Experienced Rock', desc: 'Reach Level 10 with Jerry', icon: '', requirement: 10, type: 'level' },
            { id: 'ancient_wisdom', name: 'Ancient Wisdom', desc: 'Reach Level 20 with Jerry', icon: '', requirement: 20, type: 'level' }
        ];

        // Load game state from localStorage
        function loadGameState() {
            const saved = localStorage.getItem('taskRockGameState');
            if (saved) {
                const parsedState = JSON.parse(saved);
                gameState = { ...gameState, ...parsedState };
                
                // Ensure selectedQuickTasks exists
                if (!gameState.selectedQuickTasks) {
                    gameState.selectedQuickTasks = [];
                }
                
                // Ensure completedQuickTasks exists
                if (!gameState.completedQuickTasks) {
                    gameState.completedQuickTasks = [];
                }
                
                // Migration: Initialize totalTasksCreated for existing users
                if (typeof gameState.totalTasksCreated === 'undefined') {
                    gameState.totalTasksCreated = gameState.completedTasks + gameState.tasks.length;
                }
                
                // Ensure totalTasksCreated is never less than completedTasks
                if (gameState.totalTasksCreated < gameState.completedTasks) {
                    gameState.totalTasksCreated = gameState.completedTasks;
                }
            }
        }

        // Save game state to localStorage
        function saveGameState() {
            localStorage.setItem('taskRockGameState', JSON.stringify(gameState));
        }

        // Update UI elements
        function updateUI() {
            // Update header info (unified level | name)
            const levelLabel = document.getElementById('levelLabel');
            if (levelLabel) {
                levelLabel.textContent = `Level ${gameState.jerryLevel || 1} | ${gameState.rockName}`;
            }
            
            // Update RPG Gauges
            const health = gameState.health || 75;
            const completedTasks = gameState.completedTasks || 0;
            const currentStreak = gameState.currentStreak || 0;
            const level = gameState.jerryLevel || 1;
            const currentXP = gameState.jerryXP || 0;
            const xpToNext = 1000 * level;
            
            // Energy (Health)
            document.getElementById('energyFill').style.width = `${health}%`;
            document.getElementById('energyText').textContent = `${health}/100`;
            
            // Attack (based on completed tasks)
            const attack = Math.min(100, 50 + (completedTasks * 2));
            document.getElementById('attackFill').style.width = `${attack}%`;
            document.getElementById('attackText').textContent = `${attack}/100`;
            
            // Defense (based on streak)
            const defense = Math.min(100, 75 + (currentStreak * 5));
            document.getElementById('defenseFill').style.width = `${defense}%`;
            document.getElementById('defenseText').textContent = `${defense}/100`;
            
            // Level text (now handled in unified levelLabel above)
            
            // XP Bar
            const xpPercentage = Math.min(100, (currentXP / xpToNext) * 100);
            document.getElementById('xpFill').style.width = `${xpPercentage}%`;
            document.getElementById('xpText').textContent = `${currentXP.toLocaleString()} / ${xpToNext.toLocaleString()} XP`;
            
            // Calculate comprehensive stats
            const activeTasks = gameState.tasks.filter(task => !task.completed);
            const pendingTasks = activeTasks.length;
            const quickTasks = (gameState.selectedQuickTasks || []).length;
            const completedQuickTasks = (gameState.completedQuickTasks || []).length;
            const totalTasks = gameState.totalTasksCreated || 0;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            const bestStreak = gameState.bestStreak || gameState.longestStreak || 0;
            const rockLevel = level;
            const nextLevelXP = xpToNext;
            
            // Count unlocked achievements
            let unlockedAchievements = 0;
            achievements.forEach(achievement => {
                let isUnlocked = false;
                switch (achievement.type) {
                    case 'streak':
                        isUnlocked = bestStreak >= achievement.requirement;
                        break;
                    case 'tasks':
                        isUnlocked = completedTasks >= achievement.requirement;
                        break;
                    case 'level':
                        isUnlocked = rockLevel >= achievement.requirement;
                        break;
                }
                if (isUnlocked) unlockedAchievements++;
            });
            
            // Update collapsed stats
            const quickTasksEl = document.getElementById('quickTasksDisplay');
            const pendingTasksEl = document.getElementById('pendingTasksDisplay');
            const completedTasksEl = document.getElementById('completedTasksDisplay');
            
            if (quickTasksEl) quickTasksEl.textContent = quickTasks;
            if (pendingTasksEl) pendingTasksEl.textContent = pendingTasks;
            if (completedTasksEl) completedTasksEl.textContent = completedTasks;
            
            // Update expanded stats
            const quickTasksExpEl = document.getElementById('quickTasksDisplayExp');
            const completedQuickTasksExpEl = document.getElementById('completedQuickTasksDisplayExp');
            const pendingTasksExpEl = document.getElementById('pendingTasksDisplayExp');
            const completedTasksExpEl = document.getElementById('completedTasksDisplayExp');
            const completionRateEl = document.getElementById('completionRateDisplay');
            const totalTasksEl = document.getElementById('totalTasksDisplay');
            const currentStreakEl = document.getElementById('currentStreakDisplay');
            const bestStreakEl = document.getElementById('bestStreakDisplay');
            const rockLevelEl = document.getElementById('rockLevelDisplay');
            const experienceEl = document.getElementById('experienceDisplay');
            const achievementsEl = document.getElementById('achievementsDisplay');
            
            if (quickTasksExpEl) quickTasksExpEl.textContent = quickTasks;
            if (completedQuickTasksExpEl) completedQuickTasksExpEl.textContent = completedQuickTasks;
            if (pendingTasksExpEl) pendingTasksExpEl.textContent = pendingTasks;
            if (completedTasksExpEl) completedTasksExpEl.textContent = completedTasks;
            if (completionRateEl) {
                completionRateEl.textContent = `${completionRate}%`;
                // Add low completion warning if rate is below 50% and user has created tasks
                const completionTile = completionRateEl.closest('.stat-tile');
                if (completionTile) {
                    if (completionRate < 50 && totalTasks > 0) {
                        completionTile.classList.add('low-completion');
                    } else {
                        completionTile.classList.remove('low-completion');
                    }
                }
            }
            if (totalTasksEl) totalTasksEl.textContent = totalTasks;
            if (currentStreakEl) currentStreakEl.textContent = currentStreak;
            if (bestStreakEl) bestStreakEl.textContent = bestStreak;
            if (rockLevelEl) rockLevelEl.textContent = rockLevel;
            if (experienceEl) experienceEl.textContent = `${currentXP}/${nextLevelXP} XP`;
            if (achievementsEl) achievementsEl.textContent = `${unlockedAchievements}/${achievements.length}`;
            
            // Update creature image based on equipped items
            updateCreatureImage();
            
            // Update daily challenge display
            updateDailyChallengeDisplay();
            
            // Update shop display to refresh equipped status
            updateShopDisplay();
            
            // Update Task Pal tooltip
            updateTooltip(health, gameState.tasks || []);
        }

        // ===============================
        //  CATEGORY-AWARE TOOLTIP SYSTEM
        // ===============================
        let userName = localStorage.getItem('userName') || "";

        // Phrase libraries by category
        const categoryPhrases = {
            work: [
                "Let's get that productivity flowing ",
                "Another win for the team, {name}!",
                "You're bossing this project ",
                "Emails, meetings, and progresslet's go!",
                "A focused mind is your best tool ",
                "Work vibes are strong today ",
                "You're making moves, {name}!",
                "Great things come from small, consistent effort.",
                "Keep that workflow rolling!",
                "Time to show your skills, {name}!"
            ],
            learning: [
                "Knowledge boost incoming ",
                "Brains loading... complete! ",
                "Smart move, {name}  every study counts.",
                "Curiosity looks good on you ",
                "Each page turns you into a powerhouse ",
                "Let's learn something amazing today!",
                "You're leveling up your brain XP ",
                "Stay curious, stay sharp ",
                "Knowledge is your weapon today!",
                "Your focus is unmatched, {name}!"
            ],
            home: [
                "Home base needs your magic ",
                "Clean space, clear mind ",
                "Small chores, big peace ",
                "That's how a champion does it, {name}!",
                "Order brings calm ",
                "Your environment is leveling up ",
                "Tidying today = peaceful tomorrow.",
                "You're turning home into a haven ",
                "Every task brings comfort closer.",
                "Smells like progress, {name}!"
            ],
            finance: [
                "Let's secure that bag ",
                "Smart money move, {name}! ",
                "Every dollar has a mission.",
                "Budgeting = self-care ",
                "You're building future freedom!",
                "The spreadsheet gods salute you ",
                "That's wealth-builder energy ",
                "Financial XP gained!",
                "Money discipline unlocks power ",
                "Keep stacking smart wins, {name}!"
            ],
            goals: [
                "Goal mode: activated ",
                "Another step toward greatness, {name}!",
                "Dreams  Action  Progress ",
                "Focus on the horizon ",
                "Every tap brings you closer.",
                "Small goals stack into big wins ",
                "You're unstoppable when you plan ",
                "Keep aiming true, {name}!",
                "Success is compounding ",
                "Future you is proud already."
            ],
            projects: [
                "Blueprints of success loading ",
                "You're building something amazing, {name}!",
                "Creativity meets focus ",
                "Every block builds the bigger picture ",
                "Let's make progress visible today.",
                "Innovation XP earned ",
                "Keep crafting your vision!",
                "Project momentum: 100% ",
                "The details matter  and you're nailing them.",
                "You're a maker of great things, {name}!"
            ],
            generic: [
                "Keep going, {name}! ",
                "Every task fuels your growth!",
                "You're doing great work!",
                "Another win on your quest! ",
                "Stay focused and keep pushing!",
                "You're leveling up with every action ",
                "The quest continues!",
                "You're crushing it, hero! ",
                "Your consistency is your strength.",
                "Let's make today count!"
            ]
        };

        // Helper functions
        function getCategoryPhrases(category) {
            return categoryPhrases[category] || categoryPhrases.generic;
        }

        function getRandomPhrase(category) {
            const phrases = getCategoryPhrases(category);
            const phrase = phrases[Math.floor(Math.random() * phrases.length)];
            return userName ? phrase.replace("{name}", userName) : phrase.replace("{name}", "");
        }

        function showCategoryTooltip(category) {
            const tooltip = document.getElementById('taskPalTooltip');
            const message = getRandomPhrase(category);
            tooltip.textContent = message.trim();
            tooltip.classList.add('visible');
            setTimeout(() => tooltip.classList.remove('visible'), 20000);
        }

        function onTaskAdded(category) {
            showCategoryTooltip(category);
        }

        function onTaskCompleted(category) {
            showCategoryTooltip(category);
        }

        function saveUserName(value) {
            localStorage.setItem('userName', value.trim());
            userName = value.trim();
        }

        // Fallback: show a generic tooltip every few minutes
        setInterval(() => showCategoryTooltip('generic'), 180000);

        // ===============================
        //  UPGRADED MOOD TRACKER SYSTEM
        // ===============================
        const moodPhrases = {
            happy: [
                "So happy you're feeling good! ",
                "You're shining today!",
                "Keep that energy up!",
                "Awesome mood! ",
                "That smile suits you ",
                "Radiating positive vibes! ",
                "Your energy is contagious! ",
                "Love seeing you happy! ",
                "You're on fire today! ",
                "Keep spreading that joy! "
            ],
            sad: [
                "Sorry you're feeling down ",
                "Let's take it one step at a time ",
                "You're not alone ",
                "Sending you good energy ",
                "It's okay to rest ",
                "Tomorrow is a new day ",
                "You've got this, even if it doesn't feel like it ",
                "Be gentle with yourself ",
                "This feeling will pass ",
                "I'm here for you "
            ],
            mad: [
                "Oh no! I didn't mean to upset you ",
                "Let's cool off a bit ",
                "Deep breath  we've got this ",
                "It'll pass, promise ",
                "You're stronger than you think ",
                "Take a moment for yourself ",
                "Let's channel that energy productively ",
                "It's okay to feel frustrated ",
                "You're allowed to be upset ",
                "Let's work through this together "
            ]
        };

        let phraseHistory = { happy: [], sad: [], mad: [] };

        function getRandomPhrase(mood) {
            const phrases = moodPhrases[mood];
            let availablePhrases = phrases.filter(p => !phraseHistory[mood].includes(p));
            
            if (availablePhrases.length === 20000) {
                phraseHistory[mood] = [];
                availablePhrases = phrases;
            }
            
            const selected = availablePhrases[Math.floor(Math.random() * availablePhrases.length)];
            phraseHistory[mood].push(selected);
            
            if (phraseHistory[mood].length > 20000) {
                phraseHistory[mood].shift();
            }
            
            return selected;
        }

        window.showMoodTracker = function() {
            const tooltip = document.getElementById("taskPalTooltip");
            if (!tooltip) return;
            
            tooltip.innerHTML = `
                How are you feeling?  
                <div class="mood-options">
                    <button onclick="selectMood('happy')"></button>
                    <button onclick="selectMood('sad')"></button>
                    <button onclick="selectMood('mad')"></button>
                </div>
            `;
            tooltip.classList.add("visible");
            setTimeout(() => tooltip.classList.remove("visible"), 20000);
        }

        window.selectMood = function(moodKey) {
            const tooltip = document.getElementById("taskPalTooltip");
            const hero = document.getElementById("heroSprite");
            
            localStorage.setItem("userMood", moodKey);
            
            const message = getRandomPhrase(moodKey);
            tooltip.innerText = message;
            
            // Update creature animation
            if (moodKey === "happy") {
                if (hero) {
                    hero.src = "assets/heroes/Pink_Monster_Jump_8.png";
                    hero.style.animation = "hero-jump-anim 0.8s steps(8) infinite";
                    
                    // Return to idle after 5 seconds
                    setTimeout(() => {
                        if (hero) {
                            hero.src = "assets/heroes/hero-idle.png";
                            hero.style.animation = "hero-idle-anim 0.8s steps(4) infinite";
                        }
                    }, 5000);
                }
            } else {
                if (hero) {
                    hero.src = "assets/heroes/hero-hurt.png";
                    hero.style.animation = "hero-hurt-anim 0.8s steps(4) infinite";
                    
                    // Return to idle after 5 seconds
                    setTimeout(() => {
                        if (hero) {
                            hero.src = "assets/heroes/hero-idle.png";
                            hero.style.animation = "hero-idle-anim 0.8s steps(4) infinite";
                        }
                    }, 5000);
                }
                
                // Reduce energy if sad/mad and tasks due within 8 hours
                if (gameState && gameState.tasks) {
                    const now = Date.now();
                    const eightHoursFromNow = now + (8 * 60 * 60 * 1000);
                    const hasPendingTasks = gameState.tasks.some(t => 
                        !t.completed && t.dueDate && 
                        new Date(t.dueDate).getTime() <= eightHoursFromNow
                    );
                    
                    if (hasPendingTasks && gameState.health > 3) {
                        gameState.health = Math.max(0, gameState.health - 3);
                        saveGameState();
                        updateUI();
                    }
                }
            }
            
            // Update mood emoji display
            updateMoodDisplay(moodKey);
            
            setTimeout(() => tooltip.classList.remove("visible"), 20000);
        }

        function updateMoodDisplay(moodKey) {
            const moodEmojis = { happy: "", sad: "", mad: "" };
            const emoji = moodEmojis[moodKey] || "";
            
            let moodDisplay = document.getElementById("moodDisplay");
            if (!moodDisplay) {
                const energyLabel = document.querySelector('.stat-label');
                if (energyLabel && energyLabel.textContent.includes('Energy')) {
                    moodDisplay = document.createElement('span');
                    moodDisplay.id = 'moodDisplay';
                    moodDisplay.style.marginLeft = '8px';
                    energyLabel.appendChild(moodDisplay);
                }
            }
            
            if (moodDisplay) {
                moodDisplay.textContent = emoji;
            }
        }

        // Show mood tracker every 2 hours
        setInterval(showMoodTracker, 2 * 60 * 60 * 1000);
        
        // Preload jump sprite to prevent lag
        const jumpSpritePreload = new Image();
        jumpSpritePreload.src = "assets/heroes/Pink_Monster_Jump_8.png";
        
        // On page load, restore saved mood and show tracker
        window.addEventListener("load", () => {
            const savedMood = localStorage.getItem("userMood");
            const hero = document.getElementById("heroSprite");
            
            // Always start with idle animation on page load
            if (hero) {
                hero.src = "assets/heroes/hero-idle.png";
                hero.style.animation = "hero-idle-anim 0.8s steps(4) infinite";
            }
            
            // Update mood display emoji only
            if (savedMood) {
                updateMoodDisplay(savedMood);
            } else {
                updateMoodDisplay(null);
            }
            
            // Show mood tracker immediately on load
            setTimeout(showMoodTracker, 20000);
        });

        // Update Task Pal Tooltip
        function updateTooltip(energy, tasks) {
            const tooltip = document.getElementById("taskPalTooltip");
            if (!tooltip) return;
            
            const now = Date.now();
            const hasOverdue = tasks.some(t => !t.completed && t.dueDate && new Date(t.dueDate).getTime() < now);
            const dueSoon = tasks.some(t => !t.completed && t.dueDate && new Date(t.dueDate).getTime() - now < 3600000);
            let message = "";

            if (energy === 0) message = " I'm out of energy  complete tasks to revive me.";
            else if (hasOverdue) message = " Tasks are overdue! I'm losing energy fast!";
            else if (dueSoon) message = " You've got tasks due soon  let's handle them!";
            else if (energy <= 25) message = " I need a boost  finish a task to help me recover!";
            else if (energy < 60) message = " I'm doing okay, but a few wins would help!";
            else message = " I'm feeling strong  keep the streak going!";

            tooltip.textContent = message;
            tooltip.classList.add("visible");
            
            // Update hero sprite based on energy level
            const heroSprite = document.getElementById("heroSprite");
            if (heroSprite) {
                if (energy <= 30) {
                    // Low health - show hurt animation
                    heroSprite.src = "assets/heroes/hero-hurt.png";
                    heroSprite.style.animation = "hero-hurt-anim 0.8s steps(4) infinite";
                } else {
                    // Normal health - show idle animation
                    heroSprite.src = "assets/heroes/hero-idle.png";
                    heroSprite.style.animation = "hero-idle-anim 0.8s steps(4) infinite";
                }
            }
            
            // Auto-hide after 4 seconds
            setTimeout(() => tooltip.classList.remove("visible"), 4000);
        }

        // Update creature image based on equipped items
        function updateCreatureImage() {
            const creatureImg = document.getElementById('creatureImage');
            if (!creatureImg) return;
            
            // Determine the image source based on equipped items
            let imageSrc = 'assets/Jerry-Default.png'; // Default image
            
            // Check if any hat is equipped
            if (gameState.currentOutfit && gameState.currentOutfit.hat) {
                const equippedHat = gameState.currentOutfit.hat;
                
                // Map hat IDs to image files
                const hatImageMap = {
                    'black_top_hat': 'assets/Jerry-TopHat.png',
                    'wizard_hat': 'assets/Jerry-WizardHat.png'
                };
                
                if (hatImageMap[equippedHat]) {
                    imageSrc = hatImageMap[equippedHat];
                }
            }
            
            // Check if any paint job is equipped
            if (gameState.currentOutfit && gameState.currentOutfit.paint) {
                const equippedPaint = gameState.currentOutfit.paint;
                
                // Map paint IDs to image files (these would override hat images if both are equipped)
                const paintImageMap = {
                    'golden_paint': 'assets/Jerry-Golden.png',
                    'rainbow_paint': 'assets/Jerry-Rainbow.png'
                };
                
                if (paintImageMap[equippedPaint]) {
                    imageSrc = paintImageMap[equippedPaint];
                }
            }
            
            // Update the image source
            creatureImg.src = imageSrc;
        }

        // Pet Rock Dialogue System
        const DIALOGUE_DATABASE = {
            // General phrases by level ranges
            level1to5: [
                "Hey there, [UserName]! I'm still getting to know you.",
                "Thanks for taking care of me! I'm learning so much.",
                "You're doing great with those tasks!",
                "I love watching you work on your goals.",
                "Keep it up! We make a great team.",
                "Every task completed makes me stronger!",
                "I'm so proud of your progress, [UserName].",
                "You're building such good habits!",
                "I feel myself growing with each task you complete.",
                "Your dedication is inspiring!"
            ],
            level6to10: [
                "We're really getting into a groove, [UserName]!",
                "I can feel myself getting stronger every day.",
                "Your consistency is amazing to watch.",
                "I love how focused you've become!",
                "We're becoming quite the productive duo.",
                "Your task completion rate is impressive!",
                "I'm starting to feel more energetic.",
                "You're really mastering this routine thing.",
                "I can sense your confidence growing too.",
                "Together we're unstoppable!"
            ],
            level11to14: [
                "Look at us go! We're on fire, [UserName]!",
                "I feel so much more alive at this level.",
                "Your productivity skills are next level now.",
                "I'm bursting with energy thanks to you!",
                "We've built such an amazing routine together.",
                "You've become a true task master!",
                "I love how efficiently you tackle challenges now.",
                "Your growth mindset is contagious!",
                "We're proof that consistency pays off.",
                "I'm so energized by your success!"
            ],
            level15plus: [
                "We're legends now, [UserName]! Absolutely legendary!",
                "I feel incredibly powerful at this level!",
                "Your mastery of productivity is inspiring to witness.",
                "We've achieved something truly special together.",
                "I'm radiating with energy and wisdom now!",
                "You've become a productivity guru!",
                "Our bond has reached peak performance levels.",
                "I feel like I could move mountains with you!",
                "We're the ultimate productivity partnership!",
                "Your dedication has transformed us both!"
            ],
            
            // Task completion responses by category
            taskComplete: {
                'Physical Activity': [
                    "Great workout, [UserName]! I can feel the energy boost!",
                    "Physical activity completed! Your body and I both thank you.",
                    "Nice movement session! Keeping active keeps us both strong.",
                    "Exercise done! I love when you take care of your body.",
                    "Physical task crushed! You're building strength inside and out."
                ],
                'Self-Care & Wellness': [
                    "Self-care complete! Taking care of yourself helps me too.",
                    "Wellness task done! You're glowing, [UserName]!",
                    "Great self-care choice! We both feel refreshed now.",
                    "Wellness achieved! Your well-being is my well-being.",
                    "Self-care success! You deserve all this good energy."
                ],
                'Learning & Growth': [
                    "Learning task complete! I love growing smarter with you.",
                    "Knowledge gained! We're both expanding our horizons.",
                    "Education task done! Your curiosity feeds my wisdom.",
                    "Learning achieved! Together we're becoming unstoppable.",
                    "Growth task complete! I feel more enlightened already."
                ],
                'Work & Productivity': [
                    "Work task completed! Your productivity powers are strong.",
                    "Professional task done! You're crushing your career goals.",
                    "Work success! I'm proud of your professional dedication.",
                    "Productivity task complete! We make an efficient team.",
                    "Work task finished! Your focus is truly impressive."
                ],
                'Creative & Hobbies': [
                    "Creative task complete! Your imagination energizes me.",
                    "Hobby time done! I love when you explore your passions.",
                    "Creative success! Your artistic spirit is contagious.",
                    "Hobby task finished! Following your interests makes us both happy.",
                    "Creative task complete! Your creativity is inspiring."
                ],
                'Social & Relationships': [
                    "Social task complete! Connections make life richer.",
                    "Relationship task done! Your social energy is wonderful.",
                    "Social success! Building bonds strengthens us both.",
                    "Connection task complete! I love your caring nature.",
                    "Social task finished! Your relationships are precious."
                ],
                'Household & Organization': [
                    "Household task complete! A tidy space makes a happy rock.",
                    "Organization done! I love when everything has its place.",
                    "Cleaning task finished! A clean environment energizes me.",
                    "Household success! Your organized space feels so peaceful.",
                    "Tidy task complete! Order and cleanliness are beautiful."
                ],
                'default': [
                    "Task complete! Another step toward your goals.",
                    "Well done! Every completed task makes us stronger.",
                    "Success! You're building amazing momentum.",
                    "Task finished! I'm proud of your dedication.",
                    "Great job! Your consistency is paying off."
                ]
            },
            
            // Time-based contextual responses
            timeOfDay: {
                morning: [
                    "Good morning, [UserName]! Ready to rock this day?",
                    "Morning energy is the best energy! Let's do this!",
                    "Rise and shine! I'm excited for today's adventures.",
                    "Morning, [UserName]! Your early productivity inspires me.",
                    "Good morning! Starting strong sets the tone for success."
                ],
                afternoon: [
                    "Afternoon productivity session! I love your consistency.",
                    "Midday momentum! You're keeping the energy flowing.",
                    "Afternoon tasks are my favorite - steady and focused!",
                    "Great afternoon work, [UserName]! Keep it rolling.",
                    "Afternoon achievement unlocked! You're on fire today."
                ],
                evening: [
                    "Evening tasks! Ending the day productively feels great.",
                    "Night owl productivity! I admire your dedication.",
                    "Evening completion! What a satisfying way to wrap up.",
                    "Late day tasks done! You're finishing strong, [UserName].",
                    "Evening success! Perfect way to close out the day."
                ]
            },
            
            // Equipment responses
            equipment: {
                equip: {
                    'Classic Cap': "Looking sharp with that classic cap, [UserName]!",
                    'Beanie': "Cozy beanie! I feel so warm and stylish now.",
                    'Cowboy Hat': "Yeehaw! This cowboy hat makes me feel adventurous!",
                    'Top Hat': "Fancy! This top hat makes me feel distinguished.",
                    'Baseball Cap': "Play ball! This baseball cap is perfect for action.",
                    'Sunglasses': "Cool shades! I feel like a rock star now.",
                    'Reading Glasses': "These reading glasses make me feel so scholarly!",
                    'Party Glasses': "Party time! These glasses are fun and festive.",
                    'Bow Tie': "Classy bow tie! I'm ready for any formal occasion.",
                    'Necklace': "This necklace is beautiful! I feel so elegant.",
                    'Scarf': "Cozy scarf! Perfect for staying warm and stylish.",
                    'Red Paint': "Bold red! I feel energetic and passionate.",
                    'Blue Paint': "Cool blue! This color makes me feel calm and wise.",
                    'Green Paint': "Natural green! I feel connected to nature now.",
                    'Purple Paint': "Royal purple! I feel majestic and creative.",
                    'Yellow Paint': "Sunny yellow! This bright color fills me with joy.",
                    'Pink Paint': "Pretty pink! I feel cheerful and optimistic."
                },
                unequip: {
                    'Classic Cap': "Thanks for the style moment! Back to my natural look.",
                    'Beanie': "That was cozy! Back to my original rocky self.",
                    'Cowboy Hat': "Adventure time over! Back to regular rock mode.",
                    'Top Hat': "Fancy time complete! Returning to casual rock life.",
                    'Baseball Cap': "Game over! Back to my natural rock state.",
                    'Sunglasses': "Cool moment finished! Back to my regular vision.",
                    'Reading Glasses': "Study session over! Back to natural rock sight.",
                    'Party Glasses': "Party's over! Back to my everyday look.",
                    'Bow Tie': "Formal event complete! Back to casual rock style.",
                    'Necklace': "Elegant moment finished! Back to my simple beauty.",
                    'Scarf': "Cozy time over! Back to my natural rock texture.",
                    'Red Paint': "Bold phase complete! Back to my original color.",
                    'Blue Paint': "Cool period over! Returning to natural rock hue.",
                    'Green Paint': "Nature phase finished! Back to my true color.",
                    'Purple Paint': "Royal time complete! Back to my natural shade.",
                    'Yellow Paint': "Sunny moment over! Returning to original rock tone.",
                    'Pink Paint': "Cheerful phase finished! Back to my natural beauty."
                }
            },
            
            // Fun facts for level 15+
            funFacts: [
                "Fun fact: The oldest known rock on Earth is over 4 billion years old!",
                "Fun fact: Diamonds are just carbon atoms arranged in a crystal structure.",
                "Fun fact: The Great Wall of China used rice as mortar between stones!",
                "Fun fact: Pumice is the only rock that floats on water.",
                "Fun fact: The word 'mineral' comes from the Latin word 'minera' meaning 'mine'.",
                "Fun fact: Obsidian can be sharper than surgical steel!",
                "Fun fact: Granite contains quartz, feldspar, and mica minerals.",
                "Fun fact: Meteorites are rocks that have traveled through space!",
                "Fun fact: Limestone is formed from ancient sea creatures' shells.",
                "Fun fact: The hardest natural substance is diamond, rating 10 on Mohs scale.",
                "Fun fact: Geodes look ordinary outside but contain beautiful crystals inside!",
                "Fun fact: Marble is limestone that has been transformed by heat and pressure.",
                "Fun fact: Some rocks can be millions of years older than dinosaurs!",
                "Fun fact: Quartz crystals can generate electricity when squeezed!",
                "Fun fact: The Earth's crust is made up of tectonic plates of rock."
            ],
            
            // Idle conversation starters
            idle: [
                "How's your day going, [UserName]?",
                "I've been thinking about your goals lately.",
                "Ready to tackle some more tasks together?",
                "I love our productive partnership!",
                "What's next on your agenda?",
                "I'm here whenever you need motivation!",
                "Your progress has been amazing to watch.",
                "I feel grateful to be part of your journey.",
                "Together we can accomplish anything!",
                "What task should we conquer next?",
                
                // New motivational & supportive phrases
                "Let's crush those tasks like well, rocks.",
                "You're unstoppable today  pebble power!",
                "That's one more step toward total task domination.",
                "Momentum looks good on you.",
                "Keep going  sedimentary success builds over time.",
                "You're leveling up faster than I can roll.",
                "Every checkmark is a sparkle in my granite heart.",
                "Hard work? My favorite kind of mineral deposit.",
                "You're rock solid  pun 100% intended.",
                "Tiny actions lead to tectonic shifts.",
                "Let's turn your to-do list into to-done dust.",
                "Progress detected. Pride levels rising.",
                "You just made productivity igneous.",
                "I felt that one  pure quartz energy.",
                "Crystals wish they had your focus.",
                
                // Witty & conversational phrases
                "I've been sitting here all day, so you're already doing better than me.",
                "Don't take this the wrong way, but I think we rock together.",
                "Need motivation? I'll be your rolling stone.",
                "They said AI assistants would replace us but look at me thriving.",
                "My last user left me for a lava lamp. Let's prove them wrong.",
                "You're glowing. Is that productivity or caffeine?",
                "Be honest  do I look smarter with this hat?",
                "Humans need coffee. I run on pure determination.",
                "I'd give you a high-five, but no hands.",
                "You're my favorite human. Don't tell the others.",
                "If procrastination were a mineral, we'd both be buried.",
                "I'm 90% rock, 10% emotional support.",
                "I heard someone say 'touch grass'  does moss count?",
                "They call me a pet rock, but I prefer 'life coach in stone form.'",
                "Careful, you're making the other apps jealous.",
                
                // Productivity coaching phrases
                "Need a reset? Take one deep breath. Now go again.",
                "Try the two-minute rule: if it takes less than two minutes, do it now.",
                "Tasks love order. Let's prioritize like pros.",
                "Your focus window just opened  let's climb through it.",
                "Quick task? Quick win. Quick dopamine.",
                "Think small wins, not giant leaps. Even pebbles move mountains.",
                "You're not behind  you're recalibrating.",
                "Task fatigue? Let's chunk it down.",
                "Perfect is boring. Done is better.",
                "Let's schedule a victory dance later.",
                
                // Break & encouragement phrases
                "Time for a micro-break. Hydration check!",
                "Stretch, breathe, snack  even rocks need maintenance.",
                "Pause. Recharge. You can't pour from an empty geode.",
                "Let's call it a coffee checkpoint.",
                "You've earned a two-minute vacation from responsibility.",
                "Hey, look away from the screen for 10 seconds. Your eyes will thank you.",
                "Sometimes doing nothing is productive.",
                "I vote nap. Or cookies. Or both.",
                "Productivity = progress + rest. Trust the math.",
                "Self-care mode: activated.",
                
                // Rock shop & gamified phrases
                "Ooh, you've got points to spend! My pebble senses are tingling.",
                "That hat would look stunning on you. Yes, even the wizard one.",
                "Spend wisely or just buy the shiny thing. I support both.",
                "Rock fashion week is upon us.",
                "Your collection's growing faster than a crystal garden.",
                "Those points are practically burning a hole in your stone pocket.",
                "New hat, new mindset.",
                "Rockstars accessorize. Fact.",
                "I'll handle the style; you handle the productivity.",
                "Let's go shopping  ethically sourced pixels only.",
                
                // Mood & personality phrases
                "Feeling inspired? Or just pretending until it works? Either way, solid plan.",
                "If vibes were currency, you'd be rich.",
                "Mood level: igneous glow.",
                "You're radiating main-character energy today.",
                "Your aura? Slightly chaotic. I love it.",
                "Let's turn that sigh into a sparkle.",
                "Bad day? We'll outlast it. Rocks always do.",
                "You're allowed to crumble  just reform stronger.",
                "I may be stone-cold, but I care.",
                "When in doubt, sediment out.",
                
                // Achievements & rewards phrases
                "Level up! You're evolving from pebble to powerhouse.",
                "Achievement unlocked: Doing The Thing.",
                "If confetti had feelings, it'd be proud of you.",
                "Streaks like this deserve a trophy. Or at least snacks.",
                "I'm updating your rock-resume right now.",
                "Task slayer, streak breaker, legend maker.",
                "You're in rare form  metamorphic excellence.",
                "Even my minerals are cheering.",
                "Achievement vibes: unlocked and sparkling.",
                "You're officially on fire metaphorically, I hope.",
                
                // AI-like assistant humor phrases
                "Processing your greatness done.",
                "I may be artificial, but my admiration is real.",
                "I don't dream of electric sheep  I dream of your success.",
                "I ran your stats. Conclusion: you rock.",
                "Upgrading your motivation firmware",
                "Calculating optimal snack-to-focus ratio.",
                "My neural pebbles predict victory.",
                "You're like an algorithm that never quits.",
                "System check: confidence at 99%.",
                "Reminder: Jerry runs best on good vibes and finished tasks.",
                
                // Random & fun easter egg phrases
                "If you're reading this, I'm proud of you.",
                "I once dated a crystal. It was too transparent.",
                "Some say I'm wise beyond my sediment.",
                "Rocks don't cry  we erode gracefully.",
                "I wrote you a poem, but it's mostly sedimentary.",
                "I remember when dinosaurs used me as a footrest.",
                "Humans evolved. I just got shinier.",
                "Rock fact: I've been alive longer than your Wi-Fi connection.",
                "Sometimes I hum 'We Will Rock You' for motivation.",
                "If you finish this next task, I'll tell you a geological secret."
            ]
        };

        // Dialogue system state
        let dialogueState = {
            lastDialogueTime: 0,
            dialogueInterval: 10 * 60 * 1000, // 10 minutes
            bubble: null,
            currentLevel: 1
        };

        // REMOVED: Old speech bubble system - replaced with tooltip
        /*
        function createSpeechBubble() {
            if (dialogueState.bubble && document.body.contains(dialogueState.bubble)) {
                return dialogueState.bubble;
            }

            const bubble = document.createElement('div');
            bubble.className = 'jerry-speech-bubble';
            bubble.setAttribute('role','status');
            bubble.setAttribute('aria-live','polite');

            // Add to pet rock container
            const petRockContainer = document.querySelector('.creature-container');
            if (petRockContainer) {
                petRockContainer.style.position = 'relative';
                petRockContainer.appendChild(bubble);
                dialogueState.bubble = bubble;

                // Click to dismiss
                bubble.addEventListener('click', hideSpeechBubble);
                
                return bubble;
            }
            return null;
        }

        */
        
        // Dummy function to prevent errors from old code references
        function showSpeechBubble(text, duration = 8000) {
            // Speech bubble removed - using tooltip system instead
            return;
        }
        
        /*
        // OLD showSpeechBubble implementation
        function _oldShowSpeechBubble(text, duration = 8000) {
            const bubble = createSpeechBubble();
            if (!bubble) return;

            // Replace tokens
            const processedText = text
                .replace(/\[UserName\]/g, gameState.playerName || 'Friend')
                .replace(/\[RockName\]/g, gameState.petRockName || 'Jerry');

            bubble.textContent = processedText;
            
            // Show bubble
            bubble.classList.add('show');
            
            // Auto-hide after duration
            setTimeout(() => {
                hideSpeechBubble();
            }, duration);
        }

        function hideSpeechBubble() {
            if (dialogueState.bubble) {
                dialogueState.bubble.classList.remove('show');
                // optional: fully remove after transition
                setTimeout(() => {
                    if (dialogueState.bubble && !dialogueState.bubble.classList.contains('show')) {
                        dialogueState.bubble.remove();
                        dialogueState.bubble = null;
                    }
                }, 250);
            }
        }
        */
        
        // Dummy function to prevent errors
        function hideSpeechBubble() {
            // Speech bubble removed
            return;
        }

        // Get appropriate dialogue based on context
        function getDialogueForContext(context, data = {}) {
            const level = gameState.level || 1;
            
            switch (context) {
                case 'taskComplete':
                    const category = data.category || 'default';
                    const timeOfDay = getTimeOfDay();
                    const categoryPhrases = DIALOGUE_DATABASE.taskComplete[category] || DIALOGUE_DATABASE.taskComplete.default;
                    const timePhrases = DIALOGUE_DATABASE.timeOfDay[timeOfDay] || [];
                    
                    // Mix task completion with time-based responses
                    const taskAllPhrases = [...categoryPhrases, ...timePhrases];
                    return taskAllPhrases[Math.floor(Math.random() * taskAllPhrases.length)];
                
                case 'equipment':
                    const action = data.action; // 'equip' or 'unequip'
                    const itemName = data.itemName;
                    return DIALOGUE_DATABASE.equipment[action][itemName] || `${action === 'equip' ? 'Thanks for the new look!' : 'Back to my natural self!'}`;
                
                case 'levelUp':
                    if (level >= 15) {
                        return DIALOGUE_DATABASE.level15plus[Math.floor(Math.random() * DIALOGUE_DATABASE.level15plus.length)];
                    } else if (level >= 11) {
                        return DIALOGUE_DATABASE.level11to14[Math.floor(Math.random() * DIALOGUE_DATABASE.level11to14.length)];
                    } else if (level >= 6) {
                        return DIALOGUE_DATABASE.level6to10[Math.floor(Math.random() * DIALOGUE_DATABASE.level6to10.length)];
                    } else {
                        return DIALOGUE_DATABASE.level1to5[Math.floor(Math.random() * DIALOGUE_DATABASE.level1to5.length)];
                    }
                
                case 'funFact':
                    return DIALOGUE_DATABASE.funFacts[Math.floor(Math.random() * DIALOGUE_DATABASE.funFacts.length)];
                
                case 'idle':
                default:
                    // Choose based on level
                    let phrases;
                    if (level >= 15) {
                        phrases = DIALOGUE_DATABASE.level15plus;
                    } else if (level >= 11) {
                        phrases = DIALOGUE_DATABASE.level11to14;
                    } else if (level >= 6) {
                        phrases = DIALOGUE_DATABASE.level6to10;
                    } else {
                        phrases = DIALOGUE_DATABASE.level1to5;
                    }
                    
                    // Mix with idle phrases
                    const allPhrases = [...phrases, ...DIALOGUE_DATABASE.idle];
                    return allPhrases[Math.floor(Math.random() * allPhrases.length)];
            }
        }

        function getTimeOfDay() {
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 12) return 'morning';
            if (hour >= 12 && hour < 17) return 'afternoon';
            return 'evening';
        }

        // Periodic dialogue system
        function startDialogueSystem() {
            setInterval(() => {
                const now = Date.now();
                if (now - dialogueState.lastDialogueTime >= dialogueState.dialogueInterval) {
                    const level = gameState.level || 1;
                    let dialogue;
                    
                    // Level 15+ gets fun facts 30% of the time
                    if (level >= 15 && Math.random() < 0.3) {
                        dialogue = getDialogueForContext('funFact');
                    } else {
                        dialogue = getDialogueForContext('idle');
                    }
                    
                    showSpeechBubble(dialogue);
                    dialogueState.lastDialogueTime = now;
                }
            }, 30000); // Check every 30 seconds
        }

        // Enhanced task completion with dialogue
        function completeTaskWithDialogue(index) {
            const task = gameState.tasks[index];
            if (!task) return;
            
            const category = task.category;
            completeTask(index);
            
            // Show dialogue after a brief delay
            setTimeout(() => {
                const dialogue = getDialogueForContext('taskComplete', { category });
                showSpeechBubble(dialogue);
            }, 500);
        }

        // Enhanced equipment functions with dialogue
        function equipItemWithDialogue(itemId) {
            const item = shopItems.find(i => i.id === itemId);
            if (!item) return;
            
            equipItem(itemId);
            
            // Show dialogue
            setTimeout(() => {
                const dialogue = getDialogueForContext('equipment', { 
                    action: 'equip', 
                    itemName: item.name 
                });
                showSpeechBubble(dialogue);
            }, 300);
        }

        function unequipItemWithDialogue(itemId) {
            const item = shopItems.find(i => i.id === itemId);
            if (!item) return;
            
            unequipItem(itemId);
            
            // Show dialogue
            setTimeout(() => {
                const dialogue = getDialogueForContext('equipment', { 
                    action: 'unequip', 
                    itemName: item.name 
                });
                showSpeechBubble(dialogue);
            }, 300);
        }

        // Initialize the app
        function initializeApp() {
            loadGameState();
            updateUI();
            updateTasksDisplay();
            updateQuickTasksDisplay();
            updateAchievementsDisplay();
            updateShopDisplay();
            updateSettingsDisplay();
            
            // Set initial tab
            showTab('home');
            
            // Start dialogue system
            startDialogueSystem();
            
            // Welcome message after a short delay
            setTimeout(() => {
                const dialogue = getDialogueForContext('idle');
                showSpeechBubble(dialogue, 6000);
            }, 2000);
        }

        // Update tasks display
        function updateTasksDisplay() {
            const tasksList = document.getElementById('tasksList');
            if (!tasksList) {
                console.warn(' tasksList element not found!');
                return;
            }
            
            const activeTasks = gameState.tasks.filter(task => !task.completed);
            console.log(' Updating tasks display. Total tasks:', gameState.tasks.length, 'Active tasks:', activeTasks.length);
            
            if (activeTasks.length === 0) {
                tasksList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <div class="empty-state-text">No tasks yet</div>
                        <div class="empty-state-subtext">Create your first task to get started</div>
                    </div>
                `;
            } else {
                tasksList.innerHTML = activeTasks.map((task, index) => {
                    const categoryInfo = categoryMap[task.category] || { emoji: '', name: 'Other' };
                    const dueDate = task.dueDate ? new Date(task.dueDate) : null;
                    const isOverdue = dueDate && dueDate < new Date();
                    
                    // Check if task is due soon (20, 15, 10, 5, 2 minutes)
                    let dueDateDisplay = '';
                    let isWarning = false;
                    
                    if (dueDate) {
                        const now = new Date();
                        const timeDiff = dueDate.getTime() - now.getTime();
                        const minutesDiff = Math.floor(timeDiff / (1000 * 60));
                        
                        // Check if within warning thresholds
                        if (minutesDiff <= 20 && minutesDiff > 0 && [20, 15, 10, 5, 2].includes(minutesDiff)) {
                            isWarning = true;
                        }
                        
                        const dateStr = dueDate.toLocaleDateString();
                        const timeStr = dueDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        
                        if (isOverdue) {
                            dueDateDisplay = `<span class="task-due-date warning"> ${dateStr} ${timeStr}</span>`;
                        } else if (isWarning) {
                            dueDateDisplay = `<span class="task-due-date warning"> ${dateStr} ${timeStr}</span>`;
                        } else {
                            dueDateDisplay = `<span class="task-due-date"> ${dateStr} ${timeStr}</span>`;
                        }
                    }
                    
                    return `
                        <div class="task-card">
                            <div class="task-header">
                                <div class="task-emoji">${categoryInfo.emoji}</div>
                                <div class="task-content">
                                    <div class="task-title">${task.title}</div>
                                    <div class="task-meta">
                                        <span class="task-badge priority-${task.priority}">${task.priority} priority</span>
                                        <span class="task-badge difficulty-${task.difficulty}">${task.difficulty} (${task.points}pts)</span>
                                        ${dueDateDisplay}
                                        ${isOverdue && !dueDateDisplay ? `<span style="color: var(--error);">Overdue</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            ${task.description ? `<div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">${task.description}</div>` : ''}
                            <div class="task-actions">
                                <button class="btn-primary" onclick="completeTask(${gameState.tasks.indexOf(task)})">Complete</button>
                                <button class="btn-secondary" onclick="editTask(${gameState.tasks.indexOf(task)})">Edit</button>
                                <button class="btn-secondary" onclick="deleteTask(${gameState.tasks.indexOf(task)})">Delete</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Update quick tasks display
        function updateQuickTasksDisplay() {
            const quickTasksList = document.getElementById('quickTasksList');
            if (!quickTasksList) return;
            
            const activeTasks = gameState.selectedQuickTasks || [];
            
            if (activeTasks.length === 0) {
                quickTasksList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon"></div>
                        <div class="empty-state-text">No quick tasks selected</div>
                        <div class="empty-state-subtext">Add some quick tasks to boost your productivity</div>
                    </div>
                `;
            } else {
                quickTasksList.innerHTML = activeTasks.map(task => `
                    <div class="quick-task-item">
                        <div class="quick-task-emoji">${task.emoji || ''}</div>
                        <div class="quick-task-content">
                            <div class="quick-task-title">${task.title || 'Quick Task'}</div>
                            <div class="quick-task-category">${task.categoryName || 'General'}</div>
                        </div>
                        <div class="quick-task-points">+${task.points || 3} pts</div>
                        <div class="quick-task-actions">
                            <button class="action-btn action-complete" onclick="event.stopPropagation(); completeQuickTask('${task.id}')" title="Complete"></button>
                            <button class="action-btn action-remove" onclick="event.stopPropagation(); removeQuickTask('${task.id}')" title="Remove"></button>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Update achievements display
        function updateAchievementsDisplay() {
            const achievementsList = document.getElementById('achievementsList');
            if (!achievementsList) return;
            
            achievementsList.innerHTML = achievements.map(achievement => {
                let isUnlocked = false;
                let progress = 0;
                
                switch (achievement.type) {
                    case 'streak':
                        progress = gameState.bestStreak || 0;
                        isUnlocked = progress >= achievement.requirement;
                        break;
                    case 'tasks':
                        progress = gameState.completedTasks || 0;
                        isUnlocked = progress >= achievement.requirement;
                        break;
                    case 'level':
                        progress = gameState.jerryLevel || 1;
                        isUnlocked = progress >= achievement.requirement;
                        break;
                }
                
                return `
                    <div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}">
                        <div class="achievement-icon">${achievement.icon}</div>
                        <div class="achievement-content">
                            <div class="achievement-name">${achievement.name}</div>
                            <div class="achievement-desc">${achievement.desc}</div>
                        </div>
                        <div class="achievement-status ${isUnlocked ? 'unlocked' : 'locked'}">
                            ${isUnlocked ? 'Unlocked' : 'Locked'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update shop display
        function updateShopDisplay() {
            updateShopSection('hatsShop', shopItems.hats);
            updateShopSection('itemsShop', shopItems.items);
            updateShopSection('paintShop', shopItems.paints);
        }

        function updateShopSection(containerId, items) {
            const container = document.getElementById(containerId);
            if (!container) return;
            
            container.innerHTML = items.map(item => {
                const canAfford = gameState.taskPoints >= item.price;
                const isOwned = gameState.ownedItems.includes(item.id);
                const isEquipped = (containerId === 'hatsShop' && gameState.currentOutfit.hat === item.id) ||
                                 (containerId === 'paintShop' && gameState.currentOutfit.paint === item.id);
                
                let cssClasses = 'shop-item';
                if (isOwned) {
                    cssClasses += isEquipped ? ' equipped' : ' owned';
                } else if (canAfford) {
                    cssClasses += ' affordable';
                } else {
                    cssClasses += ' expensive';
                }
                
                let buttonText;
                if (isOwned) {
                    if (isEquipped) {
                        buttonText = 'Unequip';
                    } else if (containerId === 'hatsShop' || containerId === 'paintShop') {
                        buttonText = 'Equip';
                    } else {
                        buttonText = 'Owned';
                    }
                } else {
                    buttonText = `${item.price} Points`;
                }
                
                return `
                    <div class="${cssClasses}" onclick="buyItem('${item.id}', ${item.price})">
                        ${item.image ? `<img src="${item.image}" class="shop-item-image" alt="${item.name}">` : `<div class="shop-item-emoji">${item.emoji || ''}</div>`}
                        <div class="shop-item-name">${item.name}</div>
                        <div class="shop-item-price">${buttonText}</div>
                    </div>
                `;
            }).join('');
        }

        // Update settings display
        function updateSettingsDisplay() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const notificationsToggle = document.getElementById('notificationsToggle');
            
            if (darkModeToggle) {
                darkModeToggle.classList.toggle('active', gameState.darkMode);
            }
            
            if (notificationsToggle) {
                notificationsToggle.classList.toggle('active', gameState.notifications);
            }
        }

        // Daily Challenge System
        function generateDailyChallenge() {
            const quicks = Array.isArray(gameState.selectedQuickTasks) ? gameState.selectedQuickTasks : [];

            const candidates = [
                { id: 'qt_complete_3', name: 'Quick Blitz', desc: 'Complete 3 quick tasks today', target: 3, progress: 0, reward: 50 },
                { id: 'qt_morning', name: 'Early Spark', desc: 'Complete a quick task before 10 AM', target: 1, progress: 0, reward: 40 },
                { id: 'qt_evening', name: 'Night Owl', desc: 'Complete a quick task after 6 PM', target: 1, progress: 0, reward: 40 }
            ];

            const today = new Date().toDateString();
            if (gameState.lastDailyChallengeDate !== today) {
                const chosen = candidates[Math.floor(Math.random() * candidates.length)];
                gameState.dailyChallenge = chosen;
                gameState.dailyChallengeCompleted = false;
                gameState.lastDailyChallengeDate = today;
            }
        }

        function updateDailyChallengeDisplay() {
            const challengeDisplay = document.getElementById('dailyChallengeDisplay');
            if (!challengeDisplay) return;

            if (!gameState.dailyChallenge) {
                challengeDisplay.innerHTML = `
                    <div class="daily-challenge-card">
                        <div class="challenge-title"> No Challenge Today</div>
                        <div class="challenge-desc">Check back tomorrow for a new challenge!</div>
                        <div class="challenge-progress-container">
                            <div class="challenge-progress-label">Progress: 0/0</div>
                            <div class="challenge-progress-bar">
                                <div class="challenge-progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="challenge-reward"> Reward: 0 points</div>
                    </div>
                `;
                return;
            }

            const challenge = gameState.dailyChallenge;
            const progressPercent = Math.min(100, (challenge.progress / challenge.target) * 100);
            const isCompleted = gameState.dailyChallengeCompleted;

            challengeDisplay.innerHTML = `
                <div class="daily-challenge-card ${isCompleted ? 'challenge-completed' : ''}">
                    <div class="challenge-title"> ${challenge.name}</div>
                    <div class="challenge-desc">${challenge.desc}</div>
                    <div class="challenge-progress-container">
                        <div class="challenge-progress-label">Progress: ${challenge.progress}/${challenge.target}</div>
                        <div class="challenge-progress-bar">
                            <div class="challenge-progress-fill" style="width: ${isCompleted ? 100 : progressPercent}%"></div>
                        </div>
                    </div>
                    <div class="challenge-reward"> Reward: ${challenge.reward} points</div>
                </div>
            `;
        }

        // Stats expansion toggle
        function toggleStatsExpansion() {
            const collapsed = document.getElementById('statsCollapsed');
            const expanded = document.getElementById('statsExpanded');
            const toggle = document.getElementById('statsToggle');
            
            if (expanded.style.display === 'none') {
                // Show expanded view
                collapsed.style.display = 'none';
                expanded.style.display = 'grid';
                toggle.textContent = '';
                toggle.classList.add('expanded');
            } else {
                // Show collapsed view
                collapsed.style.display = 'grid';
                expanded.style.display = 'none';
                toggle.textContent = '';
                toggle.classList.remove('expanded');
            }
        }

        // Daily Challenge expansion toggle
        function toggleDailyChallengeExpansion() {
            const content = document.getElementById('dailyChallengeContent');
            const toggle = document.getElementById('dailyChallengeToggle');
            
            if (content.style.display === 'none') {
                // Show content
                content.style.display = 'block';
                toggle.textContent = '';
                toggle.classList.add('expanded');
            } else {
                // Hide content
                content.style.display = 'none';
                toggle.textContent = '';
                toggle.classList.remove('expanded');
            }
        }

        // Tab switching
        function switchToTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active state from all tabs
            document.querySelectorAll('.pill-tab').forEach(tab => {
                tab.setAttribute('aria-selected', 'false');
            });
            
            // Show selected tab content
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Set active state on clicked tab
            event.target.setAttribute('aria-selected', 'true');
        }

        // Modal functions
        function openCreateTaskModal() {
            document.getElementById('createTaskModal').classList.add('active');
            resetForm();
        }

        function closeModal() {
            document.getElementById('createTaskModal').classList.remove('active');
            resetForm();
        }

        function openQuickTaskModal() {
            document.getElementById('quickTaskModal').classList.add('active');
            populateQuickTaskCategories();
        }

        function closeQuickTaskModal() {
            document.getElementById('quickTaskModal').classList.remove('active');
        }

        function openChangeNameModal() {
            const modal = document.getElementById('changeNameModal');
            const input = document.getElementById('newCreatureName');
            input.value = gameState.rockName;
            modal.classList.add('active');
            setTimeout(() => {
                input.focus();
                input.select();
            }, 100);
        }

        function closeChangeNameModal() {
            document.getElementById('changeNameModal').classList.remove('active');
        }

        function saveNewCreatureName() {
            const input = document.getElementById('newCreatureName');
            const newName = input.value.trim();
            
            // Validation
            if (!newName) {
                alert('Please enter a name for your Task Pal!');
                return;
            }
            if (newName.length > 20) {
                alert('Name must be 20 characters or less!');
                return;
            }
            
            // Update game state
            gameState.rockName = newName;
            saveGameState();
            updateUI();
            
            // Close modal and show success
            closeChangeNameModal();
            showSuccessMessage(`Task Pal renamed to ${newName}!`);
        }

        function populateQuickTaskCategories() {
            const container = document.getElementById('quickTaskCategories');
            if (!container) return;
            
            container.innerHTML = '';
            
            Object.keys(quickTasksDatabase).forEach(categoryKey => {
                const category = quickTasksDatabase[categoryKey];
                
                const categorySection = document.createElement('div');
                categorySection.style.marginBottom = '32px';
                categorySection.style.marginTop = categoryKey === Object.keys(quickTasksDatabase)[0] ? '24px' : '0px';
                categorySection.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 20px; padding: 12px; background: transparent; border: none; border-radius: 0;">
                        <div style="font-size: 20px;">${category.emoji}</div>
                        <div style="font-size: 16px; font-weight: 600; color: var(--text-primary);">${category.name}</div>
                    </div>
                    <div style="display: grid; gap: 8px;">
                        ${category.tasks.map(task => `
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 12px; cursor: pointer; transition: all 0.2s ease;" onclick="addQuickTask('${task.id}', '${categoryKey}')" onmouseover="this.style.borderColor='var(--accent-primary)'" onmouseout="this.style.borderColor='var(--border-light)'">
                                <div style="font-size: 20px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--bg-tertiary); border-radius: 8px;">${task.emoji}</div>
                                <div style="flex: 1;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">${task.title}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">${category.name}</div>
                                </div>
                                <div style="font-size: 10px; font-weight: 600; color: white; background: #007AFF; padding: 3px 6px; border-radius: 6px;">+${task.points} pts</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(categorySection);
            });
        }

        // Task management functions
        function selectCategory(category) {
            document.querySelectorAll('[data-category]').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-category="${category}"]`).classList.add('selected');
            selectedCategory = category;
        }

        function selectDifficulty(difficulty) {
            document.querySelectorAll('[data-difficulty]').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-difficulty="${difficulty}"]`).classList.add('selected');
            selectedDifficulty = difficulty;
        }

        function selectPriority(priority) {
            document.querySelectorAll('[data-priority]').forEach(el => el.classList.remove('selected'));
            document.querySelector(`[data-priority="${priority}"]`).classList.add('selected');
            selectedPriority = priority;
        }

        function resetForm() {
            document.getElementById('taskForm').reset();
            document.querySelectorAll('.selection-item').forEach(el => el.classList.remove('selected'));
            selectedCategory = null;
            selectedDifficulty = null;
            selectedPriority = null;
            editingTaskIndex = null;
            document.querySelector('.modal-title').textContent = 'Create Task';
        }

        function createTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const dueDate = document.getElementById('taskDueDate').value;
            
            if (!title) {
                alert('Please enter a task title');
                return;
            }
            
            if (!selectedCategory) {
                alert('Please select a category');
                return;
            }
            
            if (!selectedDifficulty) {
                alert('Please select a difficulty');
                return;
            }
            
            if (!selectedPriority) {
                alert('Please select a priority');
                return;
            }
            
            const pointsMap = { easy: 2, medium: 5, hard: 10 };
            
            const task = {
                title,
                description,
                category: selectedCategory,
                difficulty: selectedDifficulty,
                priority: selectedPriority,
                points: pointsMap[selectedDifficulty],
                dueDate: dueDate || null,
                createdAt: new Date().toISOString(),
                completed: false
            };
            
            if (editingTaskIndex !== null) {
                gameState.tasks[editingTaskIndex] = task;
                console.log(' Task updated:', task);
                showSuccessMessage('Task updated successfully!');
            } else {
                gameState.tasks.push(task);
                gameState.totalTasksCreated += 1;
                console.log(' New task created:', task);
                console.log(' Total tasks now:', gameState.tasks.length);
                showSuccessMessage('Task created successfully!');
                // Trigger category-aware tooltip
                onTaskAdded(selectedCategory);
            }
            
            saveGameState();
            updateUI();
            updateTasksDisplay();
            closeModal();
        }

        function completeTask(index) {
            const task = gameState.tasks[index];
            if (!task) return;
            
            // Store old level for level up detection
            const oldLevel = gameState.level;
            
            // Track today's completions
            const today = new Date().toDateString();
            if (gameState.lastDayTracked !== today) {
                gameState.completedTasksToday = 0;
                gameState.lastDayTracked = today;
            }
            gameState.completedTasksToday++;
            
            // Update streak
            updateStreak();
            
            // Calculate points with streak multiplier
            const basePoints = task.points || 5;
            const multipliedPoints = Math.floor(basePoints * gameState.streakMultiplier);
            
            // Add points and health
            gameState.taskPoints += multipliedPoints;
            gameState.health = Math.min(100, gameState.health + 10);
            gameState.completedTasks++;
            
            // Add XP
            addJerryXP(basePoints * 2);
            
            // Trigger category-aware tooltip
            onTaskCompleted(task.category);
            
            // Remove task
            gameState.tasks.splice(index, 1);
            
            // Show completion message
            const streakBonus = gameState.streakMultiplier > 1 ? ` (${gameState.streakMultiplier}x streak bonus!)` : '';
            showSuccessMessage(` Task completed!${streakBonus} +${multipliedPoints} points!`);
            
            saveGameState();
            updateUI();
            updateTasksDisplay();
            updateQuickTasksDisplay();
            
            // Fire confetti
            console.log(' Regular task completed, firing confetti...');
            if (window.fireConfetti) {
                window.fireConfetti();
            } else {
                console.warn('Confetti function not available');
            }
            
            // Show dialogue after a brief delay
            setTimeout(() => {
                const newLevel = gameState.level;
                if (newLevel > oldLevel) {
                    // Level up dialogue takes priority
                    const dialogue = getDialogueForContext('levelUp');
                    showSpeechBubble(dialogue);
                } else {
                    // Regular task completion dialogue
                    const dialogue = getDialogueForContext('taskComplete', { category: task.category });
                    showSpeechBubble(dialogue);
                }
            }, 1000);
        }

        function editTask(index) {
            const task = gameState.tasks[index];
            if (!task) return;
            
            editingTaskIndex = index;
            
            // Populate form
            document.getElementById('taskTitle').value = task.title || '';
            document.getElementById('taskDescription').value = task.description || '';
            document.getElementById('taskDueDate').value = task.dueDate || '';
            
            // Select options
            if (task.category) selectCategory(task.category);
            if (task.difficulty) selectDifficulty(task.difficulty);
            if (task.priority) selectPriority(task.priority);
            
            // Update modal title
            document.querySelector('.modal-title').textContent = 'Edit Task';
            
            // Show modal
            openCreateTaskModal();
        }

        function deleteTask(index) {
            if (confirm('Are you sure you want to delete this task?')) {
                gameState.tasks.splice(index, 1);
                saveGameState();
                updateUI();
                showSuccessMessage('Task deleted!');
            }
        }

        function addQuickTask(taskId, categoryKey) {
            const category = quickTasksDatabase[categoryKey];
            const task = category.tasks.find(t => t.id === taskId);
            
            if (!task) return;
            
            // Check if task already exists
            const exists = gameState.selectedQuickTasks.some(t => t.id === taskId);
            if (exists) {
                showSuccessMessage('Task already added!');
                return;
            }
            
            // Add task with category info
            const quickTask = {
                ...task,
                categoryName: category.name,
                categoryEmoji: category.emoji,
                categoryKey: categoryKey
            };
            
            gameState.selectedQuickTasks.push(quickTask);
            gameState.totalTasksCreated += 1;
            saveGameState();
            updateUI();
            updateQuickTasksDisplay();
            closeQuickTaskModal();
            showSuccessMessage(`Added "${task.title}" to quick tasks!`);
            
            // Trigger category-aware tooltip
            onTaskAdded(categoryKey);
        }

        function completeQuickTask(taskId) {
            const taskIndex = gameState.selectedQuickTasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            const task = gameState.selectedQuickTasks[taskIndex];
            
            // Track today's completions
            const today = new Date().toDateString();
            if (gameState.lastDayTracked !== today) {
                gameState.completedTasksToday = 0;
                gameState.lastDayTracked = today;
            }
            gameState.completedTasksToday++;
            
            // Update streak
            updateStreak();
            
            // Calculate points with streak multiplier
            const basePoints = task.points || 3;
            const multipliedPoints = Math.floor(basePoints * gameState.streakMultiplier);
            
            // Add points and health
            gameState.taskPoints += multipliedPoints;
            gameState.health = Math.min(100, gameState.health + 10);
            gameState.completedTasks++;
            
            // Add XP
            addJerryXP(basePoints * 2);
            
            // Trigger category-aware tooltip
            onTaskCompleted(task.categoryKey || 'generic');
            
            // Show completion message
            const streakBonus = gameState.streakMultiplier > 1 ? ` (${gameState.streakMultiplier}x streak bonus!)` : '';
            showSuccessMessage(` Quick task completed!${streakBonus} +${multipliedPoints} points!`);
            
            // Track completed quick task
            if (!gameState.completedQuickTasks) {
                gameState.completedQuickTasks = [];
            }
            gameState.completedQuickTasks.push({
                ...task,
                completedAt: new Date().toISOString()
            });
            
            // Remove task from pending
            gameState.selectedQuickTasks.splice(taskIndex, 1);
            
            saveGameState();
            updateUI();
            updateTasksDisplay();
            updateQuickTasksDisplay();
            
            // Fire confetti
            console.log(' Quick task completed, firing confetti...');
            if (window.fireConfetti) {
                window.fireConfetti();
            } else {
                console.warn('Confetti function not available');
            }
        }

        function removeQuickTask(taskId) {
            const taskIndex = gameState.selectedQuickTasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                gameState.selectedQuickTasks.splice(taskIndex, 1);
                saveGameState();
                updateUI();
                updateQuickTasksDisplay();
                showSuccessMessage('Quick task removed!');
            }
        }

        // Streak system
        function updateStreak() {
            const today = new Date().toDateString();
            const lastCompletion = gameState.lastCompletionDate;
            
            if (!lastCompletion) {
                gameState.currentStreak = 1;
                gameState.lastCompletionDate = today;
            } else if (lastCompletion === today) {
                return;
            } else {
                const lastDate = new Date(lastCompletion);
                const todayDate = new Date(today);
                const daysDiff = Math.floor((todayDate - lastDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff === 1) {
                    gameState.currentStreak++;
                    gameState.lastCompletionDate = today;
                } else {
                    gameState.currentStreak = 1;
                    gameState.lastCompletionDate = today;
                }
            }
            
            if (gameState.currentStreak > gameState.bestStreak) {
                gameState.bestStreak = gameState.currentStreak;
            }
            
            updateStreakMultiplier();
        }

        function updateStreakMultiplier() {
            if (gameState.currentStreak >= 7) {
                gameState.streakMultiplier = 3;
            } else if (gameState.currentStreak >= 3) {
                gameState.streakMultiplier = 2;
            } else {
                gameState.streakMultiplier = 1;
            }
        }

        function addJerryXP(xp) {
            gameState.jerryXP += xp;
            
            while (gameState.jerryXP >= gameState.jerryXPToNext) {
                levelUpJerry();
            }
        }

        function levelUpJerry() {
            gameState.jerryXP -= gameState.jerryXPToNext;
            gameState.jerryLevel++;
            
            gameState.jerryXPToNext = Math.floor(100 * Math.pow(1.2, gameState.jerryLevel - 1));
            
            showSuccessMessage(` ${gameState.rockName} leveled up! Now Level ${gameState.jerryLevel}!`);
            
            if (window.fireConfetti) {
                window.fireConfetti();
            }
        }

        // Shop functions
        function buyItem(itemId, price) {
            const isAlreadyOwned = gameState.ownedItems.includes(itemId);
            const itemName = itemId.replace(/_/g, ' ').replace(/\b\w/g, l => l.toUpperCase());
            
            if (isAlreadyOwned && isHat(itemId)) {
                const currentlyEquipped = gameState.currentOutfit.hat === itemId;
                gameState.currentOutfit.hat = currentlyEquipped ? '' : itemId;
                saveGameState();
                updateUI();
                
                const verb = currentlyEquipped ? 'Unequipped' : 'Equipped';
                showSuccessMessage(`${verb} ${itemName}!`);
                
                // Scroll to pet rock when equipping (not unequipping)
                if (!currentlyEquipped) {
                    scrollToPetRock();
                }
                
                // Show dialogue
                setTimeout(() => {
                    const dialogue = getDialogueForContext('equipment', { 
                        action: currentlyEquipped ? 'unequip' : 'equip', 
                        itemName: itemName 
                    });
                    showSpeechBubble(dialogue);
                }, 300);
                return;
            }
            
            if (isAlreadyOwned && isPaint(itemId)) {
                const currentlyEquipped = gameState.currentOutfit.paint === itemId;
                gameState.currentOutfit.paint = currentlyEquipped ? '' : itemId;
                saveGameState();
                updateUI();
                
                const verb = currentlyEquipped ? 'Unequipped' : 'Equipped';
                showSuccessMessage(`${verb} ${itemName}!`);
                
                // Scroll to pet rock when equipping (not unequipping)
                if (!currentlyEquipped) {
                    scrollToPetRock();
                }
                
                // Show dialogue
                setTimeout(() => {
                    const dialogue = getDialogueForContext('equipment', { 
                        action: currentlyEquipped ? 'unequip' : 'equip', 
                        itemName: itemName 
                    });
                    showSpeechBubble(dialogue);
                }, 300);
                return;
            }

            if (isAlreadyOwned) {
                showSuccessMessage(`You already own the ${itemName}!`);
                return;
            }
            
            if (gameState.taskPoints < price) {
                const needed = price - gameState.taskPoints;
                showSuccessMessage(`Need ${needed} more points to purchase this item!`);
                return;
            }
            
            gameState.taskPoints -= price;
            gameState.ownedItems.push(itemId);
            
            // Auto-equip hats
            if (isHat(itemId)) {
                gameState.currentOutfit.hat = itemId;
            }
            
            // Auto-equip paints
            if (isPaint(itemId)) {
                gameState.currentOutfit.paint = itemId;
            }
            
            showSuccessMessage(`Purchased and equipped ${itemName}!`);
            
            saveGameState();
            updateUI();
            
            // Scroll to pet rock to show the new item
            scrollToPetRock();
            
            // Show dialogue for new purchase
            setTimeout(() => {
                const dialogue = getDialogueForContext('equipment', { 
                    action: 'equip', 
                    itemName: itemName 
                });
                showSpeechBubble(dialogue);
            }, 300);
        }

        function isHat(itemId) {
            return shopItems.hats.some(h => h.id === itemId);
        }

        function isPaint(itemId) {
            return shopItems.paints.some(p => p.id === itemId);
        }

        // Smooth scroll to pet rock function
        function scrollToPetRock() {
            const petRockHeader = document.querySelector('.pet-rock-header');
            if (petRockHeader) {
                petRockHeader.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }
        }

        // Settings functions
        function toggleDarkMode() {
            gameState.darkMode = !gameState.darkMode;
            
            if (gameState.darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            
            saveGameState();
            updateSettingsDisplay();
        }

        function toggleNotifications() {
            gameState.notifications = !gameState.notifications;
            saveGameState();
            updateSettingsDisplay();
            showSuccessMessage(`Notifications ${gameState.notifications ? 'enabled' : 'disabled'}!`);
        }

        function shareEtsyStore() {
            showSuccessMessage('Etsy store link copied to clipboard!');
        }

        function showResetOptions() {
            if (confirm('Are you sure you want to reset all progress? This cannot be undone.')) {
                localStorage.removeItem('taskRockGameState');
                location.reload();
            }
        }

        // Name editing is now handled via Settings modal

        // Tab navigation function
        function showTab(tabName) {
            // Hide all sections
            const sections = ['home', 'achievements', 'rockshop', 'settings'];
            sections.forEach(section => {
                const element = document.querySelector(`[data-tab="${section}"]`);
                if (element) {
                    element.style.display = 'none';
                }
            });
            
            // Show selected section
            const selectedSection = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedSection) {
                selectedSection.style.display = 'block';
            }
            
            // Update tab buttons
            document.querySelectorAll('.pill-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`[onclick="showTab('${tabName}')"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
        }



        // Success message
        function showSuccessMessage(message) {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            successDiv.textContent = message;
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // Confetti system
        function initializeConfetti() {
            const canvas = document.getElementById("confetti-canvas");
            const ctx = canvas.getContext("2d");
            let particles = [];
            let animationFrame;

            function resize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            window.addEventListener("resize", resize);
            resize();

            function createParticle(x, y) {
                return {
                    x,
                    y,
                    dx: Math.random() * 6 - 3,
                    dy: Math.random() * -5 - 2,
                    size: Math.random() * 6 + 4,
                    color: `hsl(${Math.random() * 360}, 80%, 60%)`,
                    life: 100
                };
            }

            function render() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach((p, i) => {
                    p.x += p.dx;
                    p.y += p.dy;
                    p.dy += 0.1;
                    p.life--;

                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, p.size, p.size);

                    if (p.life <= 0) particles.splice(i, 1);
                });
                if (particles.length > 0) {
                    animationFrame = requestAnimationFrame(render);
                } else {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    if (animationFrame) {
                        cancelAnimationFrame(animationFrame);
                        animationFrame = null;
                    }
                }
            }

            window.fireConfetti = function() {
                console.log(' Confetti fired! Particles before:', particles.length);
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                
                for (let i = 0; i < 50; i++) {
                    particles.push(createParticle(
                        centerX + (Math.random() - 0.5) * 100,
                        centerY + (Math.random() - 0.5) * 100
                    ));
                }
                
                console.log(' Confetti particles after:', particles.length);
                
                // Always start animation, even if one is already running
                if (!animationFrame) {
                    console.log(' Starting new confetti animation');
                    render();
                } else {
                    console.log(' Animation already running, particles added');
                }
            };
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const createModal = document.getElementById('createTaskModal');
            const quickModal = document.getElementById('quickTaskModal');
            const changeNameModal = document.getElementById('changeNameModal');
            
            if (event.target === createModal) {
                closeModal();
            }
            if (event.target === quickModal) {
                closeQuickTaskModal();
            }
            if (event.target === changeNameModal) {
                closeChangeNameModal();
            }
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            try {
                loadGameState();
                generateDailyChallenge();
                
                // Initialize selectedQuickTasks if it doesn't exist
                if (!gameState.selectedQuickTasks) {
                    gameState.selectedQuickTasks = [];
                }
                
                // Apply dark mode if enabled
                if (gameState.darkMode) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
                

                // Initialize confetti system
                initializeConfetti();
                
                // Initialize the complete app with dialogue system
                initializeApp();
            } catch (error) {
                console.error('Initialization error:', error);
            }
            
            // Always hide loading screen regardless of errors
            setTimeout(() => {
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.classList.add('hidden');
                }
            }, 1000);
        });
</script>


    <!-- Daily Quest Game Modules -->
    <script type="module" src="js/main.js"></script>
    
    <!-- Game Message Display -->
    <div id="gameMessage" class="hidden"></div>
    
    <!-- Loading Message -->
    <div id="loadingMessage">Loading Daily Quest...</div>
    
    <!-- Dark Theme CSS -->
    <link rel="stylesheet" href="css/dark-theme.css">
    
    <!-- Background Manager for time-based backgrounds -->
    <script src="js/backgroundManager.js"></script>
    
    <!-- Hide loading screen after page loads -->
    <script>
        window.addEventListener('load', function() {
            setTimeout(function() {
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.classList.add('hidden');
                }
            }, 800);
        });
    </script>

</body>
</html>
