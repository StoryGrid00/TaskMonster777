<!DOCTYPE html>
<html lang="en" data-theme="dark">
<head>
<meta charset="utf-8"/>
<meta content="width=device-width, initial-scale=1.0" name="viewport"/>
<title>Task Monsters</title>
<!-- PWA Manifest -->
<link href="manifest.json?v=1757559779" rel="manifest"/>
<!-- PWA Meta Tags -->
<meta content="#111111" name="theme-color"/>
<meta content="yes" name="apple-mobile-web-app-capable"/>
<meta content="default" name="apple-mobile-web-app-status-bar-style"/>
<meta content="Task Rock" name="apple-mobile-web-app-title"/>
<meta content="Task Rock" name="application-name"/>
<meta content="#9AE34A" name="msapplication-TileColor"/>
<!-- Icons for Browser Tabs and Mobile -->
<link href="assets/logo/favicon.png" rel="icon" sizes="16x16" type="image/png"/>
<link href="assets/logo/favicon.png" rel="icon" sizes="32x32" type="image/png"/>
<link href="assets/logo/favicon.png" rel="icon" sizes="48x48" type="image/png"/>
<link href="assets/logo/favicon.png" rel="icon" sizes="96x96" type="image/png"/>
<link href="assets/logo/favicon.png" rel="icon" sizes="192x192" type="image/png"/>
<link href="assets/logo/favicon.png" rel="apple-touch-icon" sizes="180x180"/>
<link href="assets/logo/favicon.png" rel="shortcut icon"/>
<!-- SEO Meta Tags -->
<meta content="Task Monsters - An RPG productivity game with Jerry the Rock, your virtual pet companion" name="description"/>
<meta content="task manager, productivity, pet rock, jerry, tasks, todo" name="keywords"/>
<meta content="Task Rock" name="author"/>
<!-- Open Graph Meta Tags -->
<meta content="Task Monsters - RPG Productivity Game" property="og:title"/>
<meta content="A fun task management app with Jerry the Rock, your virtual pet companion" property="og:description"/>
<meta content="assets/images/icon-512x512.png" property="og:image"/>
<meta content="https://storygrid00.github.io/Task_Rock" property="og:url"/>
<meta content="website" property="og:type"/>
<!-- Twitter Card Meta Tags -->
<meta content="summary_large_image" name="twitter:card"/>
<meta content="Task Monsters - RPG Productivity Game" name="twitter:title"/>
<meta content="A fun task management app with Jerry the Rock, your virtual pet companion" name="twitter:description"/>
<meta content="assets/images/icon-512x512.png" name="twitter:image"/>

<style>
        :root {
    /* Daily Challenge complete color */
    --challenge-complete: #ccff00; /* neon green-yellow */

            /* Quick Task action button background token */
            --quick-action-bg: #ffffff;
            /* Daily Challenge (scoped) */
            --daily-card-purple: linear-gradient(135deg, #6366f1 0%, #8b5cf6 100%);
            --daily-card-green:  linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            --daily-card-orange-gradient: linear-gradient(135deg, #ea580c 0%, #f59e0b 100%);
            --daily-card-pink: linear-gradient(135deg, #ec4899 0%, #f472b6 100%);
            --daily-card-blue: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            --daily-card-teal: linear-gradient(135deg, #14b8a6 0%, #2dd4bf 100%);
            --daily-card-red: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            --daily-card-yellow: linear-gradient(135deg, #eab308 0%, #facc15 100%);
        
            /* Dark theme colors (default and only) */
            --bg-primary: #f8f9fa;
            --bg-secondary: white;
            --bg-tertiary: #e0e0e0;
            --text-primary: #333;
            --text-secondary: #666;
            --text-tertiary: #999;
            --border-color: #e0e0e0;
            --shadow-color: rgba(0, 0, 0, 0.1);
            --modal-overlay: rgba(0, 0, 0, 0.5);
            --scrollbar-track: #f9fafb;
            --scrollbar-thumb: #d1d5db;
            --scrollbar-thumb-hover: #9ca3af;
            --health-bar-bg: #e0e0e0;
            --section-bg: white;
            --task-item-bg: white;
            --button-hover-bg: #f0f0f0;
            --congrats-bg: white;
            --achievement-locked-bg: #f5f5f5;
            --achievement-locked-text: #999;
            
            /* Modern additions */
            --accent-primary: #6366f1;
            --accent-secondary: #7c3aed;
            --accent-tertiary: #8b5cf6;
            --border-light: #e8eaed;
            --border-medium: #dadce0;
            --border-dark: #c4c7cc;
            --success: #34d399;
            --warning: #fbbf24;
            --error: #f87171;
            --info: #60a5fa;
            --shadow-sm: 0 1px 2px 0 rgba(0, 0, 0, 0.05);
            --shadow-md: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
            --shadow-lg: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05);
            --shadow-xl: 0 20px 25px -5px rgba(0, 0, 0, 0.1), 0 10px 10px -5px rgba(0, 0, 0, 0.04);
            --radius-sm: 8px;
            --radius-md: 12px;
            --radius-lg: 16px;
            --radius-xl: 20px;
            --radius-full: 9999px;
            --transition-fast: 0.15s ease-out;
            --transition-normal: 0.25s ease-out;
            --transition-slow: 0.35s ease-out;
        }

        [data-theme="dark"] {
            --quick-action-bg: #0f1611;
            /* Dark theme colors (Task Rock dark per screenshot) */
            --bg-primary: #101712;
            --bg-secondary: #101712;
            --bg-tertiary: #101712;
            --text-primary: #ffffff;
            --text-secondary: #cccccc;
            --text-tertiary: #999999;
            --border-color: #404040;
            --shadow-color: rgba(0, 0, 0, 0.3);
            --modal-overlay: rgba(0, 0, 0, 0.7);
            --accent-primary: #6366f1;
            --accent-secondary: #7c3aed;
            --accent-tertiary: #8b5cf6;
            --border-light: #223127;
            --border-medium: #1b271f;
            --border-dark: #132018;
            --scrollbar-track: #2d2d2d;
            --scrollbar-thumb: #555555;
            --scrollbar-thumb-hover: #777777;
            --health-bar-bg: #404040;
            --section-bg: #101712;
            --task-item-bg: #101712;
            --button-hover-bg: #1a241d;
            --congrats-bg: #101712;
            --achievement-locked-bg: #333333;
            --achievement-locked-text: #666666;
            --border-light: #374151;
            --border-medium: #4b5563;
            --border-dark: #6b7280;
            --shadow-sm: 0 1px 2px 0 rgba(255, 255, 255, 0.03);
            --shadow-md: 0 4px 6px -1px rgba(255, 255, 255, 0.06), 0 2px 4px -1px rgba(255, 255, 255, 0.04);
            --shadow-lg: 0 10px 15px -3px rgba(255, 255, 255, 0.06), 0 4px 6px -2px rgba(255, 255, 255, 0.03);
            --shadow-xl: 0 20px 25px -5px rgba(255, 255, 255, 0.06), 0 10px 10px -5px rgba(255, 255, 255, 0.03);
        }

        /* Speech bubble removed - replaced with tooltip system */

        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        body {
            font-family: 'SF Pro Rounded', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            background: var(--bg-primary);
            color: var(--text-primary);
            line-height: 1.6;
            -webkit-font-smoothing: antialiased;
            -moz-osx-font-smoothing: grayscale;
            overflow-x: hidden;
        }

        .app-container {
            max-width: 420px;
            margin: 0 auto;
            background: var(--bg-secondary);
            min-height: 100vh;
            position: relative;
            box-shadow: var(--shadow-xl);
        }

        /* Pet Rock Header with Theme Background */
        .pet-rock-header {
            background: var(--bg-secondary);
            padding: 24px 20px;
            text-align: center;
            position: relative;
            border-bottom: 1px solid var(--border-light);
        }

        /* Brand logo styling */
        .app-title {
            display: flex;
            align-items: center;
            justify-content: center;
            margin: 0 0 16px;
        }

        .brand-logo {
            height: 60px;
            width: auto;
            display: block;
            margin: 0 auto;
        }

        .brand-logo.dark {
            display: none;
        }

        @media (min-width: 640px) {
            .brand-logo {
                height: 80px;
            }
        }

        [data-theme="dark"] .brand-logo.light {
            display: none;
        }

        [data-theme="dark"] .brand-logo.dark {
            display: block;
        }

        .creature-container {
            position: relative;
            margin: 0;
            display: flex;
            flex-direction: column;
            align-items: center;
        }

        /* Task Pal Tooltip */
        .task-pal-tooltip {
            position: absolute;
            top: 85%;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(30, 30, 30, 0.95);
            color: white;
            font-size: 0.9rem;
            padding: 12px 16px;
            border-radius: 12px;
            text-align: center;
            white-space: nowrap;
            max-width: none;
            pointer-events: auto;
            opacity: 0;
            transition: opacity 0.3s ease;
            display: none;
            z-index: 100;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .task-pal-tooltip.visible {
            display: block;
            opacity: 1;
        }
        
        .mood-options {
            display: flex;
            gap: 12px;
            justify-content: center;
            margin-top: 8px;
        }
        
        .mood-options button {
            background: rgba(255, 255, 255, 0.1);
            border: 2px solid rgba(255, 255, 255, 0.2);
            border-radius: 8px;
            font-size: 28px;
            width: 50px;
            height: 50px;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            justify-content: center;
        }
        
        .mood-options button:hover {
            background: rgba(255, 255, 255, 0.2);
            border-color: rgba(255, 255, 255, 0.4);
            transform: scale(1.1);
        }
        
        .mood-options button:active {
            transform: scale(0.95);
        }

        .creature-image {
            width: 200px;
            height: 200px;
            margin: 0 auto 12px;
            display: block;
            border-radius: 20px;
            object-fit: contain;
            background: transparent;
            transition: transform var(--transition-normal);
        }

        .creature-image:hover {
            transform: scale(1.05);
        }

        .name-edit-wrap {
            width: 100%;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
        }

        .creature-name {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            cursor: pointer;
            transition: color 0.2s ease;
            color: var(--text-primary);
            text-align: center;
        }

        .creature-name:hover {
            color: #007AFF;
        }

        .edit-name-btn {
            display: inline-flex;
            align-items: center;
            justify-content: center;
            background: transparent;
            border: none;
            padding: 0;
            margin: 0;
            cursor: pointer;
            font-size: 16px;
            line-height: 1;
            opacity: 0.8;
            transition: opacity var(--transition-fast);
        }

        .edit-name-btn:hover {
            opacity: 1;
        }

        .creature-name-input {
            font-size: 24px;
            font-weight: bold;
            margin-bottom: 15px;
            border: none;
            background: transparent;
            text-align: center;
            outline: none;
            border-bottom: 2px solid #007AFF;
            font-family: 'SF Pro Rounded', -apple-system, BlinkMacSystemFont, 'SF Pro Display', 'SF Pro Text', 'Helvetica Neue', Helvetica, Arial, sans-serif;
            color: var(--text-primary);
        }

        .health-bar-container {
            margin-bottom: 15px;
            width: 100%;
            max-width: 300px;
            margin-left: auto;
            margin-right: auto;
        }

        .health-bar {
            width: 100%;
            height: 20px;
            background: var(--health-bar-bg);
            border-radius: 10px;
            overflow: hidden;
            margin-bottom: 5px;
            transition: background-color 0.3s ease;
        }

        .health-fill {
            height: 100%;
            background: linear-gradient(90deg, #ff4444 0%, #ffaa00 50%, #44ff44 100%);
            border-radius: 10px;
            transition: width 0.3s ease;
        }

        .health-text {
            font-size: 14px;
            color: var(--text-secondary);
        }

        .task-points {
            background: #007AFF;
            color: white;
            padding: 8px 16px;
            border-radius: 50px;
            font-weight: 400;
            display: inline-block;
        }

        /* Loading Screen */
        .loading-screen {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-primary);
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            transition: opacity 0.5s ease;
        }

        .loading-screen.hidden {
            opacity: 0;
            pointer-events: none;
            display: none !important;
        }

        .loading-brand {
            height: 80px;
            margin-bottom: 20px;
        }

        .loading-spinner {
            width: 40px;
            height: 40px;
            border: 3px solid var(--border-light);
            border-top: 3px solid var(--accent-primary);
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 16px;
        }

        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }

        .loading-text {
            color: var(--text-secondary);
            font-size: 14px;
        }

        /* Success Message */
        .success-message {
            position: fixed;
            bottom: 20px;
            left: 50%;
            transform: translateX(-50%);
            background: #2d2d2d;
            color: white;
            padding: 16px 20px;
            border-radius: 20px;
            font-weight: 600;
            font-size: 16px;
            z-index: 1000;
            box-shadow: 0 8px 24px rgba(0, 0, 0, 0.3);
            white-space: pre-line;
            text-align: left;
            max-width: calc(100vw - 40px);
            word-wrap: break-word;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .success-message-emoji {
            font-size: 40px;
            flex-shrink: 0;
        }
        
        .success-message-content {
            display: flex;
            flex-direction: column;
            gap: 4px;
            flex: 1;
            min-width: 0;
            overflow: hidden;
        }
        
        .success-message-title {
            font-size: 18px;
            font-weight: 700;
            line-height: 1.2;
            overflow: hidden;
            text-overflow: ellipsis;
            display: -webkit-box;
            -webkit-line-clamp: 2;
            -webkit-box-orient: vertical;
        }
        
        .success-message-subtitle {
            font-size: 14px;
            opacity: 0.9;
            font-weight: 400;
            overflow: hidden;
            text-overflow: ellipsis;
            white-space: nowrap;
        }
        
        /* Responsive adjustments for small screens */
        @media (max-width: 480px) {
            .success-message {
                padding: 14px 16px;
                gap: 10px;
                max-width: calc(100vw - 24px); /* Wider on mobile */
                min-width: calc(100vw - 24px); /* Force wider */
                bottom: 16px;
            }
            
            .success-message-emoji {
                font-size: 36px;
            }
            
            .success-message-title {
                font-size: 16px;
            }
            
            .success-message-subtitle {
                font-size: 13px;
            }
        }
        
        @media (max-width: 360px) {
            .success-message {
                padding: 12px 14px;
                gap: 8px;
                max-width: calc(100vw - 20px); /* Even wider on very small screens */
                min-width: calc(100vw - 20px); /* Force wider */
            }
            
            .success-message-emoji {
                font-size: 32px;
            }
            
            .success-message-title {
                font-size: 15px;
            }
            
            .success-message-subtitle {
                font-size: 12px;
            }
        }

        /* Task Rock: Budget-look reskin (scoped) */
        #plannerSection {
            margin-top: 12px;
            padding-bottom: 100px; /* Space for FAB */
        }

        /* Expandable Stats Section */
        #plannerSection .stats-section {
            margin: 0 16px 16px;
            background: var(--section-bg);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        #plannerSection .stats-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid var(--border-light);
        }

        #plannerSection .stats-header:hover {
            background: var(--button-hover-bg);
        }

        #plannerSection .stats-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        #plannerSection .stats-toggle {
            font-size: 14px;
            color: var(--text-secondary);
            transition: transform 0.2s ease;
        }

        #plannerSection .stats-toggle.expanded {
            transform: rotate(180deg);
        }

        /* Daily Challenge Expandable Section */
        #plannerSection .daily-challenge-section {
            margin: 0 16px 16px;
            background: var(--section-bg);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            box-shadow: var(--shadow-sm);
            overflow: hidden;
        }

        #plannerSection .daily-challenge-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 20px;
            cursor: pointer;
            transition: background-color 0.2s ease;
            border-bottom: 1px solid var(--border-light);
        }

        #plannerSection .daily-challenge-header:hover {
            background: var(--button-hover-bg);
        }

        #plannerSection .daily-challenge-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
        }

        #plannerSection .daily-challenge-toggle {
            font-size: 14px;
            color: var(--text-secondary);
            transition: transform 0.2s ease;
        }

        #plannerSection .daily-challenge-toggle.expanded {
            transform: rotate(180deg);
        }

        #plannerSection .daily-challenge-content {
            padding: 16px 20px;
        }

        /* Daily Challenge Card Styling */
        .daily-challenge-card {
            background: var(--daily-card-purple);
            border-radius: 16px;
            padding: 20px;
            color: white;
            text-align: center;
            transition: all 0.4s ease;
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .challenge-empty-state {
            background: var(--daily-card-purple);
            background-blend-mode: overlay;
            border-radius: 16px;
            padding: 40px 24px;
            color: white;
            text-align: center;
            animation: fadeIn 0.4s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .challenge-empty-icon {
            font-size: 32px;
            margin-bottom: 8px;
            line-height: 1;
        }
        
        .challenge-empty-title {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            line-height: 1.3;
        }
        
        .challenge-empty-desc {
            font-size: 15px;
            opacity: 0.95;
            font-weight: 400;
            line-height: 1.4;
        }

        .challenge-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .challenge-desc {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 16px;
        }

        .challenge-progress-container {
            margin-bottom: 12px;
        }

        .challenge-progress-label {
            font-size: 12px;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .challenge-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .challenge-progress-fill {
            height: 100%;
            background: var(--accent-tertiary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .challenge-reward {
            font-size: 12px;
            opacity: 0.8;
        }

        .challenge-completed {
            background: var(--daily-card-green) !important;
        }

        /* Collapsed stats: 3 cards in a row */
        #plannerSection .stats-row {
            display: grid;
            gap: 8px;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            padding: 12px 16px;
        }

        @media (max-width: 900px) {
            #plannerSection .stats-row {
                grid-template-columns: repeat(3, minmax(0, 1fr));
                gap: 6px;
            }
        }

        @media (max-width: 320px) {
            #plannerSection .stats-row {
                grid-template-columns: repeat(3, minmax(0, 1fr));
                gap: 4px;
                padding: 8px 12px;
            }
        }

        /* Expanded stats: Grid layout like the screenshot */
        #plannerSection .stats-grid {
            display: grid;
            gap: 12px;
            grid-template-columns: repeat(3, minmax(0, 1fr));
            padding: 16px;
        }

        @media (max-width: 900px) {
            #plannerSection .stats-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr)); /* Maintain 3 columns */
                gap: 8px;
                padding: 12px;
            }
        }

        @media (max-width: 520px) {
            #plannerSection .stats-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr)); /* Maintain 3 columns */
                gap: 6px;
                padding: 10px;
            }
        }

        @media (max-width: 400px) {
            #plannerSection .stats-grid {
                grid-template-columns: repeat(3, minmax(0, 1fr)); /* Maintain 3 columns */
                gap: 4px;
                padding: 8px;
            }
            #plannerSection .stat-tile {
                padding: 6px 3px; /* Reduced padding for stat tiles */
                border-radius: 8px;
                gap: 1px;
            }
            #plannerSection .stat-icon {
                font-size: 9px; /* Reduced icon size */
            }
            #plannerSection .stat-value {
                font-size: 9px; /* Reduced value font size */
            }
            #plannerSection .stat-label {
                font-size: 5px; /* Reduced label font size */
                min-height: 9px;
            }
        }

        #plannerSection .stat-tile {
            background: var(--bg-secondary);
            border: none; /* Remove border in light mode */
            border-radius: 12px;
            padding: 16px 12px;
            text-align: center;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.08), 0 1px 4px rgba(0, 0, 0, 0.04);
            transition: transform 0.2s ease, box-shadow 0.2s ease, border-color 0.3s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 3px;
            aspect-ratio: 1;
            justify-content: center;
            min-height: 0;
            overflow: hidden;
        }

        @media (max-width: 400px) {
            #plannerSection .stat-tile {
                padding: 10px 6px; /* Reduced padding */
                border-radius: 10px;
                gap: 2px;
            }
            #plannerSection .stat-icon {
                font-size: 12px; /* Reduced icon size */
            }
            #plannerSection .stat-value {
                font-size: 11px; /* Reduced value font size */
            }
            #plannerSection .stat-label {
                font-size: 7px; /* Reduced label font size */
                min-height: 12px;
            }
        }

        @media (max-width: 320px) {
            #plannerSection .stat-tile {
                padding: 6px 3px; /* Further reduced padding */
                border-radius: 8px;
                gap: 1px;
            }
            #plannerSection .stat-icon {
                font-size: 9px; /* Further reduced icon size */
            }
            #plannerSection .stat-value {
                font-size: 9px; /* Further reduced value font size */
            }
            #plannerSection .stat-label {
                font-size: 5px; /* Further reduced label font size */
                min-height: 9px;
            }
        }

        /* Dark mode enhanced borders */
        [data-theme="dark"] #plannerSection .stat-tile {
            border: 1px solid rgba(255, 255, 255, 0.1); /* Keep border in dark mode */
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.3), 0 1px 4px rgba(0, 0, 0, 0.2);
        }

        /* Low completion rate warning */
        #plannerSection .stat-tile.low-completion {
            border-color: #ff4444;
            box-shadow: 0 0 20px rgba(255, 68, 68, 0.3), 0 2px 8px rgba(0, 0, 0, 0.08);
            animation: pulse-red 2s infinite;
        }

        [data-theme="dark"] #plannerSection .stat-tile.low-completion {
            border-color: #ff6666;
            box-shadow: 0 0 25px rgba(255, 102, 102, 0.4), 0 2px 8px rgba(0, 0, 0, 0.3);
        }

        @keyframes pulse-red {
            0%, 100% {
                box-shadow: 0 0 20px rgba(255, 68, 68, 0.3), 0 2px 8px rgba(0, 0, 0, 0.08);
            }
            50% {
                box-shadow: 0 0 30px rgba(255, 68, 68, 0.5), 0 2px 8px rgba(0, 0, 0, 0.08);
            }
        }

        [data-theme="dark"] @keyframes pulse-red {
            0%, 100% {
                box-shadow: 0 0 25px rgba(255, 102, 102, 0.4), 0 2px 8px rgba(0, 0, 0, 0.3);
            }
            50% {
                box-shadow: 0 0 35px rgba(255, 102, 102, 0.6), 0 2px 8px rgba(0, 0, 0, 0.3);
            }
        }

        #plannerSection .stat-tile:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.12), 0 2px 6px rgba(0, 0, 0, 0.08);
        }

        #plannerSection .stat-icon {
            font-size: 16px;
            margin-bottom: 0;
            flex-shrink: 0;
        }

        #plannerSection .stat-value {
            font-size: 14px;
            font-weight: 700;
            color: var(--text-primary);
            margin-bottom: 0;
            line-height: 1.1;
        }

        #plannerSection .stat-label {
            font-size: 9px;
            color: var(--text-secondary);
            font-weight: 500;
            text-align: center;
            line-height: 1.1;
            padding: 0 1px;
            white-space: nowrap;
            word-break: keep-all;
            overflow-wrap: break-word;
            hyphens: none;
            max-width: 100%;
            min-height: 16px;
            display: flex;
            align-items: center;
            justify-content: center;
        }

        @media (max-width: 400px) {
            #plannerSection .stat-icon {
                font-size: 14px;
            }
            
            #plannerSection .stat-value {
                font-size: 12px;
            }
            
            #plannerSection .stat-label {
                font-size: 8px;
                min-height: 14px;
            }
        }

        @media (max-width: 320px) {
            #plannerSection .stat-icon {
                font-size: 12px;
            }
            
            #plannerSection .stat-value {
                font-size: 11px;
            }
            
            #plannerSection .stat-label {
                font-size: 7px;
                min-height: 12px;
                padding: 0;
            }
        }

        /* Improved Pill Tab Navigation CSS */
        /* Pill tab bar - Enhanced container */
        #plannerSection .pill-tabs {
            display: flex;
            gap: 6px;
            margin: 0 16px 16px;
            padding: 6px;
            border-radius: 20px;
            background: var(--section-bg);
            box-shadow: var(--shadow-sm);
            justify-content: space-between;
            align-items: center;
            position: relative;
        }

        /* Individual pill tab buttons - Improved spacing and alignment */
        #plannerSection .pill-tab {
            padding: 12px 10px;
            border-radius: 16px;
            font-weight: 600;
            font-size: 14px;
            border: 0;
            background: transparent;
            cursor: pointer;
            color: var(--text-secondary);
            transition: all 0.2s ease;
            flex: 0 1 auto;
            text-align: center;
            white-space: nowrap;
            display: flex;
            align-items: center;
            justify-content: center;
            min-width: 0;
            line-height: 1.2;
            position: relative;
            overflow: hidden;
            text-overflow: ellipsis;
            max-width: fit-content;
        }

        /* Selected tab state - Enhanced visual prominence */
        #plannerSection .pill-tab[aria-selected="true"] {
            background: var(--accent-primary);
            color: #000000;
            font-weight: 700;
            padding: 12px 12px;
            transform: scale(1.02);
            box-shadow: 0 2px 8px rgba(208, 255, 0, 0.3);
        }

        /* Hover state for unselected tabs */
        #plannerSection .pill-tab:hover:not([aria-selected="true"]) {
            background: var(--button-hover-bg);
            color: var(--text-primary);
        }

        /* Generic card shell */
        #plannerSection .card {
            background: var(--section-bg);
            border: 1px solid var(--border-light);
            border-radius: 20px;
            padding: 20px;
            margin: 0 16px 16px;
            box-shadow: var(--shadow-sm);
        }

        #plannerSection .card-header {
            display: flex;
            align-items: center;
            justify-content: space-between;
            margin-bottom: 16px;
        }

        #plannerSection .card-title {
            font-size: 18px;
            font-weight: 700;
            color: var(--text-primary);
        }

        /* Tab content */
        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
        }

        /* Centered FAB (create task) */
        #plannerSection .fab-center {
            position: fixed;
            left: 50%;
            transform: translateX(-50%);
            bottom: 24px;
            width: 56px;
            height: 56px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            box-shadow: var(--shadow-lg);
            z-index: 500;
            background: var(--accent-primary);
            color: #000000;
            border: none;
            font-size: 24px;
            font-weight: 700;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        #plannerSection .fab-center:hover {
            transform: translateX(-50%) scale(1.1);
        }

        /* Task Cards */
        .task-card {
            /* Apply Quest Card styling structure with current colors */
            background: linear-gradient(135deg, #0a0f0d 0%, #101712 100%);
            border: 2px solid #374151;
            border-radius: 12px;
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: 0 2px 8px rgba(55, 65, 81, 0.2);
            transition: all 0.3s ease;
            position: relative;
            overflow: hidden;
        }

        .task-card:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(55, 65, 81, 0.4);
            border-color: #4b5563;
        }

        .task-header {
            display: flex;
            align-items: flex-start;
            gap: 12px;
            margin-bottom: 12px;
            position: relative;
        }

        .task-emoji {
            font-size: 20px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            flex-shrink: 0;
        }

        .task-content {
            flex: 1;
            min-width: 0;
        }

        .task-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .task-meta {
            font-size: 12px;
            color: var(--text-secondary);
            display: flex;
            align-items: center;
            gap: 8px;
            flex-wrap: wrap;
        }

        .task-due-date {
            display: inline-flex;
            align-items: center;
            gap: 3px;
            background: linear-gradient(135deg, #3b82f6 0%, #60a5fa 100%);
            color: #fff;
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            white-space: nowrap;
        }

        .task-due-date.warning {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: #fff;
            border: none;
        }

        .task-badge {
            padding: 3px 8px;
            border-radius: 10px;
            font-size: 10px;
            font-weight: 600;
            text-transform: uppercase;
            letter-spacing: 0.3px;
            white-space: nowrap;
        }

        .task-badge.priority-high {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: #fff;
        }

        .task-badge.priority-medium {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            color: #1a1410;
        }

        .task-badge.priority-low {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: #fff;
        }

        .task-badge.difficulty-hard {
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: #fff;
        }

        .task-badge.difficulty-medium {
            background: linear-gradient(135deg, #f59e0b 0%, #fbbf24 100%);
            color: #1a1410;
        }

        .task-badge.difficulty-easy {
            background: linear-gradient(135deg, #16a34a 0%, #22c55e 100%);
            color: #fff;
        }

        .task-actions {
            display: flex;
            gap: 4px;
            margin-top: 12px;
            justify-content: flex-end;
        }

        /* Edit Button - Purple Pill in Top-Right Corner */
        .task-edit-button {
            position: absolute;
            top: 12px;
            right: 12px;
            background: linear-gradient(135deg, #5b21b6 0%, #7c3aed 100%);
            border: none;
            border-radius: 20px;
            cursor: pointer;
            padding: 6px 12px;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: all 0.2s ease;
            z-index: 10;
            box-shadow: 0 2px 6px rgba(124, 58, 237, 0.3);
            font-size: 16px;
        }

        .task-edit-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 3px 10px rgba(124, 58, 237, 0.5);
        }

        .task-edit-button::before {
            content: '✏️';
        }

        /* Delete Button - Style like "Abandon Quest" */
        .task-delete-button {
            padding: 8px 16px;
            background: linear-gradient(135deg, #dc2626 0%, #ef4444 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            align-items: center;
            gap: 6px;
        }

        .task-delete-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(220, 38, 38, 0.4);
        }

        .task-delete-button::before {
            content: '🗑️';
        }

        /* Complete Button - Keep at Bottom with Gradient */
        .task-complete-button {
            padding: 8px 16px;
            background: linear-gradient(135deg, #4c1d95 0%, #6366f1 100%);
            color: #fff;
            border: none;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
            flex: 1;
        }

        .task-complete-button:hover {
            transform: translateY(-1px);
            box-shadow: 0 2px 8px rgba(99, 102, 241, 0.4);
        }

        .btn-primary {
            background: var(--accent-primary);
            color: #000000;
            border: none;
            border-radius: 8px;
            padding: 8px 16px;
            font-size: 14px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s ease;
        }

        .btn-primary:hover {
            background: var(--accent-secondary);
            transform: translateY(-1px);
        }

        .btn-secondary {
            background: var(--bg-tertiary);
            color: var(--text-primary);
            border: 1px solid var(--border-color);
            padding: 10px 20px;
            border-radius: 8px;
            font-size: 14px;
            font-weight: 500;
            cursor: pointer;
            transition: all 0.2s ease;
            min-width: 80px;
        }

        .btn-secondary:hover {
            background: var(--button-hover-bg);
            transform: translateY(-1px);
        }

        /* Quick Tasks */
        .quick-task-item {
            background: var(--task-item-bg);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            transition: all var(--transition-fast);
            display: flex;
            align-items: center;
            gap: 12px;
            cursor: pointer;
        }

        .quick-task-item:hover {
            transform: translateY(-1px);
            box-shadow: var(--shadow-md);
        }

        .quick-task-emoji {
            font-size: 20px;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            flex-shrink: 0;
        }

        .quick-task-content {
            flex: 1;
            min-width: 0;
        }

        .quick-task-title {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .quick-task-category {
            font-size: 12px;
            color: var(--text-secondary);
        }

        .quick-task-points {
            font-size: 10px;
            font-weight: 600;
            color: white;
            background: #007AFF;
            padding: 3px 6px;
            border-radius: 6px;
            margin-right: 8px;
            white-space: nowrap;
        }

        .quick-task-actions {
            display: flex;
            gap: 4px;
        }

        .action-btn {
            width: 32px;
            height: 32px;
            border: none;
            border-radius: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            cursor: pointer;
            transition: all 0.2s ease;
            font-size: 16px;
        }

        .action-complete {
            background: var(--success);
            color: white;
        }

        .action-complete:hover {
            background: #059669;
        }

        .action-remove {
            background: var(--error);
            color: white;
        }

        .action-remove:hover {
            background: #dc2626;
        }

        /* Daily Challenge */
        .daily-challenge-card {
            background: var(--daily-card-purple);
            border-radius: 16px;
            padding: 20px;
            color: white;
            text-align: center;
            transition: all 0.4s ease;
            animation: fadeIn 0.4s ease;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .challenge-empty-state {
            background: var(--daily-card-purple);
            background-blend-mode: overlay;
            border-radius: 16px;
            padding: 40px 24px;
            color: white;
            text-align: center;
            animation: fadeIn 0.4s ease;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.3);
        }
        
        .challenge-empty-icon {
            font-size: 32px;
            margin-bottom: 8px;
            line-height: 1;
        }
        
        .challenge-empty-title {
            font-size: 18px;
            font-weight: 700;
            letter-spacing: 0.5px;
            margin-bottom: 10px;
            line-height: 1.3;
        }
        
        .challenge-empty-desc {
            font-size: 15px;
            opacity: 0.95;
            font-weight: 400;
            line-height: 1.4;
        }

        .challenge-title {
            font-size: 18px;
            font-weight: 700;
            margin-bottom: 8px;
        }

        .challenge-desc {
            font-size: 14px;
            opacity: 0.9;
            margin-bottom: 16px;
        }

        .challenge-progress-container {
            margin-bottom: 12px;
        }

        .challenge-progress-label {
            font-size: 12px;
            margin-bottom: 8px;
            opacity: 0.8;
        }

        .challenge-progress-bar {
            width: 100%;
            height: 8px;
            background: rgba(255, 255, 255, 0.2);
            border-radius: 4px;
            overflow: hidden;
        }

        .challenge-progress-fill {
            height: 100%;
            background: var(--accent-tertiary);
            border-radius: 4px;
            transition: width 0.3s ease;
        }

        .challenge-reward {
            font-size: 12px;
            opacity: 0.8;
        }

        .challenge-completed {
            background: var(--daily-card-green) !important;
        }

        /* Achievements */
        .achievement-card {
            background: var(--task-item-bg);
            border-radius: var(--radius-lg);
            padding: 16px;
            margin-bottom: 12px;
            box-shadow: var(--shadow-sm);
            border: 1px solid var(--border-light);
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .achievement-card.unlocked {
            border-color: var(--success);
            background: rgba(52, 211, 153, 0.05);
        }

        .achievement-card.locked {
            opacity: 0.6;
        }

        .achievement-icon {
            font-size: 24px;
            width: 40px;
            height: 40px;
            display: flex;
            align-items: center;
            justify-content: center;
            background: var(--bg-tertiary);
            border-radius: var(--radius-md);
            flex-shrink: 0;
        }

        .achievement-content {
            flex: 1;
            min-width: 0;
        }

        .achievement-name {
            font-size: 16px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 2px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .achievement-desc {
            font-size: 12px;
            color: var(--text-secondary);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .achievement-status {
            font-size: 12px;
            font-weight: 600;
            padding: 4px 8px;
            border-radius: 8px;
        }

        .achievement-status.unlocked {
            background: var(--success);
            color: white;
        }

        .achievement-status.locked {
            background: var(--bg-tertiary);
            color: var(--text-secondary);
        }

        /* Shop Items */
        .owned-badge {
            background: rgba(76, 175, 80, 0.2);
            color: #4CAF50;
            padding: 4px 8px;
            border-radius: 12px;
            font-size: 11px;
            font-weight: 600;
            margin-top: 4px;
            text-align: center;
        }
        
        .shop-item-desc {
            font-size: 11px;
            color: var(--text-secondary);
            margin-top: 4px;
            line-height: 1.3;
        }
        
        .shop-grid {
            display: flex;
            overflow-x: auto;
            gap: 16px;
            margin-top: 16px;
            margin-bottom: 24px;
            padding-bottom: 8px;
            scroll-behavior: smooth;
            -webkit-overflow-scrolling: touch;
        }

        .shop-grid::-webkit-scrollbar {
            height: 6px;
        }

        .shop-grid::-webkit-scrollbar-track {
            background: var(--scrollbar-track);
            border-radius: 3px;
        }

        .shop-grid::-webkit-scrollbar-thumb {
            background: var(--scrollbar-thumb);
            border-radius: 3px;
        }

        .shop-grid::-webkit-scrollbar-thumb:hover {
            background: var(--scrollbar-thumb-hover);
        }

        .shop-item {
            background: var(--task-item-bg);
            border: 1px solid var(--border-light);
            border-radius: 16px;
            padding: 16px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: space-between;
            min-height: 140px;
            min-width: 120px;
            flex-shrink: 0;
        }

        .shop-item:hover {
            transform: translateY(-2px);
            box-shadow: var(--shadow-md);
        }

        .shop-item.equipped {
            border: 2px solid #A5F247;
            box-shadow: 0 0 0 2px rgba(165, 242, 71, 0.35), 0 6px 18px rgba(165, 242, 71, 0.20);
        }

        .shop-item.owned {
            /* No special border for owned but unequipped items */
        }

        .shop-item.expensive {
            opacity: 0.6;
        }

        .shop-item-emoji {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .shop-item-image {
            max-width: 60px;
            height: auto;
            margin-bottom: 8px;
        }

        .shop-item-name {
            font-size: 14px;
            font-weight: 600;
            color: var(--text-primary);
            margin-bottom: 4px;
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        .shop-item-price {
            font-size: 12px;
            color: var(--text-secondary);
            word-wrap: break-word;
            overflow-wrap: break-word;
        }

        /* Settings */
        .settings-item {
            display: flex;
            align-items: center;
            justify-content: space-between;
            padding: 16px 0;
            border-bottom: 1px solid var(--border-light);
        }

        .settings-item:last-child {
            border-bottom: none;
        }

        .settings-label {
            font-size: 16px;
            font-weight: 500;
            color: var(--text-primary);
        }

        .settings-toggle {
            width: 50px;
            height: 28px;
            background: var(--bg-tertiary);
            border-radius: 14px;
            position: relative;
            cursor: pointer;
            transition: background-color 0.2s ease;
        }

        .settings-toggle.active {
            background: var(--accent-primary);
        }

        .settings-toggle-slider {
            width: 24px;
            height: 24px;
            background: white;
            border-radius: 50%;
            position: absolute;
            top: 2px;
            left: 2px;
            transition: transform 0.2s ease;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        .settings-toggle.active .settings-toggle-slider {
            transform: translateX(22px);
        }

        /* Modal Styles */
        .modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--modal-overlay);
            z-index: 2000;
            backdrop-filter: blur(4px);
        }

        .modal.active {
            display: flex;
            align-items: center;
            justify-content: center;
            padding: 20px;
        }

        .modal-content {
            background: var(--bg-secondary);
            border-radius: 20px;
            width: 100%;
            max-width: 400px;
            max-height: 80vh;
            position: relative;
            display: flex;
            flex-direction: column;
            overflow: hidden;
        }

        .modal-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 24px 24px 0;
            margin-bottom: 20px;
        }

        .modal-title {
            font-size: 20px;
            font-weight: 600;
            color: var(--text-primary);
        }

        .modal-close {
            background: none;
            border: none;
            font-size: 24px;
            color: var(--text-secondary);
            cursor: pointer;
            padding: 0;
            width: 32px;
            height: 32px;
            display: flex;
            align-items: center;
            justify-content: center;
            border-radius: 8px;
            transition: all 0.2s ease;
        }

        .modal-close:hover {
            background: var(--button-hover-bg);
            color: var(--text-primary);
        }

        .modal-body {
            padding: 0 24px;
            overflow-y: auto;
            flex: 1;
        }

        .modal-footer {
            padding: 16px 24px 24px;
            background: var(--bg-secondary);
            border-top: 1px solid var(--border-light);
            position: sticky;
            bottom: 0;
        }

        /* Form Styles */
        .form-group {
            margin-bottom: 20px;
        }

        .form-label {
            display: block;
            font-weight: 500;
            color: var(--text-primary);
            margin-bottom: 8px;
            font-size: 14px;
        }

        .form-input,
        .form-select,
        .form-textarea {
            width: 100%;
            padding: 12px 16px;
            border: 2px solid var(--border-light);
            border-radius: 12px;
            font-size: 16px;
            transition: all 0.2s ease;
            background: var(--bg-secondary);
            color: var(--text-primary);
            font-family: inherit;
        }

        .form-input:focus,
        .form-select:focus,
        .form-textarea:focus {
            outline: none;
            border-color: var(--accent-tertiary);
            box-shadow: 0 0 0 3px rgba(160, 204, 0, 0.1);
        }

        .form-textarea {
            resize: vertical;
            min-height: 80px;
        }

        /* Dark mode datetime-local calendar icon fix */
        [data-theme="dark"] input[type="datetime-local"]::-webkit-calendar-picker-indicator,
        [data-theme="dark"] .form-input[type="datetime-local"]::-webkit-calendar-picker-indicator,
        [data-theme="dark"] #taskDueDate::-webkit-calendar-picker-indicator {
            filter: invert(1) !important;
            cursor: pointer;
            opacity: 1 !important;
        }

        /* Light mode - ensure icon is black */
        [data-theme="light"] input[type="datetime-local"]::-webkit-calendar-picker-indicator,
        [data-theme="light"] .form-input[type="datetime-local"]::-webkit-calendar-picker-indicator,
        [data-theme="light"] #taskDueDate::-webkit-calendar-picker-indicator,
        input[type="datetime-local"]::-webkit-calendar-picker-indicator {
            filter: none !important;
            cursor: pointer;
            opacity: 1 !important;
        }

        /* For Firefox */
        [data-theme="dark"] input[type="datetime-local"],
        [data-theme="dark"] .form-input[type="datetime-local"],
        [data-theme="dark"] #taskDueDate {
            color-scheme: dark;
        }

        [data-theme="light"] input[type="datetime-local"],
        [data-theme="light"] .form-input[type="datetime-local"],
        [data-theme="light"] #taskDueDate {
            color-scheme: light;
        }

        .selection-grid {
            display: grid;
            grid-template-columns: repeat(3, 1fr);
            gap: 8px;
            margin-top: 8px;
        }

        @media (max-width: 420px) {
            .selection-grid {
                grid-template-columns: repeat(2, 1fr);
            }
        }

        .selection-item {
            background: var(--bg-secondary);
            border: 2px solid var(--border-light);
            border-radius: 12px;
            padding: 12px 8px;
            text-align: center;
            cursor: pointer;
            transition: all 0.2s ease;
            min-height: 80px;
            display: flex;
            flex-direction: column;
            align-items: center;
            justify-content: center;
            gap: 4px;
        }

        .selection-item:hover {
            border-color: var(--accent-tertiary);
            background: rgba(160, 204, 0, 0.05);
        }

        .selection-item.selected {
            border-color: var(--accent-primary);
            background: var(--accent-primary);
            color: #000000;
            font-weight: 600;
        }

        .selection-item-emoji {
            font-size: 20px;
            margin-bottom: 4px;
        }

        .selection-item-text {
            font-size: 12px;
            font-weight: 500;
            word-wrap: break-word;
            overflow-wrap: break-word;
            text-align: center;
        }

        /* Empty States */
        .empty-state {
            text-align: center;
            padding: 40px 20px;
            color: var(--text-secondary);
        }

        .empty-state-icon {
            font-size: 48px;
            margin-bottom: 16px;
        }

        .empty-state-text {
            font-size: 16px;
            margin-bottom: 8px;
            color: var(--text-primary);
        }

        .empty-state-subtext {
            font-size: 14px;
            opacity: 0.8;
        }

        /* Responsive adjustments */
        @media (max-width: 480px) {
            .app-container {
                max-width: 100%;
            }

            #plannerSection .card {
                margin: 0 12px 12px;
                padding: 16px;
            }

            #plannerSection .stats-row {
                margin: 0 12px 12px;
            }

            #plannerSection .pill-tabs {
                margin: 0 12px 12px;
                padding: 5px;
                gap: 4px;
            }
            
            #plannerSection .pill-tab {
                padding: 10px 8px;
                font-size: 13px;
            }
            
            #plannerSection .pill-tab[aria-selected="true"] {
                padding: 12px 10px;
            }

            .task-title,
            .quick-task-title,
            .achievement-name {
                font-size: 15px;
            }

            .shop-grid {
                gap: 12px;
            }
        }

        /* Ensure text never overflows containers */
        .task-title,
        .quick-task-title,
        .achievement-name,
        .shop-item-name,
        .challenge-title,
        .challenge-desc {
            word-wrap: break-word;
            overflow-wrap: break-word;
            hyphens: auto;
            max-width: 100%;
        }

        /* Prevent horizontal scroll */
        body,
        html {
            overflow-x: hidden;
        }

        .app-container {
            overflow-x: hidden;
        }

    @keyframes hero-idle-anim {
      from { object-position: 0 0; }
      to { object-position: -128px 0; }
    }
    
    @keyframes hero-hurt-anim {
      from { object-position: 0 0; }
      to { object-position: -128px 0; }
    }
    
    @keyframes hero-jump-anim {
      from { object-position: 0 0; }
      to { object-position: -256px 0; }
    }

    /* Native datetime-local input styling is handled by browser */

    .btn-secondary {
        background: rgba(255, 255, 255, 0.1);
        border: 1px solid rgba(255, 255, 255, 0.2);
        color: #fff;
        padding: 12px 24px;
        border-radius: 8px;
        cursor: pointer;
        font-size: 16px;
        font-weight: 600;
        transition: all 0.2s;
    }

    .btn-secondary:hover {
        background: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }

    .modal-footer {
        display: flex;
        gap: 12px;
        justify-content: space-between;
    }
    
    /* Shop Sub-Tabs */
    .shop-sub-tabs {
        display: flex;
        gap: 8px;
        padding: 16px 20px;
        background: var(--card-bg);
        border-bottom: 1px solid rgba(255, 255, 255, 0.1);
    }

    .pill-tab-shop {
        padding: 8px 20px;
        border-radius: 20px;
        border: 1px solid rgba(255, 255, 255, 0.2);
        background: transparent;
        color: #999;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .pill-tab-shop.active {
        background: var(--primary);
        color: white;
        border-color: var(--primary);
    }

    .pill-tab-shop:hover:not(.active) {
        background: rgba(255, 255, 255, 0.05);
        color: #ccc;
    }

    /* Shop Sub-Tab Content */
    .shop-sub-content {
        display: none;
    }

    .shop-sub-content.active {
        display: block;
    }

    /* Shop Items Grid */
    .shop-items-grid {
        display: grid;
        grid-template-columns: repeat(2, 1fr); /* Always 2 columns */
        gap: 16px;
    }

    .shop-item-card {
        background: rgba(255, 255, 255, 0.05);
        border: 1px solid rgba(255, 255, 255, 0.1);
        border-radius: 12px;
        padding: 16px;
        text-align: center;
        transition: all 0.2s;
    }

    .shop-item-card:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }

    .shop-item-emoji {
        font-size: 36px;
        margin-bottom: 12px;
    }

    .shop-item-name {
        font-size: 16px;
        font-weight: 600;
        color: white;
        margin-bottom: 8px;
    }

    .shop-item-description {
        font-size: 12px;
        color: #999;
        margin-bottom: 12px;
        line-height: 1.4;
    }

    .shop-item-cost {
        font-size: 14px;
        font-weight: 600;
        color: #FFD700;
        margin-bottom: 12px;
    }

    .buy-now-btn {
        width: 100%;
        padding: 8px 16px;
        background: #1a1a1a;
        color: white;
        border: 1px solid rgba(255, 255, 255, 0.2);
        border-radius: 8px;
        font-size: 14px;
        font-weight: 500;
        cursor: pointer;
        transition: all 0.2s;
    }

    .buy-now-btn:hover {
        background: #2a2a2a;
        border-color: rgba(255, 255, 255, 0.3);
    }

        /* Owned Items Grid */
        .owned-item-card {
            background: var(--bg-secondary);
            border: 1px solid var(--border-color);
            border-radius: 12px;
            padding: 16px;
            display: flex;
            align-items: center;
            gap: 12px;
        }
        
        .owned-item-emoji {
            font-size: 32px;
            flex-shrink: 0;
        }
        
        .owned-item-info {
            flex: 1;
            min-width: 0;
        }
        
        .owned-item-name {
            font-weight: 600;
            font-size: 14px;
            color: var(--text-primary);
            margin-bottom: 4px;
        }
        
        .owned-item-quantity {
            font-size: 12px;
            color: var(--text-secondary);
        }
        
        .use-item-btn {
            background: var(--primary-color);
            color: white;
            border: none;
            padding: 8px 16px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.2s;
            flex-shrink: 0;
        }
        
        .use-item-btn:hover {
            transform: translateY(-2px);
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.15);
        }
        
        .use-item-btn.equipped {
            background: #4CAF50;
        }
        
        .owned-items-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
            gap: 16px;
            padding: 20px;
        }

    .owned-item-card {
        background: rgba(255, 255, 255, 0.05);
        border: 2px solid rgba(255, 255, 255, 0.1);
        border-radius: 16px;
        padding: 16px;
        text-align: center;
        transition: all 0.2s;
        position: relative;
    }

    .owned-item-card:hover {
        background: rgba(255, 255, 255, 0.08);
        border-color: rgba(255, 255, 255, 0.2);
        transform: translateY(-2px);
    }

    .owned-item-card.equipped {
        border-color: #00ff88;
        background: rgba(0, 255, 136, 0.1);
    }

    .owned-item-header {
        position: relative;
        margin-bottom: 12px;
    }

    .owned-item-emoji {
        font-size: 40px;
        margin-bottom: 8px;
    }

    .owned-item-badge {
        position: absolute;
        top: -8px;
        right: -8px;
        background: #ff4444;
        color: white;
        font-size: 12px;
        font-weight: 700;
        padding: 4px 8px;
        border-radius: 12px;
        min-width: 24px;
    }

    .owned-item-name {
        font-size: 16px;
        font-weight: 600;
        color: white;
        margin-bottom: 8px;
    }

    .status-badge {
        display: inline-block;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 600;
        margin-bottom: 8px;
    }

    .status-badge.equipped {
        background: rgba(0, 255, 136, 0.2);
        color: #00ff88;
        border: 1px solid #00ff88;
    }

    .status-badge.ready {
        background: rgba(99, 102, 241, 0.2);
        color: #818cf8;
        border: 1px solid #818cf8;
    }

    .owned-item-effect {
        font-size: 13px;
        color: #999;
        margin-bottom: 12px;
    }

    .use-now-btn {
        width: 100%;
        padding: 10px 16px;
        background: var(--primary);
        color: white;
        border: none;
        border-radius: 8px;
        font-size: 14px;
        font-weight: 600;
        cursor: pointer;
        transition: all 0.2s;
    }

    .use-now-btn:hover {
        background: #5a5fd8;
        transform: scale(1.02);
    }

    .item-count-badge {
        background: rgba(255, 255, 255, 0.1);
        color: #999;
        padding: 4px 12px;
        border-radius: 12px;
        font-size: 12px;
        font-weight: 500;
    }


/* ========================================
   ONBOARDING SYSTEM STYLES
   ======================================== */

.onboarding-overlay {
    position: fixed;
    top: 0;
    left: 0;
    width: 100%;
    height: 100%;
    background: linear-gradient(135deg, #1a1a2e 0%, #16213e 100%);
    z-index: 10000;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow-y: auto;
    padding: 20px;
}

.onboarding-overlay.hidden {
    display: none;
}

.onboarding-content {
    width: 100%;
    max-width: 900px;
    margin: 0 auto;
    padding: 20px 0;
    max-height: 100vh;
    overflow-y: auto;
}

.step-header {
    text-align: center;
    margin-bottom: 20px;
}

.step-title {
    font-size: 28px;
    font-weight: bold;
    color: #fff;
    margin-bottom: 8px;
}

.step-subtitle {
    font-size: 16px;
    color: #aaa;
    margin-bottom: 20px;
}

.step-indicators {
    display: flex;
    gap: 10px;
    justify-content: center;
    margin-bottom: 10px;
}

.step-dot {
    width: 12px;
    height: 12px;
    border-radius: 50%;
    background: #333;
    transition: all 0.3s ease;
}

.step-dot.active {
    background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
    width: 30px;
    border-radius: 6px;
}

.step-count {
    font-size: 14px;
    color: #888;
}

.onboarding-step {
    display: none;
}

.onboarding-step.active {
    display: block;
}

.monster-cards {
    display: flex;
    flex-direction: column;
    gap: 12px;
    margin-bottom: 80px;
}

.monster-card {
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 16px;
    padding: 16px;
    cursor: pointer;
    transition: all 0.3s ease;
}

.monster-card:hover {
    transform: translateY(-4px);
    border-color: rgba(255, 255, 255, 0.3);
    box-shadow: 0 8px 32px rgba(0, 0, 0, 0.3);
}

.monster-card.selected {
    border-color: #667eea;
    box-shadow: 0 0 20px rgba(102, 126, 234, 0.5);
}

.monster-card-content {
    display: flex;
    gap: 20px;
    align-items: center;
}

.monster-avatar {
    width: 100px;
    height: 100px;
    border-radius: 50%;
    display: flex;
    align-items: center;
    justify-content: center;
    flex-shrink: 0;
}

.monster-avatar.luna {
    background: linear-gradient(135deg, #a18cd1 0%, #fbc2eb 100%);
}

.monster-avatar.benny {
    background: linear-gradient(135deg, #ffa751 0%, #ffe259 100%);
}

.monster-avatar.nova {
    background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%);
}

.monster-sprite {
    width: 32px;
    height: 32px;
    object-fit: none;
    object-position: 0 0;
    image-rendering: pixelated;
    transform: scale(2.5);
}

.monster-info {
    flex: 1;
}

.monster-name {
    font-size: 24px;
    font-weight: bold;
    color: #fff;
    margin-bottom: 5px;
}

.monster-title {
    font-size: 16px;
    color: #aaa;
    margin-bottom: 10px;
}

.monster-description {
    font-size: 13px;
    color: #ccc;
    line-height: 1.4;
    margin-bottom: 8px;
}

.monster-tags {
    display: flex;
    gap: 8px;
    flex-wrap: wrap;
    margin-top: 10px;
}

.monster-tag {
    padding: 4px 12px;
    border-radius: 12px;
    font-size: 12px;
    font-weight: 500;
}

.monster-tag.luna {
    background: rgba(161, 140, 209, 0.3);
    color: #d4c5f9;
}

.monster-tag.benny {
    background: rgba(255, 167, 81, 0.3);
    color: #ffd4a3;
}

.monster-tag.nova {
    background: rgba(240, 147, 251, 0.3);
    color: #f5b3fb;
}

.onboarding-button {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    padding: 16px 48px;
    background: linear-gradient(135deg, #4F46E5 0%, #7C3AED 100%);
    color: white;
    border: none;
    border-radius: 12px;
    font-size: 18px;
    font-weight: bold;
    cursor: pointer;
    transition: all 0.3s ease;
    box-shadow: 0 4px 15px rgba(79, 70, 229, 0.4);
    z-index: 10001;
    display: flex;
    align-items: center;
    justify-content: center;
    text-align: center;
}

.onboarding-button:hover {
    transform: translateX(-50%) translateY(-2px);
    box-shadow: 0 6px 20px rgba(79, 70, 229, 0.6);
}

.onboarding-button:disabled {
    background: #555;
    cursor: not-allowed;
    box-shadow: none;
}

.name-input-container {
    max-width: 500px;
    margin: 0 auto 30px;
}

.name-input {
    width: 100%;
    padding: 16px;
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 12px;
    color: white;
    font-size: 18px;
    text-align: center;
    margin-bottom: 10px;
}

.name-input:focus {
    outline: none;
    border-color: #667eea;
}

.name-hint {
    text-align: center;
    font-size: 14px;
    color: #888;
    margin-bottom: 20px;
}

.quick-suggestions {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 10px;
    margin-bottom: 20px;
}

.suggestion-chip {
    padding: 12px;
    background: rgba(255, 255, 255, 0.05);
    border: 2px solid rgba(255, 255, 255, 0.1);
    border-radius: 8px;
    color: white;
    font-size: 14px;
    cursor: pointer;
    transition: all 0.3s ease;
    text-align: center;
}

.suggestion-chip:hover {
    border-color: rgba(255, 255, 255, 0.3);
    background: rgba(255, 255, 255, 0.1);
}

.suggestion-chip.selected {
    border-color: #667eea;
    background: rgba(102, 126, 234, 0.2);
}

.selected-monster-display {
    text-align: center;
    margin-bottom: 30px;
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 15px;
}

.selected-monster-avatar {
    width: 120px;
    height: 120px;
    border-radius: 50%;
    margin: 0 auto 15px;
    display: flex;
    align-items: center;
    justify-content: center;
    overflow: hidden;
}

.selected-monster-sprite {
    width: 32px;
    height: 32px;
    object-fit: none;
    object-position: 0 0;
    image-rendering: pixelated;
    transform: scale(3.5);
}

.confirmation-message {
    text-align: center;
    font-size: 18px;
    color: #ccc;
    line-height: 1.6;
}

.confirmation-message strong {
    color: #667eea;
    font-size: 24px;
}

.back-button {
    position: fixed;
    top: 30px;
    left: 30px;
    width: 40px;
    height: 40px;
    background: rgba(255, 255, 255, 0.1);
    border: none;
    border-radius: 50%;
    color: white;
    font-size: 20px;
    cursor: pointer;
    transition: all 0.3s ease;
    display: flex;
    align-items: center;
    justify-content: center;
    z-index: 10001;
}

.back-button:hover {
    background: rgba(255, 255, 255, 0.2);
}

/* Responsive Design */
@media (max-width: 768px) {
    .onboarding-content {
        padding-bottom: 120px;
    }
    
    .step-title {
        font-size: 24px;
    }
    
    .step-subtitle {
        font-size: 14px;
    }
    
    .monster-card-content {
        flex-direction: column;
        text-align: center;
    }
    
    .monster-avatar {
        margin: 0 auto;
    }
    
    .selected-monster-avatar {
        width: 100px;
        height: 100px;
    }
    
    .monster-name {
        font-size: 20px;
    }
    
    .monster-description {
        font-size: 13px;
    }
    
    .quick-suggestions {
        grid-template-columns: repeat(2, 1fr);
        gap: 8px;
    }
    
    .suggestion-chip {
        padding: 10px;
        font-size: 13px;
    }
    
    .onboarding-button {
        bottom: 20px;
        padding: 14px 32px;
        font-size: 16px;
        width: calc(100% - 40px);
        max-width: 400px;
    }
    
    .name-input {
        font-size: 16px;
    }
}

    </style>

</head>
<body>

<!-- ========================================
     ONBOARDING SYSTEM
     ======================================== -->
<div class="onboarding-overlay hidden" id="onboardingOverlay">
    <div class="onboarding-content">
        
        <!-- Step 1: Choose Your Monster -->
        <div class="onboarding-step active" id="step1">
            <div class="step-header">
                <h1 class="step-title">Choose Your Task Monster</h1>
                <p class="step-subtitle">Pick your perfect productivity companion</p>
                <div class="step-indicators">
                    <div class="step-dot active"></div>
                    <div class="step-dot"></div>
                    <div class="step-dot"></div>
                </div>
                <p class="step-count">Step 1 of 3</p>
            </div>
            
            <div class="monster-cards">
                <!-- Luna Card -->
                <div class="monster-card" data-monster="luna" id="lunaCard">
                    <div class="monster-card-content">
                        <div class="monster-avatar luna">
                            <img src="assets/heroes/Owlet_Monster_Idle_4.png" alt="Luna" class="monster-sprite" id="lunaSprite">
                        </div>
                        <div class="monster-info">
                            <div class="monster-name">Luna</div>
                            <div class="monster-title">The Wise Night Owl</div>
                            <div class="monster-description">Perfect for night owls and deep thinkers. Luna helps you tackle complex tasks with wisdom and patience.</div>
                            <div class="monster-tags">
                                <span class="monster-tag luna">Calm</span>
                                <span class="monster-tag luna">Intelligent</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Benny Card -->
                <div class="monster-card" data-monster="benny" id="bennyCard">
                    <div class="monster-card-content">
                        <div class="monster-avatar benny">
                            <img src="assets/heroes/Dude_Monster_Idle_4.png" alt="Benny" class="monster-sprite" id="bennySprite">
                        </div>
                        <div class="monster-info">
                            <div class="monster-name">Benny</div>
                            <div class="monster-title">The Gentle Giant</div>
                            <div class="monster-description">Strong and dependable. Benny helps you power through big projects with steady determination.</div>
                            <div class="monster-tags">
                                <span class="monster-tag benny">Energetic</span>
                                <span class="monster-tag benny">Loyal</span>
                            </div>
                        </div>
                    </div>
                </div>
                
                <!-- Nova Card -->
                <div class="monster-card" data-monster="nova" id="novaCard">
                    <div class="monster-card-content">
                        <div class="monster-avatar nova">
                            <img src="assets/heroes/Pink_Monster_Idle_4.png" alt="Nova" class="monster-sprite" id="novaSprite">
                        </div>
                        <div class="monster-info">
                            <div class="monster-name">Nova</div>
                            <div class="monster-title">The Fiery Achiever</div>
                            <div class="monster-description">Energetic and ambitious. Nova motivates you to crush goals and achieve greatness at lightning speed.</div>
                            <div class="monster-tags">
                                <span class="monster-tag nova">Curious</span>
                                <span class="monster-tag nova">Optimistic</span>
                            </div>
                        </div>
                    </div>
                </div>
            </div>
        </div>
        
        <!-- Step 2: Name Your Monster -->
        <div class="onboarding-step" id="step2">
            <button class="back-button" id="backToStep1">←</button>
            
            <div class="step-header">
                <h1 class="step-title">Name Your Monster</h1>
                <div class="step-indicators">
                    <div class="step-dot"></div>
                    <div class="step-dot active"></div>
                    <div class="step-dot"></div>
                </div>
                <p class="step-count">Step 2 of 3</p>
            </div>
            
            <div class="selected-monster-display">
                <div class="selected-monster-avatar" id="selectedAvatar">
                    <img src="" alt="Selected Monster" class="selected-monster-sprite" id="selectedSprite">
                </div>
                <div class="monster-name" id="selectedName"></div>
                <div class="monster-title" id="selectedTitle"></div>
                <div class="monster-description" id="selectedDescription"></div>
                <div class="monster-tags" id="selectedTags"></div>
            </div>
            
            <div class="name-input-container">
                <p class="step-subtitle">Give your monster a name</p>
                <input type="text" class="name-input" id="monsterNameInput" maxlength="15" placeholder="Enter a name">
                <p class="name-hint">Maximum 15 characters</p>
            </div>
        </div>
        
        <!-- Step 3: Confirmation -->
        <div class="onboarding-step" id="step3">
            <button class="back-button" id="backToStep2">←</button>
            
            <div class="step-header">
                <h1 class="step-title">Ready to Start!</h1>
                <div class="step-indicators">
                    <div class="step-dot"></div>
                    <div class="step-dot"></div>
                    <div class="step-dot active"></div>
                </div>
                <p class="step-count">Step 3 of 3</p>
            </div>
            
            <div class="selected-monster-display">
                <div class="selected-monster-avatar" id="confirmAvatar">
                    <img src="" alt="Your Monster" class="selected-monster-sprite" id="confirmSprite">
                </div>
            </div>
            
            <div class="confirmation-message">
                <p>Your monster will be called</p>
                <p><strong id="confirmName"></strong></p>
            </div>
        </div>
        
    </div>
    
    <!-- Continue Button (Sticky at bottom) -->
    <button class="onboarding-button" id="continueButton" disabled>Continue</button>
</div>

<!-- Confetti Canvas -->
<canvas id="confetti-canvas" style="position: fixed; inset: 0; width: 100vw; height: 100vh; pointer-events: none; z-index: 9999;"></canvas>

<!-- Battle Arena -->
<div id="battleArena" class="battle-arena hidden">
    <div class="battle-container">
        <!-- Hero Side -->
        <div class="sprite-container">
            <div class="sprite-wrapper">
                <div id="heroSprite" class="sprite idle"></div>
            </div>
            <div class="hp-bar-container">
                <div class="hp-label">
                    <span>HP</span>
                    <span id="heroHPText">100/100</span>
                </div>
                <div class="hp-bar-bg">
                    <div id="heroHPBar" class="hp-bar-fill" style="width: 100%;"></div>
                </div>
            </div>
        </div>


        <!-- Enemy Side -->
        <div class="sprite-container">
            <div class="sprite-wrapper">
                <div id="enemySprite" class="sprite idle" style="background-image: url('assets/enemies/Bat-IdleFly.png');"></div>
            </div>
            <div class="hp-bar-container">
                <div class="hp-label">
                    <span>HP</span>
                    <span id="enemyHPText">50/50</span>
                </div>
                <div class="hp-bar-bg">
                    <div id="enemyHPBar" class="hp-bar-fill" style="width: 100%;"></div>
                </div>
            </div>
        </div>
    </div>

    <!-- Battle Log (moved inside battle scene) -->
    <div id="battleLog" class="battle-log"></div>

    <!-- Gauges -->
    <div class="gauge-container">
        <div class="gauge">
            <div class="gauge-label">
                <span>⚔️ Attack Gauge</span>
                <span id="attackGaugeText">0/100</span>
            </div>
            <div class="gauge-bar-bg">
                <div id="attackGaugeBar" class="gauge-bar-fill attack-gauge-fill" style="width: 0%;"></div>
            </div>
        </div>
        <div class="gauge">
            <div class="gauge-label">
                <span>🛡️ Defense Gauge</span>
                <span id="defenseGaugeText">0/100</span>
            </div>
            <div class="gauge-bar-bg">
                <div id="defenseGaugeBar" class="gauge-bar-fill defense-gauge-fill" style="width: 0%;"></div>
            </div>
        </div>
    </div>

    <!-- Action Buttons -->
    <div class="action-buttons">
        <button id="btnAttack" class="btn-action" onclick="battleManager.playerAttack()">
            ⚔️ Attack
        </button>
        <button id="btnDefend" class="btn-action" onclick="battleManager.playerDefend()">
            🪨 Defend
        </button>
        <button id="btnFireball" class="btn-action" onclick="battleManager.playerFireball()">
            🔥 Fireball <span class="item-count" id="fireballCount">(0)</span>
        </button>
        <button id="btnSpark" class="btn-action" onclick="battleManager.playerSpark()" style="display: none;">
            ⚡ Spark <span class="item-count" id="sparkCount">(0)</span>
        </button>
        <button id="btnPotion" class="btn-action" onclick="battleManager.playerPotion()">
            🧪 Potion <span class="item-count" id="potionCount">(2)</span>
        </button>
        <button id="btnAttackRefill" class="btn-action" onclick="battleManager.playerAttackRefill()">
            ⚡ Attack+ <span class="item-count" id="attackRefillCount">(0)</span>
        </button>
        <button id="btnDefenseRefill" class="btn-action" onclick="battleManager.playerDefenseRefill()">
            🛡️ Defense+ <span class="item-count" id="defenseRefillCount">(0)</span>
        </button>
        <button id="btnFlee" class="btn-flee" onclick="battleManager.playerFlee()">
            🏃 Flee
        </button>
    </div>
</div>

<!-- Fireball Projectile -->
<div id="fireballProjectile" class="fireball-projectile hidden"></div>

<!-- Explosion Effect -->
<div id="explosionEffect" class="explosion-effect hidden"></div>

<!-- Quest Giver UI -->
<div id="questGiverUI" class="quest-giver-overlay hidden">
    <!-- Forest Scene with Bird -->
    <div class="quest-scene">
        <div id="questCrowSprite" class="quest-crow-sprite"></div>
    </div>
    
    <!-- Dialogue Container -->
    <div class="quest-dialogue-container">
        <div class="quest-dialogue-header">
            <span class="quest-dialogue-label">Merlin</span>
        </div>
        <div id="questDialogue" class="quest-dialogue-text">
            <!-- Wise dialogue will be inserted here -->
        </div>
    </div>
    
    <!-- Quest Actions (Accept/Decline) -->
    <div id="questActions" class="quest-actions hidden">
        <button class="quest-btn quest-btn-accept" onclick="questGiver.acceptQuest()">✨ Accept Quest</button>
        <button class="quest-btn quest-btn-decline" onclick="questGiver.declineQuest()">Pass</button>
    </div>
    
    <!-- Quiz Actions -->
    <div id="quizActions" class="quest-actions hidden">
        <div id="quizOptions">
            <!-- Quiz options will be inserted here -->
        </div>
    </div>
</div>

<!-- Loading Screen -->
<div class="loading-screen" id="loadingScreen">
    <img alt="Task Monsters" class="loading-brand" src="assets/logo/loading-screen.png"/>
    <div class="loading-spinner"></div>
    <div class="loading-text"></div>
</div>

<div class="app-container">
    <!-- Pet Rock Header -->
    <div class="pet-rock-header" style="position: relative; background-image: url('assets/backgrounds/default-bg.png'); background-size: cover; background-position: center; padding: 40px 20px 30px 20px; border-radius: 16px; margin-bottom: 20px; box-shadow: 0 8px 24px rgba(0,0,0,0.3);">

        <div class="creature-container" style="position: relative; z-index: 10; display: flex; flex-direction: column; align-items: center; gap: 8px; margin-top: 40px;">
            <div style="width: 140px; height: 140px; margin: 50px auto 0; overflow: visible; position: relative; display: flex; align-items: center; justify-content: center;">
                <!-- Task Pal Tooltip -->
                <div id="taskPalTooltip" class="task-pal-tooltip"></div>
                <img alt="Hero" id="mainHeroSprite" src="assets/heroes/Pink_Monster_Idle_4.png" style="width: 32px; height: 32px; image-rendering: pixelated; object-fit: none; object-position: 0 0; transform: scale(4); transform-origin: center center; animation: hero-idle-anim 0.8s steps(4) infinite; opacity: 0; transition: opacity 0.3s ease;"/>
            </div>
            
            <!-- RPG Stat Gauges -->
            <div style="display: grid; grid-template-columns: repeat(3, 1fr); gap: 12px; margin: 16px auto 0; max-width: 500px; padding: 0 10px;">
                <!-- Energy Gauge -->
                <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 12px; padding: 16px 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2);">
                    <div style="font-size: 28px; text-align: center; margin-bottom: 8px;">⚡</div>
                    <div style="font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.7); text-align: center; margin-bottom: 8px; letter-spacing: 0.5px;">HP</div>
                    <div style="width: 100%; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                        <div id="energyFill" style="height: 100%; background: linear-gradient(90deg, #10b981 0%, #3b82f6 100%); width: 75%; transition: width 0.3s ease-in-out;"></div>
                    </div>
                    <div id="energyText" style="font-size: 14px; font-weight: 700; color: #fff; text-align: center;">75/100</div>
                </div>
                
                <!-- Attack Gauge -->
                <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 12px; padding: 16px 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2);">
                    <div style="font-size: 28px; text-align: center; margin-bottom: 8px;">⚔️</div>
                    <div style="font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.7); text-align: center; margin-bottom: 8px; letter-spacing: 0.5px;">ATTACK</div>
                    <div style="width: 100%; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                        <div id="attackFill" style="height: 100%; background: linear-gradient(90deg, #ef4444 0%, #f97316 50%, #ec4899 100%); width: 60%; transition: width 0.3s ease-in-out;"></div>
                    </div>
                    <div id="attackText" style="font-size: 14px; font-weight: 700; color: #fff; text-align: center;">60/100</div>
                </div>
                
                <!-- Defense Gauge -->
                <div style="background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 12px; padding: 16px 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2);">
                    <div style="font-size: 28px; text-align: center; margin-bottom: 8px;">🛡️</div>
                    <div style="font-size: 11px; font-weight: 600; color: rgba(255,255,255,0.7); text-align: center; margin-bottom: 8px; letter-spacing: 0.5px;">DEFENSE</div>
                    <div style="width: 100%; height: 8px; background: rgba(0,0,0,0.3); border-radius: 4px; overflow: hidden; margin-bottom: 8px;">
                        <div id="defenseFill" style="height: 100%; background: linear-gradient(90deg, #8b5cf6 0%, #3b82f6 100%); width: 85%; transition: width 0.3s ease-in-out;"></div>
                    </div>
                    <div id="defenseText" style="font-size: 14px; font-weight: 700; color: #fff; text-align: center;">85/100</div>
                </div>
            </div>
            
            <!-- XP Bar -->
            <div style="margin: 16px auto 0; max-width: 500px; padding: 0 10px;">
                <div style="padding: 16px; background: rgba(255,255,255,0.1); backdrop-filter: blur(10px); border-radius: 12px; box-shadow: 0 4px 12px rgba(0,0,0,0.2); border: 1px solid rgba(255,255,255,0.2);">
                    <!-- Level | Name Header -->
                    <div id="levelLabel" style="text-align: center; font-size: 14px; font-weight: 600; color: rgba(255,255,255,0.9); text-shadow: 1px 1px 2px rgba(0,0,0,0.5); margin-bottom: 8px; letter-spacing: 0.3px;">Jerry | Level 1</div>
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 8px; gap: 16px;">
                        <div style="font-size: 13px; font-weight: 600; color: rgba(255,255,255,0.9); white-space: nowrap;">Experience Points</div>
                        <div id="xpText" style="font-size: 13px; font-weight: 700; color: #fff; white-space: nowrap;">0 / 1,000 XP</div>
                    </div>
                    <div style="width: 100%; height: 12px; background: rgba(0,0,0,0.3); border-radius: 6px; overflow: hidden;">
                        <div id="xpFill" style="height: 100%; background: linear-gradient(90deg, #6366f1 0%, #8b5cf6 100%); width: 0%; transition: width 0.3s ease-in-out;"></div>
                    </div>
                </div>
            </div>
            
            <!-- Battle system triggers automatically after completing tasks (40% chance) -->
        </div>
    </div>

    <!-- Planner Section with Budget-style design -->
    <section id="plannerSection">
        <!-- Expandable Stats Section -->
        <div class="stats-section">
            <div class="stats-header" onclick="toggleStatsExpansion()">
                <div class="stats-title">🔍 Statistics</div>
                <div class="stats-toggle" id="statsToggle">▼</div>
            </div>
            
            <!-- Collapsed view: 3 main stats -->
            <div class="stats-row stats-collapsed" id="statsCollapsed">
                <div class="stat-tile">
                    <div class="stat-icon">🚀</div>
                    <div class="stat-value" id="quickTasksDisplay">0</div>
                    <div class="stat-label">Pending Quick Tasks</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">⏳</div>
                    <div class="stat-value" id="pendingTasksDisplay">0</div>
                    <div class="stat-label">Pending Tasks</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">✅</div>
                    <div class="stat-value" id="completedTasksDisplay">0</div>
                    <div class="stat-label">Completed Tasks</div>
                </div>
            </div>
            
            <!-- Expanded view: All stats -->
            <div class="stats-grid stats-expanded" id="statsExpanded" style="display: none;">
                <div class="stat-tile">
                    <div class="stat-icon">🚀</div>
                    <div class="stat-value" id="quickTasksDisplayExp">0</div>
                    <div class="stat-label">Pending Quick Tasks</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">⏳</div>
                    <div class="stat-value" id="pendingTasksDisplayExp">0</div>
                    <div class="stat-label">Pending Tasks</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">✅</div>
                    <div class="stat-value" id="completedTasksDisplayExp">0</div>
                    <div class="stat-label">Completed Tasks</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">✔️</div>
                    <div class="stat-value" id="completedQuickTasksDisplayExp">0</div>
                    <div class="stat-label">Completed Quick Tasks</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">📈</div>
                    <div class="stat-value" id="completionRateDisplay">0%</div>
                    <div class="stat-label">Completion Rate</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">📊</div>
                    <div class="stat-value" id="totalTasksDisplay">0</div>
                    <div class="stat-label">Total Tasks</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">🔥</div>
                    <div class="stat-value" id="currentStreakDisplay">0</div>
                    <div class="stat-label">Current Streak</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">🏆</div>
                    <div class="stat-value" id="bestStreakDisplay">0</div>
                    <div class="stat-label">Best Streak</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">⭐</div>
                    <div class="stat-value" id="rockLevelDisplay">1</div>
                    <div class="stat-label">Hero Level</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">🎯</div>
                    <div class="stat-value" id="experienceDisplay">0/100 XP</div>
                    <div class="stat-label">Experience</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">🥇</div>
                    <div class="stat-value" id="achievementsDisplay">0/10</div>
                    <div class="stat-label">Achievements</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">⚔️</div>
                    <div class="stat-value" id="battlesWonDisplay">0</div>
                    <div class="stat-label">Battles Won</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">💥</div>
                    <div class="stat-value" id="battlesLostDisplay">0</div>
                    <div class="stat-label">Battles Lost</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">🧠</div>
                    <div class="stat-value" id="quizPassedDisplay">0</div>
                    <div class="stat-label">Quizzes Passed</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">❌</div>
                    <div class="stat-value" id="quizFailedDisplay">0</div>
                    <div class="stat-label">Quizzes Failed</div>
                </div>
                <div class="stat-tile">
                    <div class="stat-icon">📝</div>
                    <div class="stat-value" id="questAcceptanceDisplay">0%</div>
                    <div class="stat-label">Quest Acceptance</div>
                </div>
            </div>
        </div>

        <!-- Pill tab bar -->
        <div class="pill-tabs">
            <button class="pill-tab" aria-selected="true" onclick="switchToTab('home')">Home</button>
            <button class="pill-tab" aria-selected="false" onclick="switchToTab('achievements')">Achievements</button>
            <button class="pill-tab" aria-selected="false" onclick="switchToTab('shop')">Shop</button>
            <button class="pill-tab" aria-selected="false" onclick="switchToTab('settings')">Settings</button>
        </div>

        <!-- Home tab content -->
        <div id="homeTab" class="tab-content active">
            

            <!-- Daily Challenge - Expandable Section -->
            <div class="daily-challenge-section">
                <div class="daily-challenge-header" onclick="toggleDailyChallengeExpansion()">
                    <div class="daily-challenge-title">📅 Daily Challenge</div>
                    <div class="daily-challenge-toggle" id="dailyChallengeToggle">▼</div>
                </div>
                <div class="daily-challenge-content" id="dailyChallengeContent" style="display: block;">
                    <div id="dailyChallengeDisplay">
                        <!-- Daily challenge will be populated here -->
                    </div>
                </div>
            </div>

            <!-- Quest Tasks -->
            <div class="card quest-tasks-card" id="questTasksCard" style="display: none;">
                <div class="card-header quest-tasks-header">
                    <div class="card-title">🏆 Quest Tasks</div>
                    <div class="quest-tasks-subtitle">Special quests from Merlin</div>
                </div>
                <div id="questTasksList">
                    <!-- Quest tasks will be populated here -->
                </div>
            </div>

            <!-- Your Tasks -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">📝 Your Tasks</div>
                    <button class="btn-primary" onclick="openCreateTaskModal()">+ Add</button>
                </div>
                <div id="tasksList">
                    <!-- Tasks will be populated here -->
                </div>
            </div>

            <!-- Quick Tasks -->
            <div class="card">
                <div class="card-header">
                    <div class="card-title">⚡ Quick Tasks</div>
                    <button class="btn-primary" onclick="openQuickTaskModal()">+ Add</button>
                </div>
                <div id="quickTasksList">
                    <!-- Quick tasks will be populated here -->
                </div>
            </div>
        </div>

        <!-- Achievements tab content -->
        <div id="achievementsTab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">🏆 Achievements</div>
                </div>
                <div id="achievementsList">
                    <!-- Achievements will be populated here -->
                </div>
            </div>
        </div>

        <!-- Shop tab content -->
        <div id="shopTab" class="tab-content">
            <!-- Shop Sub-Tabs -->
            <div class="shop-sub-tabs">
                <button class="pill-tab-shop active" onclick="switchShopSubTab('shop')">Shop</button>
                <button class="pill-tab-shop" onclick="switchShopSubTab('owned')">Owned</button>
                <button class="pill-tab-shop" onclick="switchShopSubTab('themes')">Themes</button>
            </div>

            <!-- Shop Sub-Tab Content -->
            <div id="shopSubTabContent" class="shop-sub-content active">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">🛍️ Shop</div>
                    </div>
                    <div style="padding: 20px;">
                        <p style="text-align: center; color: #666; margin-bottom: 20px;">Power up your hero with XP!</p>
                        <div id="shopItemsGrid" class="shop-items-grid">
                            <!-- Shop items will be rendered here -->
                        </div>
                    </div>
                </div>
            </div>

            <!-- Owned Sub-Tab Content -->
            <div id="ownedSubTabContent" class="shop-sub-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">🎒 Battle Items</div>
                        <span id="ownedItemCount" class="item-count-badge">0 items</span>
                    </div>
                    <div id="ownedItemsGrid" class="owned-items-grid">
                        <!-- Owned items will be rendered here -->
                    </div>
                </div>
            </div>

            <!-- Themes Sub-Tab Content -->
            <div id="themesSubTabContent" class="shop-sub-content">
                <div class="card">
                    <div class="card-header">
                        <div class="card-title">🎨 Background Themes</div>
                        <div class="card-subtitle" id="themesCount">5 themes</div>
                    </div>
                    <div style="padding: 20px;">
                        <p style="text-align: center; color: #666; margin-bottom: 20px;">Customize your monster's background!</p>
                        <div id="themesGrid" class="owned-items-grid">
                            <!-- Themes will be populated here -->
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Settings tab content -->
        <div id="settingsTab" class="tab-content">
            <div class="card">
                <div class="card-header">
                    <div class="card-title">⚙️ Settings</div>
                </div>

                <div class="settings-item">
                    <div class="settings-label">Notifications</div>
                    <div class="settings-toggle" id="notificationsToggle" onclick="toggleNotifications()">
                        <div class="settings-toggle-slider"></div>
                    </div>
                </div>
                <div class="settings-item">
                    <div class="settings-label">Share Etsy Store</div>
                    <button class="btn-secondary" onclick="shareEtsyStore()">Share</button>
                </div>
                <div class="settings-item">
                    <div class="settings-label">👾 Change Task Monster's Name</div>
                    <button class="btn-secondary" onclick="openChangeNameModal()">Edit</button>
                </div>

                <div class="settings-item">
                    <div class="settings-label">Reset Progress</div>
                    <button style="background: var(--error); color: white;" class="btn-secondary" onclick="showResetOptions()">Reset</button>
                </div>
            </div>
        </div>

        <!-- Centered FAB -->
        <button class="fab-center" onclick="openCreateTaskModal()">+</button>
    </section>
</div>

<!-- Create Task Modal -->
<div class="modal" id="createTaskModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Create Task</h2>
            <button class="modal-close" onclick="closeModal()">×</button>
        </div>
        <div class="modal-body">
            <form id="taskForm">
                <div class="form-group">
                    <label class="form-label">Task Title</label>
                    <input class="form-input" id="taskTitle" placeholder="Enter task title" required type="text"/>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Description (Optional)</label>
                    <textarea class="form-textarea" id="taskDescription" placeholder="Enter task description"></textarea>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Category</label>
                    <div class="selection-grid">
                        <div class="selection-item" data-category="work" onclick="selectCategory('work')">
                            <div class="selection-item-emoji">💼</div>
                            <div class="selection-item-text">Work</div>
                        </div>
                        <div class="selection-item" data-category="learning" onclick="selectCategory('learning')">
                            <div class="selection-item-emoji">🎓</div>
                            <div class="selection-item-text">Learning</div>
                        </div>
                        <div class="selection-item" data-category="home" onclick="selectCategory('home')">
                            <div class="selection-item-emoji">🏠</div>
                            <div class="selection-item-text">Home</div>
                        </div>
                        <div class="selection-item" data-category="finance" onclick="selectCategory('finance')">
                            <div class="selection-item-emoji">💰</div>
                            <div class="selection-item-text">Finance</div>
                        </div>
                        <div class="selection-item" data-category="goals" onclick="selectCategory('goals')">
                            <div class="selection-item-emoji">🎯</div>
                            <div class="selection-item-text">Goals</div>
                        </div>
                        <div class="selection-item" data-category="projects" onclick="selectCategory('projects')">
                            <div class="selection-item-emoji">🛠️</div>
                            <div class="selection-item-text">Projects</div>
                        </div>
                        <div class="selection-item" data-category="errands" onclick="selectCategory('errands')">
                            <div class="selection-item-emoji">🚗</div>
                            <div class="selection-item-text">Errands</div>
                        </div>
                        <div class="selection-item" data-category="digital" onclick="selectCategory('digital')">
                            <div class="selection-item-emoji">📱</div>
                            <div class="selection-item-text">Digital</div>
                        </div>
                        <div class="selection-item" data-category="creative" onclick="selectCategory('creative')">
                            <div class="selection-item-emoji">🎨</div>
                            <div class="selection-item-text">Creative</div>
                        </div>
                        <div class="selection-item" data-category="social" onclick="selectCategory('social')">
                            <div class="selection-item-emoji">🤝🏽</div>
                            <div class="selection-item-text">Social</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Difficulty</label>
                    <div class="selection-grid">
                        <div class="selection-item" data-difficulty="easy" onclick="selectDifficulty('easy')">
                            <div class="selection-item-emoji">😊</div>
                            <div class="selection-item-text">Easy (2 pts)</div>
                        </div>
                        <div class="selection-item" data-difficulty="medium" onclick="selectDifficulty('medium')">
                            <div class="selection-item-emoji">😐</div>
                            <div class="selection-item-text">Medium (5 pts)</div>
                        </div>
                        <div class="selection-item" data-difficulty="hard" onclick="selectDifficulty('hard')">
                            <div class="selection-item-emoji">😤</div>
                            <div class="selection-item-text">Hard (10 pts)</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Priority</label>
                    <div class="selection-grid">
                        <div class="selection-item" data-priority="low" onclick="selectPriority('low')">
                            <div class="selection-item-emoji">🟢</div>
                            <div class="selection-item-text">Low Priority</div>
                        </div>
                        <div class="selection-item" data-priority="medium" onclick="selectPriority('medium')">
                            <div class="selection-item-emoji">🟡</div>
                            <div class="selection-item-text">Medium Priority</div>
                        </div>
                        <div class="selection-item" data-priority="high" onclick="selectPriority('high')">
                            <div class="selection-item-emoji">🔴</div>
                            <div class="selection-item-text">High Priority</div>
                        </div>
                    </div>
                </div>
                
                <div class="form-group">
                    <label class="form-label">Due Date (Optional)</label>
                    <input class="form-input" id="taskDueDate" type="datetime-local" placeholder="Select date and time"/>
                </div>
            </form>
        </div>
        <div class="modal-footer">
            <button class="btn-secondary" style="width: 48%;" onclick="closeModal()">Close</button>
            <button class="btn-primary" style="width: 48%;" onclick="createTask()">Create Task</button>
        </div>
    </div>
</div>

<!-- Quick Task Modal -->
<div class="modal" id="quickTaskModal">
    <div class="modal-content">
        <div class="modal-header">
            <h2 class="modal-title">Add Quick Task</h2>
            <button class="modal-close" onclick="closeQuickTaskModal()">×</button>
        </div>
        <div class="modal-body">
            <div id="quickTaskCategories">
                <!-- Quick task categories will be populated here -->
            </div>
        </div>
    </div>
</div>

<!-- Change Name Modal -->
<div class="modal" id="changeNameModal">
    <div class="modal-content">
        <div class="modal-header">
            <div class="modal-title">Change Task Monster's Name</div>
            <button class="modal-close" onclick="closeChangeNameModal()">×</button>
        </div>
        <div class="modal-body">
            <label for="newCreatureName" class="form-label">Enter new name:</label>
            <input id="newCreatureName" type="text" class="form-input" maxlength="20" placeholder="e.g., Jerry 2.0" />
        </div>
        <div class="modal-footer">
            <button class="btn-primary" onclick="saveNewCreatureName()">Save</button>
        </div>
    </div>
</div>

<script>
        // Game state
        let gameState = {
            rockName: 'Jerry',
            health: 100,
            jerryLevel: 1,
            jerryXP: 0,
            jerryXPToNext: 100,
            taskPoints: 0,
            tasks: [],
            completedTasks: 0,
            completedTasksToday: 0,
            totalTasksCreated: 0,
            currentStreak: 0,
            longestStreak: 0,
            bestStreak: 0,
            streakMultiplier: 1,
            lastCompletionDate: null,
            lastDayTracked: null,
            darkMode: false,
            notifications: false,
            selectedQuickTasks: [],
            completedQuickTasks: [],
            lastQuickTasksDate: null,
            dailyChallenge: null,
            dailyChallengeCompleted: false,
            lastDailyChallengeDate: null,
            isDead: false,
            revivalPoints: 0,
            ownedItems: [],
            funFactsUnlocked: false,
            // Battle stats
            battlesWon: 0,
            battlesLost: 0,
            // Quest stats
            questQuizzesPassed: 0,
            questQuizzesFailed: 0,
            questTasksAccepted: 0,
            questTasksOffered: 0,
            // Achievement tracking
            achievementProgress: {},
            quickTaskStartTimes: {},
            sessionTaskCount: 0,
            sessionStartTime: null,
            tasksCompletedToday: [],
            weekendTasksCompleted: 0,
            allTasksStreakDays: 0,
            lastAllTasksDate: null,
            currentOutfit: {
                hat: null,
                glasses: null,
                mustache: null,
                paint: null
            },
            battleInventory: {
                fireball: 0, // Locked until level 10
                spark: 0, // Locked until level 7
                health_potion: 2,
                attack_refill: 2,
                defense_refill: 2
            },
            unlockedBattleItems: ['health_potion', 'attack_refill', 'defense_refill'], // Track which items have ever been unlocked (fireball requires level 10)
            xp: 0,
            // Theme system
            ownedThemes: [], // Array of owned theme IDs
            activeTheme: null // Currently active theme URL
        };
        
        // Expose gameState to window for external scripts
        window.gameState = gameState;

        // Task creation variables
        let selectedCategory = null;
        let selectedDifficulty = null;
        let selectedPriority = null;
        let selectedRecurring = 'none';
        let selectedInterval = 1;
        let selectedWeekdays = [];
        let editingTaskIndex = null;

        // Category mapping
        const categoryMap = {
            'work': { name: 'Work & Career', emoji: '💼' },
            'learning': { name: 'Learning & Education', emoji: '🎓' },
            'home': { name: 'Home & Family', emoji: '🏠' },
            'finance': { name: 'Finance & Planning', emoji: '💰' },
            'goals': { name: 'Personal Goals', emoji: '🎯' },
            'projects': { name: 'Projects & Hobbies', emoji: '🛠️' },
            'errands': { name: 'Errands & Appointments', emoji: '🚗' },
            'digital': { name: 'Digital & Technology', emoji: '📱' },
            'creative': { name: 'Creative & Arts', emoji: '🎨' },
            'social': { name: 'Social & Relationships', emoji: '🤝🏽' }
        };

        // Quick Tasks Database
        const quickTasksDatabase = {
            'self-care': {
                name: 'Self-Care & Wellness',
                emoji: '💆🏻',
                tasks: [
                    { id: 'brush_teeth', title: 'Brush teeth', emoji: '🦷', points: 2 },
                    { id: 'wash_face', title: 'Wash my face', emoji: '🧴', points: 2 },
                    { id: 'drink_water', title: 'Drink a glass of water', emoji: '💧', points: 2 },
                    { id: 'take_vitamins', title: 'Take vitamins', emoji: '💊', points: 3 },
                    { id: 'skincare', title: 'Do skincare routine', emoji: '🧴', points: 4 },
                    { id: 'shower', title: 'Take a shower', emoji: '🚿', points: 4 },
                    { id: 'moisturize', title: 'Moisturize skin', emoji: '🧴', points: 3 },
                    { id: 'floss', title: 'Floss teeth', emoji: '🦷', points: 3 }
                ]
            },
            'physical': {
                name: 'Physical Activity',
                emoji: '🏃🏾',
                tasks: [
                    { id: 'pushups', title: 'Do 10 push-ups', emoji: '💪🏾', points: 4 },
                    { id: 'squats', title: 'Do 15 squats', emoji: '🦵🏿', points: 4 },
                    { id: 'plank', title: 'Hold plank for 30 seconds', emoji: '🏋🏽', points: 4 },
                    { id: 'walk', title: 'Take a 10-minute walk', emoji: '🚶🏻', points: 5 },
                    { id: 'stretch', title: 'Stretch for 5 minutes', emoji: '🤸🏽', points: 3 },
                    { id: 'yoga', title: 'Do yoga poses', emoji: '🧘🏾', points: 5 }
                ]
            },
            'sleep': {
                name: 'Sleep & Rest',
                emoji: '😴',
                tasks: [
                    { id: 'screen_warmth', title: 'Turn on screen warmth', emoji: '📱', points: 2 },
                    { id: 'no_caffeine', title: 'No caffeine after 2 PM', emoji: '☕', points: 3 },
                    { id: 'bedtime_routine', title: 'Start bedtime routine', emoji: '🛏️', points: 4 },
                    { id: 'read_book', title: 'Read before bed', emoji: '📚', points: 4 },
                    { id: 'meditation', title: 'Do 5-min meditation', emoji: '🧘🏻', points: 4 }
                ]
            },
            'tidy': {
                name: 'Tidy Up',
                emoji: '🧹',
                tasks: [
                    { id: 'laundry', title: 'Put laundry away', emoji: '👕', points: 4 },
                    { id: 'trash', title: 'Take out trash', emoji: '🗑️', points: 3 },
                    { id: 'dishes', title: 'Wash the dishes', emoji: '🍽️', points: 4 },
                    { id: 'make_bed', title: 'Make the bed', emoji: '🛏️', points: 3 },
                    { id: 'desk_clean', title: 'Clean desk/workspace', emoji: '🗂️', points: 4 }
                ]
            },
            'mindfulness': {
                name: 'Mindfulness & Mental Health',
                emoji: '🧠',
                tasks: [
                    { id: 'deep_breaths', title: 'Take 5 deep breaths', emoji: '🫁', points: 2 },
                    { id: 'gratitude', title: 'Think of 3 things grateful for', emoji: '🙏🏿', points: 3 },
                    { id: 'compliment_self', title: 'Give myself a compliment', emoji: '💝', points: 3 },
                    { id: 'mindful_moment', title: 'Have a mindful moment', emoji: '🧘🏽', points: 4 },
                    { id: 'phone_before_bed', title: 'Stay off of phone an hour before bed', emoji: '📵', points: 5 }
                ]
            }
        };



        // Achievements
        const achievements = [
            // Starter Tier (💚)
            { id: 'task_sprout', name: 'Task Sprout', desc: 'Complete your first regular task', icon: '🌱', requirement: 1, type: 'tasks', tier: 'starter' },
            { id: 'quick_spark', name: 'Quick Spark', desc: 'Complete 3 quick tasks in one day', icon: '⚡', requirement: 3, type: 'quick_daily', tier: 'starter' },
            { id: 'momentum_builder', name: 'Momentum Builder', desc: 'Complete 5 tasks in one session', icon: '🚀', requirement: 5, type: 'session', tier: 'starter' },
            { id: 'early_bird', name: 'Early Bird', desc: 'Complete a task before 10 AM', icon: '🌅', requirement: 1, type: 'early_morning', tier: 'starter' },
            { id: 'weekend_warrior', name: 'Weekend Warrior', desc: 'Complete 2 tasks on a weekend', icon: '🏖️', requirement: 2, type: 'weekend', tier: 'starter' },
            { id: 'consistency_rookie', name: 'Consistency Rookie', desc: '3-day task streak', icon: '🔥', requirement: 3, type: 'streak', tier: 'starter' },
            { id: 'zen_mode', name: 'Zen Mode', desc: 'All daily tasks before noon', icon: '🧘', requirement: 1, type: 'before_noon', tier: 'starter' },
            { id: 'first_flame', name: 'First Flame', desc: 'Earn 100 XP', icon: '✨', requirement: 100, type: 'xp', tier: 'starter' },
            { id: 'quickfire_pro', name: 'Quickfire Pro', desc: '10 quick tasks total', icon: '⚡', requirement: 10, type: 'quick_total', tier: 'starter' },
            { id: 'balanced_start', name: 'Balanced Start', desc: 'One quick + one regular task in a day', icon: '⚖️', requirement: 1, type: 'balanced_day', tier: 'starter' },
            
            // Intermediate Tier (💙)
            { id: 'task_commander', name: 'Task Commander', desc: '10 work tasks', icon: '💼', requirement: 10, type: 'tasks', tier: 'intermediate' },
            { id: 'focus_flow', name: 'Focus Flow', desc: '5 tasks without leaving app', icon: '🎯', requirement: 5, type: 'session', tier: 'intermediate' },
            { id: 'habit_maker', name: 'Habit Maker', desc: '5-day task streak', icon: '🔥', requirement: 5, type: 'streak', tier: 'intermediate' },
            { id: 'productivity_pulse', name: 'Productivity Pulse', desc: '50% weekly completion rate', icon: '📊', requirement: 50, type: 'completion_rate', tier: 'intermediate' },
            { id: 'quick_reflexes', name: 'Quick Reflexes', desc: 'Quick task within 60 seconds', icon: '⏱️', requirement: 1, type: 'quick_fast', tier: 'intermediate' },
            { id: 'planner_pro', name: 'Planner Pro', desc: '10 tasks in one day', icon: '📋', requirement: 10, type: 'daily_tasks', tier: 'intermediate' },
            { id: 'no_distractions', name: 'No Distractions', desc: '5 tasks without tab switching', icon: '🎯', requirement: 5, type: 'session', tier: 'intermediate' },
            { id: 'steady_hands', name: 'Steady Hands', desc: '3-day completion streak', icon: '✋', requirement: 3, type: 'streak', tier: 'intermediate' },
            { id: 'time_keeper', name: 'Time Keeper', desc: 'Complete a task exactly on time', icon: '⏰', requirement: 1, type: 'on_time', tier: 'intermediate' },
            { id: 'goal_crusher', name: 'Goal Crusher', desc: 'All tasks done 3 days in a row', icon: '💪', requirement: 3, type: 'all_tasks_streak', tier: 'intermediate' },
            
            // Advanced Tier (💛)
            { id: 'master_balance', name: 'Master of Balance', desc: 'Equal quick + regular tasks in a week', icon: '⚖️', requirement: 1, type: 'balanced_week', tier: 'advanced' },
            { id: 'daily_challenger', name: 'Daily Challenger', desc: '7 daily challenges', icon: '🏆', requirement: 7, type: 'challenges', tier: 'advanced' },
            { id: 'midnight_focus', name: 'Midnight Focus', desc: 'Task between 12-3 AM', icon: '🌙', requirement: 1, type: 'midnight', tier: 'advanced' },
            { id: 'task_marathoner', name: 'Task Marathoner', desc: '50 total tasks', icon: '🏃', requirement: 50, type: 'tasks', tier: 'advanced' },
            { id: 'quickstorm', name: 'Quickstorm', desc: '25 quick tasks', icon: '⚡', requirement: 25, type: 'quick_total', tier: 'advanced' },
            { id: 'planner_legend', name: 'Planner Legend', desc: '7-day streak', icon: '🔥', requirement: 7, type: 'streak', tier: 'advanced' },
            { id: 'efficiency_expert', name: 'Efficiency Expert', desc: '5 high-priority tasks in a day', icon: '⭐', requirement: 5, type: 'high_priority_day', tier: 'advanced' },
            { id: 'xp_collector', name: 'XP Collector', desc: '1000 XP total', icon: '💎', requirement: 1000, type: 'xp', tier: 'advanced' },
            { id: 'unstoppable_force', name: 'Unstoppable Force', desc: '100 total tasks', icon: '🚀', requirement: 100, type: 'tasks', tier: 'advanced' },
            { id: 'legend_of_focus', name: 'Legend of Focus', desc: '30-day streak', icon: '🔥', requirement: 30, type: 'streak', tier: 'advanced' }
        ];

        // Load game state from localStorage
        function loadGameState() {
            const saved = localStorage.getItem('taskRockGameState');
            if (saved) {
                const parsedState = JSON.parse(saved);
                gameState = { ...gameState, ...parsedState };
                window.gameState = gameState; // Update window reference
                
                // Ensure selectedQuickTasks exists
                if (!gameState.selectedQuickTasks) {
                    gameState.selectedQuickTasks = [];
                }
                
                // Ensure completedQuickTasks exists
                if (!gameState.completedQuickTasks) {
                    gameState.completedQuickTasks = [];
                }
                
                // Migration: Initialize totalTasksCreated for existing users
                if (typeof gameState.totalTasksCreated === 'undefined') {
                    gameState.totalTasksCreated = gameState.completedTasks + gameState.tasks.length;
                }
                
                // Ensure totalTasksCreated is never less than completedTasks
                if (gameState.totalTasksCreated < gameState.completedTasks) {
                    gameState.totalTasksCreated = gameState.completedTasks;
                }
                
                // Migration: Initialize new stats for existing users
                if (typeof gameState.battlesWon === 'undefined') {
                    gameState.battlesWon = 0;
                }
                if (typeof gameState.battlesLost === 'undefined') {
                    gameState.battlesLost = 0;
                }
                if (typeof gameState.questQuizzesPassed === 'undefined') {
                    gameState.questQuizzesPassed = 0;
                }
                if (typeof gameState.questQuizzesFailed === 'undefined') {
                    gameState.questQuizzesFailed = 0;
                }
                if (typeof gameState.questTasksAccepted === 'undefined') {
                    gameState.questTasksAccepted = 0;
                }
                if (typeof gameState.questTasksOffered === 'undefined') {
                    gameState.questTasksOffered = 0;
                }
                
                // Migration: Ensure health is never 0 (fix for existing users)
                if (!gameState.health || gameState.health === 0) {
                    gameState.health = 75; // Reset to default
                }
                
                // Migration: Initialize achievement tracking for existing users
                if (typeof gameState.achievementProgress === 'undefined') {
                    gameState.achievementProgress = {};
                }
                if (typeof gameState.quickTaskStartTimes === 'undefined') {
                    gameState.quickTaskStartTimes = {};
                }
                if (typeof gameState.sessionTaskCount === 'undefined') {
                    gameState.sessionTaskCount = 0;
                }
                if (typeof gameState.sessionStartTime === 'undefined') {
                    gameState.sessionStartTime = null;
                }
                if (typeof gameState.tasksCompletedToday === 'undefined') {
                    gameState.tasksCompletedToday = [];
                }
                if (typeof gameState.weekendTasksCompleted === 'undefined') {
                    gameState.weekendTasksCompleted = 0;
                }
                if (typeof gameState.allTasksStreakDays === 'undefined') {
                    gameState.allTasksStreakDays = 0;
                }
                if (typeof gameState.lastAllTasksDate === 'undefined') {
                    gameState.lastAllTasksDate = null;
                }
            }
            
            // Sync monster name from onboarding if it exists
            const monsterName = localStorage.getItem('monsterName');
            if (monsterName) {
                gameState.rockName = monsterName;
            }
            
            // Load and apply monster sprite
            const spritePrefix = localStorage.getItem('heroSpritePrefix');
            if (spritePrefix) {
                const mainHeroSprite = document.getElementById('mainHeroSprite');
                if (mainHeroSprite) {
                    mainHeroSprite.src = `assets/heroes/${spritePrefix}_Idle_4.png`;
                    // Show sprite after correct image is loaded
                    mainHeroSprite.style.opacity = '1';
                }
            } else {
                // If no sprite selected yet, show default (Pink Monster)
                const mainHeroSprite = document.getElementById('mainHeroSprite');
                if (mainHeroSprite) {
                    mainHeroSprite.style.opacity = '1';
                }
            }
        }

        // Save game state to localStorage
        function saveGameState() {
            localStorage.setItem('taskRockGameState', JSON.stringify(gameState));
        }

        // Check and update energy based on pending/overdue tasks
        function checkAndUpdateEnergy() {
            if (!gameState || !gameState.tasks) return;
            
            // Skip if potion was just used to prevent immediate drain
            if (window.justUsedPotion) return;
            
            const now = Date.now();
            const pendingTasks = gameState.tasks.filter(t => !t.completed && t.dueDate);
            
            if (pendingTasks.length === 0) {
                // No pending tasks with due dates - energy should be at 100
                if (gameState.health < 100) {
                    gameState.health = Math.min(100, gameState.health + 1);
                    saveGameState();
                }
                return;
            }
            
            let energyDrain = 0;
            
            pendingTasks.forEach(task => {
                const dueDate = new Date(task.dueDate).getTime();
                const timeUntilDue = dueDate - now;
                const hoursUntilDue = timeUntilDue / (1000 * 60 * 60);
                
                // Energy drain based on how close the due date is
                if (timeUntilDue < 0) {
                    // Overdue - severe drain
                    const hoursOverdue = Math.abs(hoursUntilDue);
                    if (hoursOverdue > 24) {
                        energyDrain += 15; // Very overdue
                    } else if (hoursOverdue > 12) {
                        energyDrain += 10; // Quite overdue
                    } else {
                        energyDrain += 5; // Recently overdue
                    }
                } else if (hoursUntilDue <= 2) {
                    // Due within 2 hours - high urgency
                    energyDrain += 8;
                } else if (hoursUntilDue <= 8) {
                    // Due within 8 hours - moderate urgency
                    energyDrain += 5;
                } else if (hoursUntilDue <= 24) {
                    // Due within 24 hours - low urgency
                    energyDrain += 2;
                }
            });
            
            // Apply energy drain (cap at reasonable amount per check)
            if (energyDrain > 0) {
                const maxDrainPerCheck = 30; // Don't drain more than 30 per check
                energyDrain = Math.min(energyDrain, maxDrainPerCheck);
                gameState.health = Math.max(0, gameState.health - energyDrain);
                saveGameState();
            }
        }

        // Update UI elements
        function updateUI() {
            // Update header info (unified level | name)
            const levelLabel = document.getElementById('levelLabel');
            if (levelLabel) {
                levelLabel.textContent = `${gameState.rockName} | Level ${gameState.jerryLevel || 1}`;
            }
            
            // Update RPG Gauges
            const health = gameState.health || 75;
            const completedTasks = gameState.completedTasks || 0;
            const currentStreak = gameState.currentStreak || 0;
            const level = gameState.jerryLevel || 1;
            const currentXP = gameState.jerryXP || 0;
            const xpToNext = 1000 * level;
            
            // Energy (Health)
            document.getElementById('energyFill').style.width = `${health}%`;
            document.getElementById('energyText').textContent = `${health}/100`;
            
            // Attack (fixed at 100)
            const attack = 100;
            document.getElementById('attackFill').style.width = `${attack}%`;
            document.getElementById('attackText').textContent = `${attack}/100`;
            
            // Defense (fixed at 100)
            const defense = 100;
            document.getElementById('defenseFill').style.width = `${defense}%`;
            document.getElementById('defenseText').textContent = `${defense}/100`;
            
            // Level text (now handled in unified levelLabel above)
            
            // XP Bar
            const xpPercentage = Math.min(100, (currentXP / xpToNext) * 100);
            document.getElementById('xpFill').style.width = `${xpPercentage}%`;
            document.getElementById('xpText').textContent = `${currentXP.toLocaleString()} / ${xpToNext.toLocaleString()} XP`;
            
            // Calculate comprehensive stats
            const activeTasks = gameState.tasks.filter(task => !task.completed);
            const pendingTasks = activeTasks.length;
            const quickTasks = (gameState.selectedQuickTasks || []).length;
            const completedQuickTasks = (gameState.completedQuickTasks || []).length;
            const totalTasks = gameState.totalTasksCreated || 0;
            const completionRate = totalTasks > 0 ? Math.round((completedTasks / totalTasks) * 100) : 0;
            const bestStreak = gameState.bestStreak || gameState.longestStreak || 0;
            const rockLevel = level;
            const nextLevelXP = xpToNext;
            
            // Calculate achievements
            let unlockedAchievements = 0;
            if (window.achievementTracker) {
                window.achievementTracker.checkAchievements();
                achievements.forEach(achievement => {
                    if (window.achievementTracker.isAchievementUnlocked(achievement.id)) {
                        unlockedAchievements++;
                    }
                });
            }
            
            // Update collapsed stats
            const quickTasksEl = document.getElementById('quickTasksDisplay');
            const pendingTasksEl = document.getElementById('pendingTasksDisplay');
            const completedTasksEl = document.getElementById('completedTasksDisplay');
            
            if (quickTasksEl) quickTasksEl.textContent = quickTasks;
            if (pendingTasksEl) pendingTasksEl.textContent = pendingTasks;
            if (completedTasksEl) completedTasksEl.textContent = completedTasks;
            
            // Update expanded stats
            const quickTasksExpEl = document.getElementById('quickTasksDisplayExp');
            const completedQuickTasksExpEl = document.getElementById('completedQuickTasksDisplayExp');
            const pendingTasksExpEl = document.getElementById('pendingTasksDisplayExp');
            const completedTasksExpEl = document.getElementById('completedTasksDisplayExp');
            const completionRateEl = document.getElementById('completionRateDisplay');
            const totalTasksEl = document.getElementById('totalTasksDisplay');
            const currentStreakEl = document.getElementById('currentStreakDisplay');
            const bestStreakEl = document.getElementById('bestStreakDisplay');
            const rockLevelEl = document.getElementById('rockLevelDisplay');
            const experienceEl = document.getElementById('experienceDisplay');
            const achievementsEl = document.getElementById('achievementsDisplay');
            
            if (quickTasksExpEl) quickTasksExpEl.textContent = quickTasks;
            if (completedQuickTasksExpEl) completedQuickTasksExpEl.textContent = completedQuickTasks;
            if (pendingTasksExpEl) pendingTasksExpEl.textContent = pendingTasks;
            if (completedTasksExpEl) completedTasksExpEl.textContent = completedTasks;
            if (completionRateEl) {
                completionRateEl.textContent = `${completionRate}%`;
                // Add low completion warning if rate is below 50% and user has created tasks
                const completionTile = completionRateEl.closest('.stat-tile');
                if (completionTile) {
                    if (completionRate < 50 && totalTasks > 0) {
                        completionTile.classList.add('low-completion');
                    } else {
                        completionTile.classList.remove('low-completion');
                    }
                }
            }
            if (totalTasksEl) totalTasksEl.textContent = totalTasks;
            if (currentStreakEl) currentStreakEl.textContent = currentStreak;
            if (bestStreakEl) bestStreakEl.textContent = bestStreak;
            if (rockLevelEl) rockLevelEl.textContent = rockLevel;
            if (experienceEl) experienceEl.textContent = `${currentXP}/${nextLevelXP} XP`;
            if (achievementsEl) achievementsEl.textContent = `${unlockedAchievements}/${achievements.length}`;
            
            // Update new battle and quest stats
            const battlesWonEl = document.getElementById('battlesWonDisplay');
            const battlesLostEl = document.getElementById('battlesLostDisplay');
            const quizPassedEl = document.getElementById('quizPassedDisplay');
            const quizFailedEl = document.getElementById('quizFailedDisplay');
            const questAcceptanceEl = document.getElementById('questAcceptanceDisplay');
            
            if (battlesWonEl) battlesWonEl.textContent = gameState.battlesWon || 0;
            if (battlesLostEl) battlesLostEl.textContent = gameState.battlesLost || 0;
            if (quizPassedEl) quizPassedEl.textContent = gameState.questQuizzesPassed || 0;
            if (quizFailedEl) quizFailedEl.textContent = gameState.questQuizzesFailed || 0;
            if (questAcceptanceEl) {
                const offered = gameState.questTasksOffered || 0;
                const accepted = gameState.questTasksAccepted || 0;
                const acceptanceRate = offered > 0 ? Math.round((accepted / offered) * 100) : 0;
                questAcceptanceEl.textContent = `${acceptanceRate}%`;
            }
            
            // Update creature image based on equipped items
            updateCreatureImage();
            
            // Update daily challenge display
            updateDailyChallengeDisplay();
            
            // Update shop display to refresh equipped status
            updateShopDisplay();
            
            // Update Task Pal tooltip
            updateTooltip(health, gameState.tasks || []);
        }

        // ===============================
        // 🪨 CATEGORY-AWARE TOOLTIP SYSTEM
        // ===============================
        let userName = localStorage.getItem('userName') || "";

        // Phrase libraries by category
        const categoryPhrases = {
            work: [
                "Let's get that productivity flowing 💼",
                "Another win for the team, {name}!",
                "You're bossing this project 💻",
                "Emails, meetings, and progress—let's go!",
                "A focused mind is your best tool 🔧",
                "Work vibes are strong today ⚡",
                "You're making moves, {name}!",
                "Great things come from small, consistent effort.",
                "Keep that workflow rolling!",
                "Time to show your skills, {name}!"
            ],
            learning: [
                "Knowledge boost incoming 🎓",
                "Brains loading... complete! 🧠",
                "Smart move, {name} — every study counts.",
                "Curiosity looks good on you 👀",
                "Each page turns you into a powerhouse 📘",
                "Let's learn something amazing today!",
                "You're leveling up your brain XP 📚",
                "Stay curious, stay sharp ✨",
                "Knowledge is your weapon today!",
                "Your focus is unmatched, {name}!"
            ],
            home: [
                "Home base needs your magic 🏠",
                "Clean space, clear mind 🧺",
                "Small chores, big peace ✨",
                "That's how a champion does it, {name}!",
                "Order brings calm 🕯️",
                "Your environment is leveling up 💫",
                "Tidying today = peaceful tomorrow.",
                "You're turning home into a haven 💖",
                "Every task brings comfort closer.",
                "Smells like progress, {name}!"
            ],
            finance: [
                "Let's secure that bag 💰",
                "Smart money move, {name}! 🧮",
                "Every dollar has a mission.",
                "Budgeting = self-care 💳",
                "You're building future freedom!",
                "The spreadsheet gods salute you 📊",
                "That's wealth-builder energy 💎",
                "Financial XP gained!",
                "Money discipline unlocks power 💼",
                "Keep stacking smart wins, {name}!"
            ],
            goals: [
                "Goal mode: activated 🎯",
                "Another step toward greatness, {name}!",
                "Dreams → Action → Progress 💫",
                "Focus on the horizon 🌅",
                "Every tap brings you closer.",
                "Small goals stack into big wins 🪨",
                "You're unstoppable when you plan 💪",
                "Keep aiming true, {name}!",
                "Success is compounding 🔁",
                "Future you is proud already."
            ],
            projects: [
                "Blueprints of success loading 🛠️",
                "You're building something amazing, {name}!",
                "Creativity meets focus 🔥",
                "Every block builds the bigger picture 🧩",
                "Let's make progress visible today.",
                "Innovation XP earned 💡",
                "Keep crafting your vision!",
                "Project momentum: 100% ⚙️",
                "The details matter — and you're nailing them.",
                "You're a maker of great things, {name}!"
            ],
            generic: [
                "Keep going, {name}! ⚡",
                "Every task fuels your growth!",
                "You're doing great work!",
                "Another win on your quest! 🗺️",
                "Stay focused and keep pushing!",
                "You're leveling up with every action 💥",
                "The quest continues!",
                "You're crushing it, hero! 🧭",
                "Your consistency is your strength.",
                "Let's make today count!"
            ]
        };

        // Helper functions
        function getCategoryPhrases(category) {
            return categoryPhrases[category] || categoryPhrases.generic;
        }

        function getRandomPhrase(category) {
            const phrases = getCategoryPhrases(category);
            const phrase = phrases[Math.floor(Math.random() * phrases.length)];
            return userName ? phrase.replace("{name}", userName) : phrase.replace("{name}", "");
        }

        function showCategoryTooltip(category) {
            const tooltip = document.getElementById('taskPalTooltip');
            const message = getRandomPhrase(category);
            tooltip.textContent = message.trim();
            tooltip.classList.add('visible');
            setTimeout(() => tooltip.classList.remove('visible'), 10000);
        }

        function onTaskAdded(category) {
            showCategoryTooltip(category);
        }

        function onTaskCompleted(category) {
            showCategoryTooltip(category);
        }

        function saveUserName(value) {
            localStorage.setItem('userName', value.trim());
            userName = value.trim();
        }

        // Fallback: show a generic tooltip every few minutes
        setInterval(() => showCategoryTooltip('generic'), 180000);

        // ===============================
        // 😊 UPGRADED MOOD TRACKER SYSTEM
        // ===============================
        const moodPhrases = {
            happy: [
                "So happy you're feeling good! ☀️",
                "You're shining today!",
                "Keep that energy up!",
                "Awesome mood! 🚀",
                "That smile suits you 😄",
                "Radiating positive vibes! ✨",
                "Your energy is contagious! 💫",
                "Love seeing you happy! 🌟",
                "You're on fire today! 🔥",
                "Keep spreading that joy! 🌈"
            ],
            sad: [
                "You’ve got this — tough moments don’t last! 🌟",
                "Even small steps count 💪",
                "I believe in you — tomorrow’s a fresh start 🌱",
                "You are stronger than you know 💖",
                "Be gentle with yourself 🤗",
                "One task at a time is all it takes.",
                "I'm here for you, [UserName]. We'll get through this.",
                "The sun always rises again ☀️",
                "Progress, not perfection, is the goal.",
                "Sending you good energy 💜"
            ],
            mad: [
                "Oh no! I didn't mean to upset you 😔",
                "Let's cool off a bit 💨",
                "Deep breath — we've got this 🤝",
                "It'll pass, promise ❤️",
                "You're stronger than you think 💪",
                "Take a moment for yourself 🧘",
                "Let's channel that energy productively ⚡",
                "It's okay to feel frustrated 🌪️",
                "You're allowed to be upset 💭",
                "Let's work through this together 🤲"
            ]
        };

        let phraseHistory = { happy: [], sad: [], mad: [] };

        function getRandomPhrase(mood) {
            const phrases = moodPhrases[mood];
            let availablePhrases = phrases.filter(p => !phraseHistory[mood].includes(p));
            
            if (availablePhrases.length === 0) {
                phraseHistory[mood] = [];
                availablePhrases = phrases;
            }
            
            const selected = availablePhrases[Math.floor(Math.random() * availablePhrases.length)];
            phraseHistory[mood].push(selected);
            
            if (phraseHistory[mood].length > 5) {
                phraseHistory[mood].shift();
            }
            
            return selected;
        }

        window.showMoodTracker = function() {
            const tooltip = document.getElementById("taskPalTooltip");
            if (!tooltip) return;
            
            tooltip.innerHTML = `
                How are you feeling?  
                <div class="mood-options">
                    <button onclick="selectMood('happy')">😊</button>
                    <button onclick="selectMood('sad')">😢</button>
                    <button onclick="selectMood('discouraged')">🫤</button>
                    <button onclick="selectMood('mad')">😡</button>
                </div>
            `;
            tooltip.classList.add("visible");
// Tooltip remains visible until user selection and is then replaced by mood message
        }

        // Helper function to get current sprite prefix
        function getCurrentSpritePrefix() {
            return localStorage.getItem('heroSpritePrefix') || 'Pink_Monster';
        }

        window.selectMood = function(moodKey) {
            const tooltip = document.getElementById("taskPalTooltip");
            const hero = document.getElementById("mainHeroSprite");
            const spritePrefix = getCurrentSpritePrefix();
            
            localStorage.setItem("userMood", moodKey);
            
            let message;
            if (moodKey === 'sad' || moodKey === 'discouraged') {
                message = getRandomPhrase('sad'); // Use 'sad' phrases for 'discouraged'
            } else {
                message = getRandomPhrase(moodKey);
            }
            tooltip.innerText = message;
            setTimeout(() => tooltip.classList.remove("visible"), 10000);
            
            // Update creature animation
            if (moodKey === "happy") {
                // Jump animation for 2 seconds
                if (hero) {
                    hero.src = `assets/heroes/${spritePrefix}_Jump_8.png`;
                    hero.style.animation = "hero-jump-anim 0.8s steps(8) infinite";
                    
                    // Return to idle after 2 seconds
                    setTimeout(() => {
                        if (hero) {
                            hero.src = `assets/heroes/${spritePrefix}_Idle_4.png`;
                            hero.style.animation = "hero-idle-anim 0.8s steps(4) infinite";
                        }
                    }, 2000);
                }
            } else if (moodKey === "sad" || moodKey === "mad") {
                // Hurt animation for 2 seconds
                if (hero) {
                    hero.src = `assets/heroes/${spritePrefix}_Hurt_4.png`;
                    hero.style.animation = "hero-hurt-anim 0.4s steps(4) infinite";
                    
                    // Return to idle after 2 seconds
                    setTimeout(() => {
                        if (hero) {
                            hero.src = `assets/heroes/${spritePrefix}_Idle_4.png`;
                            hero.style.animation = "hero-idle-anim 0.8s steps(4) infinite";
                        }
                    }, 2000);
                }
                // Reduce energy if sad/mad and tasks due within 8 hours
                if (gameState && gameState.tasks) {
                    const now = Date.now();
                    const eightHoursFromNow = now + (8 * 60 * 60 * 1000);
                    const hasPendingTasks = gameState.tasks.some(t => 
                        !t.completed && t.dueDate && 
                        new Date(t.dueDate).getTime() <= eightHoursFromNow
                    );
                    
                    if (hasPendingTasks && gameState.health > 3) {
                        gameState.health = Math.max(0, gameState.health - 3);
                        saveGameState();
                        updateUI();
                    }
                }
            }
            // No animation for 'discouraged' mood
            
            // Update mood emoji display
            updateMoodDisplay(moodKey);
            

        }

        function updateMoodDisplay(moodKey) {
            const moodEmojis = { happy: "😊", sad: "😢", mad: "😡" };
            const emoji = moodEmojis[moodKey] || "😐";
            
            let moodDisplay = document.getElementById("moodDisplay");
            if (!moodDisplay) {
                const energyLabel = document.querySelector('.stat-label');
                if (energyLabel && energyLabel.textContent.includes('Energy')) {
                    moodDisplay = document.createElement('span');
                    moodDisplay.id = 'moodDisplay';
                    moodDisplay.style.marginLeft = '8px';
                    energyLabel.appendChild(moodDisplay);
                }
            }
            
            if (moodDisplay) {
                moodDisplay.textContent = emoji;
            }
        }

        // Show mood tracker every 2 hours
// setInterval(showMoodTracker, 2 * 60 * 60 * 1000); // Removed to prevent auto-hide
        
        // Preload jump sprite to prevent lag
        const jumpSpritePreload = new Image();
        jumpSpritePreload.src = "assets/heroes/Pink_Monster_Jump_8.png";
        
        // On page load, restore saved mood and show tracker
        window.addEventListener("load", () => {
            const savedMood = localStorage.getItem("userMood");
            const hero = document.getElementById("mainHeroSprite");
            
            // Always start with idle animation on page load
            if (hero) {
                hero.src = "assets/heroes/hero-idle.png";
                hero.style.animation = "hero-idle-anim 0.8s steps(4) infinite";
            }
            
            // Update mood display emoji only
            if (savedMood) {
                updateMoodDisplay(savedMood);
            } else {
                updateMoodDisplay(null);
            }
            
            // Show mood tracker immediately on load
            showMoodTracker();
        });

        // Update Task Pal Tooltip
        function updateTooltip(energy, tasks) {
            const tooltip = document.getElementById("taskPalTooltip");
            if (!tooltip) return;
            
            const now = Date.now();
            const hasOverdue = tasks.some(t => !t.completed && t.dueDate && new Date(t.dueDate).getTime() < now);
            const dueSoon = tasks.some(t => !t.completed && t.dueDate && new Date(t.dueDate).getTime() - now < 3600000);
            let message = "";

            if (energy === 0) message = "💀 I'm out of energy — complete tasks to revive me.";
            else if (hasOverdue) message = "⚠️ Tasks are overdue! I'm losing energy fast!";
            else if (dueSoon) message = "⏰ You've got tasks due soon — let's handle them!";
            else if (energy <= 25) message = "🥱 I need a boost — finish a task to help me recover!";
            else if (energy < 60) message = "🙂 I'm doing okay, but a few wins would help!";
            else message = "💪 I'm feeling strong — keep the streak going!";

            tooltip.textContent = message;
            tooltip.classList.add("visible");
            
            // Update hero sprite based on energy level
            const heroSprite = document.getElementById("heroSprite");
            if (heroSprite) {
                if (energy <= 30) {
                    // Low health - show hurt animation
                    heroSprite.src = "assets/heroes/hero-hurt.png";
                    heroSprite.style.animation = "hero-hurt-anim 0.8s steps(4) infinite";
                } else {
                    // Normal health - show idle animation
                    heroSprite.src = "assets/heroes/hero-idle.png";
                    heroSprite.style.animation = "hero-idle-anim 0.8s steps(4) infinite";
                }
            }
            
            // Auto-hide after 50 seconds
            setTimeout(() => tooltip.classList.remove("visible"), 10000);
        }

        // Update creature image based on equipped items
        function updateCreatureImage() {
            const creatureImg = document.getElementById('creatureImage');
            if (!creatureImg) return;
            
            // Determine the image source based on equipped items
            let imageSrc = 'assets/Jerry-Default.png'; // Default image
            
            // Check if any hat is equipped
            if (gameState.currentOutfit && gameState.currentOutfit.hat) {
                const equippedHat = gameState.currentOutfit.hat;
                
                // Map hat IDs to image files
                const hatImageMap = {
                    'black_top_hat': 'assets/Jerry-TopHat.png',
                    'wizard_hat': 'assets/Jerry-WizardHat.png'
                };
                
                if (hatImageMap[equippedHat]) {
                    imageSrc = hatImageMap[equippedHat];
                }
            }
            
            // Check if any paint job is equipped
            if (gameState.currentOutfit && gameState.currentOutfit.paint) {
                const equippedPaint = gameState.currentOutfit.paint;
                
                // Map paint IDs to image files (these would override hat images if both are equipped)
                const paintImageMap = {
                    'golden_paint': 'assets/Jerry-Golden.png',
                    'rainbow_paint': 'assets/Jerry-Rainbow.png'
                };
                
                if (paintImageMap[equippedPaint]) {
                    imageSrc = paintImageMap[equippedPaint];
                }
            }
            
            // Update the image source
            creatureImg.src = imageSrc;
        }

        // Pet Rock Dialogue System
        const DIALOGUE_DATABASE = {
            // General phrases by level ranges
            level1to5: [
                "Hey there, [UserName]! I'm still getting to know you.",
                "Thanks for taking care of me! I'm learning so much.",
                "You're doing great with those tasks!",
                "I love watching you work on your goals.",
                "Keep it up! We make a great team.",
                "Every task completed makes me stronger!",
                "I'm so proud of your progress, [UserName].",
                "You're building such good habits!",
                "I feel myself growing with each task you complete.",
                "Your dedication is inspiring!"
            ],
            level6to10: [
                "We're really getting into a groove, [UserName]!",
                "I can feel myself getting stronger every day.",
                "Your consistency is amazing to watch.",
                "I love how focused you've become!",
                "We're becoming quite the productive duo.",
                "Your task completion rate is impressive!",
                "I'm starting to feel more energetic.",
                "You're really mastering this routine thing.",
                "I can sense your confidence growing too.",
                "Together we're unstoppable!"
            ],
            level11to14: [
                "Look at us go! We're on fire, [UserName]!",
                "I feel so much more alive at this level.",
                "Your productivity skills are next level now.",
                "I'm bursting with energy thanks to you!",
                "We've built such an amazing routine together.",
                "You've become a true task master!",
                "I love how efficiently you tackle challenges now.",
                "Your growth mindset is contagious!",
                "We're proof that consistency pays off.",
                "I'm so energized by your success!"
            ],
            level15plus: [
                "We're legends now, [UserName]! Absolutely legendary!",
                "I feel incredibly powerful at this level!",
                "Your mastery of productivity is inspiring to witness.",
                "We've achieved something truly special together.",
                "I'm radiating with energy and wisdom now!",
                "You've become a productivity guru!",
                "Our bond has reached peak performance levels.",
                "I feel like I could move mountains with you!",
                "We're the ultimate productivity partnership!",
                "Your dedication has transformed us both!"
            ],
            
            // Task completion responses by category
            taskComplete: {
                'Physical Activity': [
                    "Great workout, [UserName]! I can feel the energy boost!",
                    "Physical activity completed! Your body and I both thank you.",
                    "Nice movement session! Keeping active keeps us both strong.",
                    "Exercise done! I love when you take care of your body.",
                    "Physical task crushed! You're building strength inside and out.",
                    "Fitness goal achieved! Your dedication to health is amazing.",
                    "Movement mastered! I feel energized by your activity.",
                    "Exercise conquered! You're a fitness champion.",
                    "Physical challenge demolished! Your strength is inspiring.",
                    "Workout complete! We're both feeling stronger now.",
                    "Active task finished! Your commitment to fitness rocks.",
                    "Physical goal smashed! You're unstoppable.",
                    "Exercise session done! I love your healthy lifestyle.",
                    "Movement task crushed! Your body thanks you.",
                    "Fitness achievement unlocked! You're on fire!"
                ],
                'Self-Care & Wellness': [
                    "Self-care complete! Taking care of yourself helps me too.",
                    "Wellness task done! You're glowing, [UserName]!",
                    "Great self-care choice! We both feel refreshed now.",
                    "Wellness achieved! Your well-being is my well-being.",
                    "Self-care success! You deserve all this good energy.",
                    "Self-love practiced! You're radiating positive energy.",
                    "Wellness goal reached! Your health is our priority.",
                    "Self-care mastered! You're treating yourself right.",
                    "Wellness task conquered! Your glow is undeniable.",
                    "Self-care champion! You deserve this moment.",
                    "Wellness achieved! Your self-love inspires me.",
                    "Self-care complete! You're investing in yourself.",
                    "Wellness success! Your balance is beautiful.",
                    "Self-care finished! You're worth every moment.",
                    "Wellness unlocked! Your health journey is amazing."
                ],
                'Learning & Growth': [
                    "Learning task complete! I love growing smarter with you.",
                    "Knowledge gained! We're both expanding our horizons.",
                    "Education task done! Your curiosity feeds my wisdom.",
                    "Learning achieved! Together we're becoming unstoppable.",
                    "Growth task complete! I feel more enlightened already."
                ],
                'Work & Productivity': [
                    "Work task completed! Your productivity powers are strong.",
                    "Professional task done! You're crushing your career goals.",
                    "Work success! I'm proud of your professional dedication.",
                    "Productivity task complete! We make an efficient team.",
                    "Work task finished! Your focus is truly impressive."
                ],
                'Creative & Hobbies': [
                    "Creative task complete! Your imagination energizes me.",
                    "Hobby time done! I love when you explore your passions.",
                    "Creative success! Your artistic spirit is contagious.",
                    "Hobby task finished! Following your interests makes us both happy.",
                    "Creative task complete! Your creativity is inspiring."
                ],
                'Social & Relationships': [
                    "Social task complete! Connections make life richer.",
                    "Relationship task done! Your social energy is wonderful.",
                    "Social success! Building bonds strengthens us both.",
                    "Connection task complete! I love your caring nature.",
                    "Social task finished! Your relationships are precious."
                ],
                'Household & Organization': [
                    "Household task complete! A tidy space makes a happy rock.",
                    "Organization done! I love when everything has its place.",
                    "Cleaning task finished! A clean environment energizes me.",
                    "Household success! Your organized space feels so peaceful.",
                    "Tidy task complete! Order and cleanliness are beautiful."
                ],
                'default': [
                    "Task complete! Another step toward your goals.",
                    "Well done! Every completed task makes us stronger.",
                    "Success! You're building amazing momentum.",
                    "Task finished! I'm proud of your dedication.",
                    "Great job! Your consistency is paying off.",
                    "Awesome work! You're on a roll!",
                    "Task conquered! Nothing can stop us now.",
                    "Fantastic! Your progress is incredible.",
                    "Mission accomplished! Let's keep this energy going.",
                    "Brilliant! You're crushing your goals.",
                    "Task demolished! Your determination is inspiring.",
                    "Outstanding! We make such a great team.",
                    "Phenomenal work! You're unstoppable.",
                    "Task mastered! Your skills are leveling up.",
                    "Incredible! Every task brings us closer to greatness.",
                    "Superb execution! You're a productivity champion.",
                    "Task annihilated! Your focus is unmatched.",
                    "Marvelous! You're building an empire of success.",
                    "Task obliterated! Nothing stands in your way.",
                    "Spectacular! Your dedication knows no bounds."
                ]
            },
            
            // Time-based contextual responses
            timeOfDay: {
                morning: [
                    "Good morning, [UserName]! Ready to rock this day?",
                    "Morning energy is the best energy! Let's do this!",
                    "Rise and shine! I'm excited for today's adventures.",
                    "Morning, [UserName]! Your early productivity inspires me.",
                    "Good morning! Starting strong sets the tone for success.",
                    "Early bird gets the worm! Great morning start!",
                    "Morning magic! You're crushing it before noon.",
                    "Sunrise productivity! Your morning routine is amazing.",
                    "Fresh morning energy! Let's conquer this day.",
                    "Morning champion! You're starting the day right.",
                    "Dawn warrior! Your early dedication is inspiring.",
                    "Morning momentum! You're setting the pace perfectly.",
                    "Bright and early! Your morning hustle is impressive.",
                    "Morning excellence! You're making today count.",
                    "Sunrise success! Your morning energy is contagious."
                ],
                afternoon: [
                    "Afternoon productivity session! I love your consistency.",
                    "Midday momentum! You're keeping the energy flowing.",
                    "Afternoon tasks are my favorite - steady and focused!",
                    "Great afternoon work, [UserName]! Keep it rolling.",
                    "Afternoon achievement unlocked! You're on fire today.",
                    "Midday mastery! You're maintaining great momentum.",
                    "Afternoon excellence! Your consistency is remarkable.",
                    "Lunch time productivity! You're not slowing down.",
                    "Midday magic! You're powering through beautifully.",
                    "Afternoon champion! Your dedication never wavers.",
                    "Peak performance! Afternoon tasks are your strength.",
                    "Midday success! You're keeping the energy high.",
                    "Afternoon warrior! Your focus is unwavering.",
                    "Steady afternoon progress! You're unstoppable.",
                    "Midday momentum master! You're crushing it."
                ],
                evening: [
                    "Evening tasks! Ending the day productively feels great.",
                    "Night owl productivity! I admire your dedication.",
                    "Evening completion! What a satisfying way to wrap up.",
                    "Late day tasks done! You're finishing strong, [UserName].",
                    "Evening success! Perfect way to close out the day.",
                    "Sunset productivity! You're ending on a high note.",
                    "Evening excellence! Your dedication extends all day.",
                    "Night time hustle! Your commitment is inspiring.",
                    "Evening warrior! You're finishing what you started.",
                    "Twilight triumph! Perfect way to end the day.",
                    "Late day legend! You're closing strong.",
                    "Evening momentum! You never quit, do you?",
                    "Night productivity! Your dedication is remarkable.",
                    "Sunset success! What a productive day closer.",
                    "Evening champion! You're ending the day right."
                ]
            },
            
            // Equipment responses
            equipment: {
                equip: {
                    'Classic Cap': "Looking sharp with that classic cap, [UserName]!",
                    'Beanie': "Cozy beanie! I feel so warm and stylish now.",
                    'Cowboy Hat': "Yeehaw! This cowboy hat makes me feel adventurous!",
                    'Top Hat': "Fancy! This top hat makes me feel distinguished.",
                    'Baseball Cap': "Play ball! This baseball cap is perfect for action.",
                    'Sunglasses': "Cool shades! I feel like a rock star now.",
                    'Reading Glasses': "These reading glasses make me feel so scholarly!",
                    'Party Glasses': "Party time! These glasses are fun and festive.",
                    'Bow Tie': "Classy bow tie! I'm ready for any formal occasion.",
                    'Necklace': "This necklace is beautiful! I feel so elegant.",
                    'Scarf': "Cozy scarf! Perfect for staying warm and stylish.",
                    'Red Paint': "Bold red! I feel energetic and passionate.",
                    'Blue Paint': "Cool blue! This color makes me feel calm and wise.",
                    'Green Paint': "Natural green! I feel connected to nature now.",
                    'Purple Paint': "Royal purple! I feel majestic and creative.",
                    'Yellow Paint': "Sunny yellow! This bright color fills me with joy.",
                    'Pink Paint': "Pretty pink! I feel cheerful and optimistic."
                },
                unequip: {
                    'Classic Cap': "Thanks for the style moment! Back to my natural look.",
                    'Beanie': "That was cozy! Back to my original rocky self.",
                    'Cowboy Hat': "Adventure time over! Back to regular rock mode.",
                    'Top Hat': "Fancy time complete! Returning to casual rock life.",
                    'Baseball Cap': "Game over! Back to my natural rock state.",
                    'Sunglasses': "Cool moment finished! Back to my regular vision.",
                    'Reading Glasses': "Study session over! Back to natural rock sight.",
                    'Party Glasses': "Party's over! Back to my everyday look.",
                    'Bow Tie': "Formal event complete! Back to casual rock style.",
                    'Necklace': "Elegant moment finished! Back to my simple beauty.",
                    'Scarf': "Cozy time over! Back to my natural rock texture.",
                    'Red Paint': "Bold phase complete! Back to my original color.",
                    'Blue Paint': "Cool period over! Returning to natural rock hue.",
                    'Green Paint': "Nature phase finished! Back to my true color.",
                    'Purple Paint': "Royal time complete! Back to my natural shade.",
                    'Yellow Paint': "Sunny moment over! Returning to original rock tone.",
                    'Pink Paint': "Cheerful phase finished! Back to my natural beauty."
                }
            },
            
            // Fun facts for level 15+
            funFacts: [
                "Fun fact: The oldest known rock on Earth is over 4 billion years old!",
                "Fun fact: Diamonds are just carbon atoms arranged in a crystal structure.",
                "Fun fact: The Great Wall of China used rice as mortar between stones!",
                "Fun fact: Pumice is the only rock that floats on water.",
                "Fun fact: The word 'mineral' comes from the Latin word 'minera' meaning 'mine'.",
                "Fun fact: Obsidian can be sharper than surgical steel!",
                "Fun fact: Granite contains quartz, feldspar, and mica minerals.",
                "Fun fact: Meteorites are rocks that have traveled through space!",
                "Fun fact: Limestone is formed from ancient sea creatures' shells.",
                "Fun fact: The hardest natural substance is diamond, rating 10 on Mohs scale.",
                "Fun fact: Geodes look ordinary outside but contain beautiful crystals inside!",
                "Fun fact: Marble is limestone that has been transformed by heat and pressure.",
                "Fun fact: Some rocks can be millions of years older than dinosaurs!",
                "Fun fact: Quartz crystals can generate electricity when squeezed!",
                "Fun fact: The Earth's crust is made up of tectonic plates of rock."
            ],
            
            // Idle conversation starters
            idle: [
                "How's your day going, [UserName]?",
                "I've been thinking about your goals lately.",
                "Ready to tackle some more tasks together?",
                "I love our productive partnership!",
                "What's next on your agenda?",
                "I'm here whenever you need motivation!",
                "Your progress has been amazing to watch.",
                "I feel grateful to be part of your journey.",
                "Together we can accomplish anything!",
                "What task should we conquer next?",
                
                // New motivational & supportive phrases
                "Let's crush those tasks like… well, rocks.",
                "You're unstoppable today — pebble power!",
                "That's one more step toward total task domination.",
                "Momentum looks good on you.",
                "Keep going — sedimentary success builds over time.",
                "You're leveling up faster than I can roll.",
                "Every checkmark is a sparkle in my granite heart.",
                "Hard work? My favorite kind of mineral deposit.",
                "You're rock solid — pun 100% intended.",
                "Tiny actions lead to tectonic shifts.",
                "Let's turn your to-do list into to-done dust.",
                "Progress detected. Pride levels rising.",
                "You just made productivity… igneous.",
                "I felt that one — pure quartz energy.",
                "Crystals wish they had your focus.",
                
                // Witty & conversational phrases
                "I've been sitting here all day, so you're already doing better than me.",
                "Don't take this the wrong way, but I think we rock together.",
                "Need motivation? I'll be your rolling stone.",
                "They said AI assistants would replace us… but look at me thriving.",
                "My last user left me for a lava lamp. Let's prove them wrong.",
                "You're glowing. Is that productivity or caffeine?",
                "Be honest — do I look smarter with this hat?",
                "Humans need coffee. I run on pure determination.",
                "I'd give you a high-five, but… no hands.",
                "You're my favorite human. Don't tell the others.",
                "If procrastination were a mineral, we'd both be buried.",
                "I'm 90% rock, 10% emotional support.",
                "I heard someone say 'touch grass' — does moss count?",
                "They call me a pet rock, but I prefer 'life coach in stone form.'",
                "Careful, you're making the other apps jealous.",
                
                // Productivity coaching phrases
                "Need a reset? Take one deep breath. Now go again.",
                "Try the two-minute rule: if it takes less than two minutes, do it now.",
                "Tasks love order. Let's prioritize like pros.",
                "Your focus window just opened — let's climb through it.",
                "Quick task? Quick win. Quick dopamine.",
                "Think small wins, not giant leaps. Even pebbles move mountains.",
                "You're not behind — you're recalibrating.",
                "Task fatigue? Let's chunk it down.",
                "Perfect is boring. Done is better.",
                "Let's schedule a victory dance later.",
                
                // Break & encouragement phrases
                "Time for a micro-break. Hydration check!",
                "Stretch, breathe, snack — even rocks need maintenance.",
                "Pause. Recharge. You can't pour from an empty geode.",
                "Let's call it a coffee checkpoint.",
                "You've earned a two-minute vacation from responsibility.",
                "Hey, look away from the screen for 10 seconds. Your eyes will thank you.",
                "Sometimes doing nothing is productive.",
                "I vote nap. Or cookies. Or both.",
                "Productivity = progress + rest. Trust the math.",
                "Self-care mode: activated.",
                
                // Rock shop & gamified phrases
                "Ooh, you've got points to spend! My pebble senses are tingling.",
                "That hat would look stunning on you. Yes, even the wizard one.",
                "Spend wisely… or just buy the shiny thing. I support both.",
                "Rock fashion week is upon us.",
                "Your collection's growing faster than a crystal garden.",
                "Those points are practically burning a hole in your stone pocket.",
                "New hat, new mindset.",
                "Rockstars accessorize. Fact.",
                "I'll handle the style; you handle the productivity.",
                "Let's go shopping — ethically sourced pixels only.",
                
                // Mood & personality phrases
                "Feeling inspired? Or just pretending until it works? Either way, solid plan.",
                "If vibes were currency, you'd be rich.",
                "Mood level: igneous glow.",
                "You're radiating main-character energy today.",
                "Your aura? Slightly chaotic. I love it.",
                "Let's turn that sigh into a sparkle.",
                "Bad day? We'll outlast it. Rocks always do.",
                "You're allowed to crumble — just reform stronger.",
                "I may be stone-cold, but I care.",
                "When in doubt, sediment out.",
                
                // Achievements & rewards phrases
                "Level up! You're evolving from pebble to powerhouse.",
                "Achievement unlocked: Doing The Thing™.",
                "If confetti had feelings, it'd be proud of you.",
                "Streaks like this deserve a trophy. Or at least snacks.",
                "I'm updating your rock-resume right now.",
                "Task slayer, streak breaker, legend maker.",
                "You're in rare form — metamorphic excellence.",
                "Even my minerals are cheering.",
                "Achievement vibes: unlocked and sparkling.",
                "You're officially on fire… metaphorically, I hope.",
                
                // AI-like assistant humor phrases
                "Processing your greatness… done.",
                "I may be artificial, but my admiration is real.",
                "I don't dream of electric sheep — I dream of your success.",
                "I ran your stats. Conclusion: you rock.",
                "Upgrading your motivation firmware…",
                "Calculating optimal snack-to-focus ratio.",
                "My neural pebbles predict victory.",
                "You're like an algorithm that never quits.",
                "System check: confidence at 99%.",
                "Reminder: Jerry runs best on good vibes and finished tasks.",
                
                // Random & fun easter egg phrases
                "If you're reading this, I'm proud of you.",
                "I once dated a crystal. It was too transparent.",
                "Some say I'm wise beyond my sediment.",
                "Rocks don't cry — we erode gracefully.",
                "I wrote you a poem, but it's mostly sedimentary.",
                "I remember when dinosaurs used me as a footrest.",
                "Humans evolved. I just got shinier.",
                "Rock fact: I've been alive longer than your Wi-Fi connection.",
                "Sometimes I hum 'We Will Rock You' for motivation.",
                "If you finish this next task, I'll tell you a geological secret."
            ]
        };

        // Dialogue system state
        let dialogueState = {
            lastDialogueTime: 0,
            dialogueInterval: 10 * 60 * 1000, // 10 minutes
            bubble: null,
            currentLevel: 1
        };

        // REMOVED: Old speech bubble system - replaced with tooltip
        /*
        function createSpeechBubble() {
            if (dialogueState.bubble && document.body.contains(dialogueState.bubble)) {
                return dialogueState.bubble;
            }

            const bubble = document.createElement('div');
            bubble.className = 'jerry-speech-bubble';
            bubble.setAttribute('role','status');
            bubble.setAttribute('aria-live','polite');

            // Add to pet rock container
            const petRockContainer = document.querySelector('.creature-container');
            if (petRockContainer) {
                petRockContainer.style.position = 'relative';
                petRockContainer.appendChild(bubble);
                dialogueState.bubble = bubble;

                // Click to dismiss
                bubble.addEventListener('click', hideSpeechBubble);
                
                return bubble;
            }
            return null;
        }

        */
        
        // Dummy function to prevent errors from old code references
        function showSpeechBubble(text, duration = 8000) {
            // Speech bubble removed - using tooltip system instead
            return;
        }
        
        /*
        // OLD showSpeechBubble implementation
        function _oldShowSpeechBubble(text, duration = 8000) {
            const bubble = createSpeechBubble();
            if (!bubble) return;

            // Replace tokens
            const processedText = text
                .replace(/\[UserName\]/g, gameState.playerName || 'Friend')
                .replace(/\[RockName\]/g, gameState.petRockName || 'Jerry');

            bubble.textContent = processedText;
            
            // Show bubble
            bubble.classList.add('show');
            
            // Auto-hide after duration
            setTimeout(() => {
                hideSpeechBubble();
            }, duration);
        }

        function hideSpeechBubble() {
            if (dialogueState.bubble) {
                dialogueState.bubble.classList.remove('show');
                // optional: fully remove after transition
                setTimeout(() => {
                    if (dialogueState.bubble && !dialogueState.bubble.classList.contains('show')) {
                        dialogueState.bubble.remove();
                        dialogueState.bubble = null;
                    }
                }, 250);
            }
        }
        */
        
        // Dummy function to prevent errors
        function hideSpeechBubble() {
            // Speech bubble removed
            return;
        }

        // Get appropriate dialogue based on context
        // Track last shown dialogue to prevent repeats
        let lastDialogue = null;

        // Helper function to get random item from array without repeating last
        function getRandomWithoutRepeat(array) {
            if (!array || array.length === 0) return '';
            if (array.length === 1) return array[0];
            
            let selected;
            let attempts = 0;
            const maxAttempts = 10;
            
            do {
                selected = array[Math.floor(Math.random() * array.length)];
                attempts++;
            } while (selected === lastDialogue && attempts < maxAttempts);
            
            lastDialogue = selected;
            return selected;
        }

        function getDialogueForContext(context, data = {}) {
            const level = gameState.level || 1;
            let selectedDialogue = null;
            
            switch (context) {
                case 'taskComplete':
                    const category = data.category || 'default';
                    const timeOfDay = getTimeOfDay();
                    const categoryPhrases = DIALOGUE_DATABASE.taskComplete[category] || DIALOGUE_DATABASE.taskComplete.default;
                    const timePhrases = DIALOGUE_DATABASE.timeOfDay[timeOfDay] || [];
                    
                    // Mix task completion with time-based responses
                    const taskAllPhrases = [...categoryPhrases, ...timePhrases];
                    return getRandomWithoutRepeat(taskAllPhrases);
                
                case 'equipment':
                    const action = data.action; // 'equip' or 'unequip'
                    const itemName = data.itemName;
                    selectedDialogue = DIALOGUE_DATABASE.equipment[action][itemName] || `${action === 'equip' ? 'Thanks for the new look!' : 'Back to my natural self!'}`;
                    lastDialogue = selectedDialogue;
                    return selectedDialogue;
                
                case 'levelUp':
                    let levelPhrases;
                    if (level >= 15) {
                        levelPhrases = DIALOGUE_DATABASE.level15plus;
                    } else if (level >= 11) {
                        levelPhrases = DIALOGUE_DATABASE.level11to14;
                    } else if (level >= 6) {
                        levelPhrases = DIALOGUE_DATABASE.level6to10;
                    } else {
                        levelPhrases = DIALOGUE_DATABASE.level1to5;
                    }
                    return getRandomWithoutRepeat(levelPhrases);
                
                case 'funFact':
                    return getRandomWithoutRepeat(DIALOGUE_DATABASE.funFacts);
                
                case 'idle':
                default:
                    // Choose based on level
                    let phrases;
                    if (level >= 15) {
                        phrases = DIALOGUE_DATABASE.level15plus;
                    } else if (level >= 11) {
                        phrases = DIALOGUE_DATABASE.level11to14;
                    } else if (level >= 6) {
                        phrases = DIALOGUE_DATABASE.level6to10;
                    } else {
                        phrases = DIALOGUE_DATABASE.level1to5;
                    }
                    
                    // Mix with idle phrases
                    const allPhrases = [...phrases, ...DIALOGUE_DATABASE.idle];
                    return getRandomWithoutRepeat(allPhrases);
            }
        }

        function getTimeOfDay() {
            const hour = new Date().getHours();
            if (hour >= 5 && hour < 12) return 'morning';
            if (hour >= 12 && hour < 17) return 'afternoon';
            return 'evening';
        }

        // Periodic dialogue system
        function startDialogueSystem() {
            setInterval(() => {
                const now = Date.now();
                if (now - dialogueState.lastDialogueTime >= dialogueState.dialogueInterval) {
                    const level = gameState.level || 1;
                    let dialogue;
                    
                    // Level 15+ gets fun facts 30% of the time
                    if (level >= 15 && Math.random() < 0.3) {
                        dialogue = getDialogueForContext('funFact');
                    } else {
                        dialogue = getDialogueForContext('idle');
                    }
                    
                    showSpeechBubble(dialogue);
                    dialogueState.lastDialogueTime = now;
                }
            }, 30000); // Check every 30 seconds
        }

        // Enhanced task completion with dialogue
        function completeTaskWithDialogue(index) {
            const task = gameState.tasks[index];
            if (!task) return;
            
            const category = task.category;
            completeTask(index);
            
            // Show dialogue after a brief delay
            setTimeout(() => {
                const dialogue = getDialogueForContext('taskComplete', { category });
                showSpeechBubble(dialogue);
            }, 500);
        }

        // Enhanced equipment functions with dialogue
        function equipItemWithDialogue(itemId) {
            const item = shopItems.find(i => i.id === itemId);
            if (!item) return;
            
            equipItem(itemId);
            
            // Show dialogue
            setTimeout(() => {
                const dialogue = getDialogueForContext('equipment', { 
                    action: 'equip', 
                    itemName: item.name 
                });
                showSpeechBubble(dialogue);
            }, 300);
        }

        function unequipItemWithDialogue(itemId) {
            const item = shopItems.find(i => i.id === itemId);
            if (!item) return;
            
            unequipItem(itemId);
            
            // Show dialogue
            setTimeout(() => {
                const dialogue = getDialogueForContext('equipment', { 
                    action: 'unequip', 
                    itemName: item.name 
                });
                showSpeechBubble(dialogue);
            }, 300);
        }

        // Initialize the app
        function initializeApp() {
            loadGameState();
            
            // Check energy based on pending tasks
            checkAndUpdateEnergy();
            
            updateUI();
            updateTasksDisplay();
            updateQuickTasksDisplay();
            updateAchievementsDisplay();
            updateShopDisplay();
            updateSettingsDisplay();
            
            // Set initial tab
            showTab('home');
            
            // Start dialogue system
            startDialogueSystem();
            
            // Set up periodic energy check (every 60 seconds)
            setInterval(() => {
                checkAndUpdateEnergy();
                updateUI();
            }, 60000);
            
            // Welcome message after a short delay
            setTimeout(() => {
                const dialogue = getDialogueForContext('idle');
                showSpeechBubble(dialogue, 6000);
            }, 2000);
        }

        // Update tasks display
        function updateTasksDisplay() {
            const tasksList = document.getElementById('tasksList');
            if (!tasksList) {
                console.warn('📝 tasksList element not found!');
                return;
            }
            
            const activeTasks = gameState.tasks.filter(task => !task.completed);
            console.log('📝 Updating tasks display. Total tasks:', gameState.tasks.length, 'Active tasks:', activeTasks.length);
            
            if (activeTasks.length === 0) {
                tasksList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">📝</div>
                        <div class="empty-state-text">No tasks yet</div>
                        <div class="empty-state-subtext">Create your first task to get started</div>
                    </div>
                `;
            } else {
                tasksList.innerHTML = activeTasks.map((task, index) => {
                    const categoryInfo = categoryMap[task.category] || { emoji: '📝', name: 'Other' };
                    const dueDate = task.dueDate ? new Date(task.dueDate) : null;
                    const isOverdue = dueDate && dueDate < new Date();
                    
                    // Check if task is due soon (20, 15, 10, 5, 2 minutes)
                    let dueDateDisplay = '';
                    let isWarning = false;
                    
                    if (dueDate) {
                        const now = new Date();
                        const timeDiff = dueDate.getTime() - now.getTime();
                        const minutesDiff = Math.floor(timeDiff / (1000 * 60));
                        
                        // Check if within warning thresholds
                        if (minutesDiff <= 20 && minutesDiff > 0 && [20, 15, 10, 5, 2].includes(minutesDiff)) {
                            isWarning = true;
                        }
                        
                        const dateStr = dueDate.toLocaleDateString();
                        const timeStr = dueDate.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
                        
                        if (isOverdue) {
                            dueDateDisplay = `<span class="task-due-date warning">📅 ${dateStr} ${timeStr}</span>`;
                        } else if (isWarning) {
                            dueDateDisplay = `<span class="task-due-date warning">📅 ${dateStr} ${timeStr}</span>`;
                        } else {
                            dueDateDisplay = `<span class="task-due-date">📅 ${dateStr} ${timeStr}</span>`;
                        }
                    }
                    
                    return `
                        <div class="task-card">
                            <button class="task-edit-button" onclick="editTask(${gameState.tasks.indexOf(task)})" title="Edit task"></button>
                            
                            <div class="task-header">
                                <div class="task-emoji">${categoryInfo.emoji}</div>
                                <div class="task-content">
                                    <div class="task-title">${task.title}</div>
                                    <div class="task-meta">
                                        <span class="task-badge priority-${task.priority}">${task.priority} priority</span>
                                        <span class="task-badge difficulty-${task.difficulty}">${task.difficulty} (${task.points}pts)</span>
                                        ${dueDateDisplay}
                                        ${isOverdue && !dueDateDisplay ? `<span style="color: var(--error);">Overdue</span>` : ''}
                                    </div>
                                </div>
                            </div>
                            ${task.description ? `<div style="font-size: 14px; color: var(--text-secondary); margin-bottom: 12px;">${task.description}</div>` : ''}
                            <div class="task-actions">
                                <button class="action-btn action-complete" onclick="completeTask(${gameState.tasks.indexOf(task)})" title="Complete">✓</button>
                                <button class="action-btn action-remove" onclick="deleteTask(${gameState.tasks.indexOf(task)})" title="Delete">×</button>
                            </div>
                        </div>
                    `;
                }).join('');
            }
        }

        // Challenge Progress Tracking System
        function updateChallengeProgress(task, isQuickTask = false) {
            if (!gameState.dailyChallenge || gameState.dailyChallengeCompleted) {
                return;
            }

            const challenge = gameState.dailyChallenge;
            const challengeDesc = (challenge.desc || '').toLowerCase();
            
            // Special case: Rest day challenge (no tasks required)
            if (challengeDesc.includes('take a break') || challengeDesc.includes('no tasks required')) {
                // This challenge is auto-completed at generation
                return;
            }
            
            // Check if the completed task matches the challenge criteria
            let shouldIncrement = false;
            
            // 1. Quick Task challenges
            if (challengeDesc.includes('quick task') && isQuickTask) {
                shouldIncrement = true;
            }
            // 2. Category-specific challenges (work, personal, home, learning, wellness, creative)
            else if (!isQuickTask && task && task.category) {
                const taskCategory = task.category.toLowerCase();
                
                // Check for specific category mentions
                if ((challengeDesc.includes('work') && taskCategory.includes('work')) ||
                    (challengeDesc.includes('personal') && taskCategory.includes('personal')) ||
                    (challengeDesc.includes('home') && taskCategory.includes('home')) ||
                    (challengeDesc.includes('learning') && taskCategory.includes('learning')) ||
                    (challengeDesc.includes('wellness') && taskCategory.includes('wellness')) ||
                    (challengeDesc.includes('creative') && taskCategory.includes('creative'))) {
                    shouldIncrement = true;
                }
            }
            // 3. Difficulty-based challenges (easy, medium, hard)
            else if (!isQuickTask && task && task.difficulty) {
                const taskDifficulty = task.difficulty.toLowerCase();
                
                if ((challengeDesc.includes('easy') && taskDifficulty === 'easy') ||
                    (challengeDesc.includes('medium') && taskDifficulty === 'medium') ||
                    (challengeDesc.includes('hard') && taskDifficulty === 'hard')) {
                    shouldIncrement = true;
                }
            }
            // 4. Priority-based challenges (high-priority, low-priority)
            else if (!isQuickTask && task && task.priority) {
                const taskPriority = task.priority.toLowerCase();
                
                if ((challengeDesc.includes('high-priority') && taskPriority === 'high') ||
                    (challengeDesc.includes('low-priority') && taskPriority === 'low')) {
                    shouldIncrement = true;
                }
            }
            // 5. Streak-based challenges (handled separately, but count any task)
            else if (challengeDesc.includes('streak')) {
                // Streak challenges are verified by checking gameState.streakDays
                // Any task completion counts toward maintaining the streak
                shouldIncrement = true;
            }
            // 6. XP-based challenges (count any task since all tasks give XP)
            else if (challengeDesc.includes('xp') || challengeDesc.includes('earn')) {
                shouldIncrement = true;
            }
            // 7. Generic "complete X tasks" challenges (count any task)
            else if (challengeDesc.match(/complete \d+ task/) && 
                     !challengeDesc.includes('work') && 
                     !challengeDesc.includes('personal') && 
                     !challengeDesc.includes('home') && 
                     !challengeDesc.includes('learning') &&
                     !challengeDesc.includes('wellness') &&
                     !challengeDesc.includes('creative') &&
                     !challengeDesc.includes('quick') &&
                     !challengeDesc.includes('high-priority') &&
                     !challengeDesc.includes('low-priority') &&
                     !challengeDesc.includes('easy') &&
                     !challengeDesc.includes('medium') &&
                     !challengeDesc.includes('hard')) {
                // Generic task completion - count any task
                shouldIncrement = true;
            }
            
            // Only increment if criteria is met
            if (shouldIncrement) {
                challenge.progress++;
            }
            
            // Check if challenge is completed
            if (challenge.progress >= challenge.target && !gameState.dailyChallengeCompleted) {
                gameState.dailyChallengeCompleted = true;
                gameState.taskPoints += challenge.reward;
                
                // Track challenge completion for achievements
                if (window.achievementTracker) {
                    window.achievementTracker.trackChallengeComplete();
                }
                
                // Fire confetti first
                if (window.fireConfetti) {
                    window.fireConfetti();
                }
                
                // Show motivational tooltip message
                const motivationalMessages = [
                    `🔥 You're on fire today! +${challenge.reward} points earned.`,
                    `🌟 Amazing work! +${challenge.reward} points earned.`,
                    `💪 Crushing it! +${challenge.reward} points earned.`,
                    `✨ Fantastic! +${challenge.reward} points earned.`,
                    `🏆 You're unstoppable! +${challenge.reward} points earned.`
                ];
                const randomMessage = motivationalMessages[Math.floor(Math.random() * motivationalMessages.length)];
                
                // Show completion message with tooltip
                showSuccessMessage('🎉 Daily Challenge Complete!', `+${challenge.reward} points earned!`);
                
                // Show motivational tooltip after a short delay
                setTimeout(() => {
                    if (typeof showTooltip === 'function') {
                        showTooltip(randomMessage);
                    }
                }, 800);
            }
            
            // Update display
            updateDailyChallengeDisplay();
            saveGameState();
        }

        // Update quick tasks display
        function updateQuickTasksDisplay() {
            const quickTasksList = document.getElementById('quickTasksList');
            if (!quickTasksList) return;
            
            const activeTasks = gameState.selectedQuickTasks || [];
            
            if (activeTasks.length === 0) {
                quickTasksList.innerHTML = `
                    <div class="empty-state">
                        <div class="empty-state-icon">⚡</div>
                        <div class="empty-state-text">No quick tasks selected</div>
                        <div class="empty-state-subtext">Add some quick tasks to boost your productivity</div>
                    </div>
                `;
            } else {
                quickTasksList.innerHTML = activeTasks.map(task => `
                    <div class="quick-task-item">
                        <div class="quick-task-emoji">${task.emoji || '⚡'}</div>
                        <div class="quick-task-content">
                            <div class="quick-task-title">${task.title || 'Quick Task'}</div>
                            <div class="quick-task-category">${task.categoryName || 'General'}</div>
                        </div>
                        <div class="quick-task-points">+${task.points || 3} pts</div>
                        <div class="quick-task-actions">
                            <button class="action-btn action-complete" onclick="event.stopPropagation(); completeQuickTask('${task.id}')" title="Complete">✓</button>
                            <button class="action-btn action-remove" onclick="event.stopPropagation(); removeQuickTask('${task.id}')" title="Remove">×</button>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Update achievements display
        function updateAchievementsDisplay() {
            const achievementsList = document.getElementById('achievementsList');
            if (!achievementsList) return;
            
            // Check achievements before displaying
            if (window.achievementTracker) {
                window.achievementTracker.checkAchievements();
            }
            
            achievementsList.innerHTML = achievements.map(achievement => {
                const isUnlocked = window.achievementTracker ? 
                    window.achievementTracker.isAchievementUnlocked(achievement.id) : false;
                
                return `
                    <div class="achievement-card ${isUnlocked ? 'unlocked' : 'locked'}">
                        <div class="achievement-icon">${achievement.icon}</div>
                        <div class="achievement-content">
                            <div class="achievement-name">${achievement.name}</div>
                            <div class="achievement-desc">${achievement.desc}</div>
                        </div>
                        <div class="achievement-status ${isUnlocked ? 'unlocked' : 'locked'}">
                            ${isUnlocked ? 'Unlocked' : 'Locked'}
                        </div>
                    </div>
                `;
            }).join('');
        }

        // Update shop items display
        function updateShopDisplay() {
            const grid = document.getElementById('shopItemsGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            // Render each battle item as a shop card
            Object.values(battleItems).forEach(item => {
                const currentQuantity = gameState.battleInventory[item.id] || 0;
                const isLocked = item.levelRequired && gameState.jerryLevel < item.levelRequired;
                const isMaxed = item.maxQuantity && currentQuantity >= item.maxQuantity;
                const canAfford = (gameState.jerryXP || 0) >= item.cost;
                
                const card = document.createElement('div');
                card.className = 'shop-item-card';
                
                // Add locked or maxed styling
                if (isLocked) {
                    card.style.opacity = '0.5';
                    card.style.cursor = 'not-allowed';
                } else if (isMaxed) {
                    card.style.opacity = '0.7';
                }
                
                let buttonText = 'Buy Now';
                let buttonDisabled = '';
                
                if (isLocked) {
                    buttonText = `🔒 Level ${item.levelRequired}`;
                    buttonDisabled = 'disabled style="opacity: 0.5; cursor: not-allowed;"';
                } else if (isMaxed) {
                    buttonText = '✅ Maxed Out';
                    buttonDisabled = 'disabled style="opacity: 0.5; cursor: not-allowed;"';
                } else if (!canAfford) {
                    buttonText = 'Not Enough XP';
                    buttonDisabled = 'disabled style="opacity: 0.7;"';
                }
                
                const maxQuantityText = item.maxQuantity ? `<div style="font-size: 11px; color: #999; margin-top: 4px;">Max: ${item.maxQuantity}</div>` : '';
                
                card.innerHTML = `
                    <div class="shop-item-emoji">${item.emoji}</div>
                    <div class="shop-item-name">${item.name}</div>
                    <div class="shop-item-desc">${item.description}</div>
                    <div class="shop-item-quantity">Owned: ${currentQuantity}</div>
                    ${maxQuantityText}
                    <div class="shop-item-cost">${item.cost} XP</div>
                    <button class="shop-buy-btn" onclick="buyItem('${item.id}')" ${buttonDisabled}>${buttonText}</button>
                `;
                
                grid.appendChild(card);
            });
        }



        // Update settings display
        function updateSettingsDisplay() {
            const darkModeToggle = document.getElementById('darkModeToggle');
            const notificationsToggle = document.getElementById('notificationsToggle');
            
            if (darkModeToggle) {
                darkModeToggle.classList.toggle('active', gameState.darkMode);
            }
            
            if (notificationsToggle) {
                notificationsToggle.classList.toggle('active', gameState.notifications);
            }
        }

        // Daily Challenge System
        // Daily Challenge System - Simplified & Trackable
        // All challenges have clear, automatically verifiable acceptance criteria
        const DAILY_CHALLENGES = [
            // Basic Task Completion (Any Type)
            "Complete 1 task today",
            "Complete 2 tasks today",
            "Complete 3 tasks today",
            "Complete 4 tasks today",
            "Complete 5 tasks today",
            "Complete 6 tasks today",
            "Complete 7 tasks today",
            "Complete 8 tasks today",
            "Complete 10 tasks today",
            
            // Work Category
            "Complete 1 work task",
            "Complete 2 work tasks",
            "Complete 3 work tasks",
            "Complete 4 work tasks",
            
            // Personal Category
            "Complete 1 personal task",
            "Complete 2 personal tasks",
            "Complete 3 personal tasks",
            
            // Home Category
            "Complete 1 home task",
            "Complete 2 home tasks",
            "Complete 3 home tasks",
            
            // Learning Category
            "Complete 1 learning task",
            "Complete 2 learning tasks",
            
            // Wellness Category
            "Complete 1 wellness task",
            "Complete 2 wellness tasks",
            
            // Creative Category
            "Complete 1 creative task",
            "Complete 2 creative tasks",
            
            // Quick Tasks
            "Complete 1 quick task",
            "Complete 2 quick tasks",
            "Complete 3 quick tasks",
            "Complete 4 quick tasks",
            "Complete 5 quick tasks",
            "Complete 6 quick tasks",
            "Complete 8 quick tasks",
            "Complete 10 quick tasks",
            
            // Priority-Based
            "Complete 1 high-priority task",
            "Complete 2 high-priority tasks",
            "Complete 3 high-priority tasks",
            "Complete 1 low-priority task",
            "Complete 2 low-priority tasks",
            
            // Difficulty-Based
            "Complete 1 easy task",
            "Complete 2 easy tasks",
            "Complete 3 easy tasks",
            "Complete 1 medium task",
            "Complete 2 medium tasks",
            "Complete 1 hard task",
            "Complete 2 hard tasks",
            
            // Mixed Combinations
            "Complete 1 work and 1 personal task",
            "Complete 1 work and 1 wellness task",
            "Complete 2 work and 1 wellness task",
            "Complete 1 hard and 1 easy task",
            "Complete 1 high-priority and 1 low-priority task",
            
            // XP-Based (tracks XP accumulation)
            "Earn 50 XP today",
            "Earn 75 XP today",
            "Earn 100 XP today",
            "Earn 150 XP today",
            "Earn 200 XP today",
            
            // Streak-Based (tracks streak days)
            "Reach a 2-day streak",
            "Reach a 3-day streak",
            "Reach a 4-day streak",
            "Reach a 5-day streak",
            "Reach a 7-day streak",
            
            // Rest Day
            "Take a break! No tasks required today—you've earned it"
        ];

        const CARD_COLORS = [
            'var(--daily-card-purple)',
            'var(--daily-card-green)',
            'var(--daily-card-orange-gradient)',
            'var(--daily-card-pink)',
            'var(--daily-card-blue)',
            'var(--daily-card-teal)',
            'var(--daily-card-red)',
            'var(--daily-card-yellow)'
        ];

        // Parse the target number from challenge description
        function parseChallengeTarget(challengeDesc) {
            // Convert to lowercase for easier matching
            const desc = challengeDesc.toLowerCase();
            
            // Look for numeric patterns in the description
            // Patterns: "complete 3", "finish 2", "reach 5", "earn 50", "add 2", etc.
            const patterns = [
                /complete (\d+)/,
                /finish (\d+)/,
                /reach (\d+)/,
                /earn (\d+)/,
                /add (\d+)/,
                /do (\d+)/,
                /check off (\d+)/,
                /clear (\d+)/,
                /create (\d+)/,
                /hit (\d+)/,
                /(\d+)[- ]day/,  // for "2-day streak" or "3 day streak"
                /at least (\d+)/,
                /(\d+) tasks?/,
                /(\d+) quick/,
                /(\d+) work/,
                /(\d+) personal/,
                /(\d+) home/,
                /(\d+) learning/,
                /(\d+) wellness/,
                /(\d+) creative/,
                /(\d+) easy/,
                /(\d+) medium/,
                /(\d+) hard/,
                /(\d+) high-priority/,
                /(\d+) low-priority/,
                /(\d+) small/,
                /(\d+) high/,
                /(\d+) low/,
                /(\d+) new/
            ];
            
            // Try each pattern
            for (const pattern of patterns) {
                const match = desc.match(pattern);
                if (match && match[1]) {
                    const num = parseInt(match[1]);
                    // For XP challenges, the number is the XP amount, not the task count
                    // So we keep target as 1 for XP challenges
                    // Use word boundary to avoid matching 'learning' as 'earn'
                    if (desc.includes('xp') || /\bearn\b/.test(desc)) {
                        return 1;
                    }
                    return num;
                }
            }
            
            // Special cases
            if (desc.includes('all quick tasks') || desc.includes('every quick task')) {
                // This requires completing all selected quick tasks
                // We'll set a reasonable default, but the logic should check against actual count
                return 1;  // Will be handled specially in the progress tracking
            }
            
            if (desc.includes('all tasks') || desc.includes('every task') || desc.includes('everything')) {
                // Similar to above - requires all tasks to be completed
                return 1;  // Will be handled specially
            }
            
            // Default to 1 if no number found
            return 1;
        }

        function generateDailyChallenge() {
            const today = new Date().toDateString();
            
            // Initialize localStorage keys if they don't exist
            let challengeIndex = parseInt(localStorage.getItem('dailyChallengeIndex')) || 0;
            let lastDate = localStorage.getItem('dailyChallengeDate') || '';
            let usedChallenges = JSON.parse(localStorage.getItem('usedChallenges') || '[]');
            let cardColorIndex = parseInt(localStorage.getItem('dailyCardColorIndex')) || 0;
            
            // Check if it's a new day
            if (lastDate !== today) {
                // If all challenges have been used, reset the cycle
                if (usedChallenges.length >= DAILY_CHALLENGES.length) {
                    usedChallenges = [];
                }
                
                // Find next unused challenge
                let availableChallenges = [];
                for (let i = 0; i < DAILY_CHALLENGES.length; i++) {
                    if (!usedChallenges.includes(i)) {
                        availableChallenges.push(i);
                    }
                }
                
                // Pick random from available
                challengeIndex = availableChallenges[Math.floor(Math.random() * availableChallenges.length)];
                usedChallenges.push(challengeIndex);
                
                // Cycle to next color
                cardColorIndex = (cardColorIndex + 1) % CARD_COLORS.length;
                
                // Save to localStorage
                localStorage.setItem('dailyChallengeIndex', challengeIndex);
                localStorage.setItem('dailyChallengeDate', today);
                localStorage.setItem('usedChallenges', JSON.stringify(usedChallenges));
                localStorage.setItem('dailyCardColorIndex', cardColorIndex);
                
                // Update game state
                const challengeDesc = DAILY_CHALLENGES[challengeIndex];
                gameState.dailyChallenge = {
                    id: 'daily_' + challengeIndex,
                    name: 'Daily Challenge',
                    desc: challengeDesc,
                    target: parseChallengeTarget(challengeDesc),
                    progress: 0,
                    reward: 50,
                    color: CARD_COLORS[cardColorIndex]
                };
                gameState.dailyChallengeCompleted = false;
                gameState.lastDailyChallengeDate = today;
            } else if (!gameState.dailyChallenge) {
                // Load existing challenge from localStorage
                const challengeDesc = DAILY_CHALLENGES[challengeIndex];
                gameState.dailyChallenge = {
                    id: 'daily_' + challengeIndex,
                    name: 'Daily Challenge',
                    desc: challengeDesc,
                    target: parseChallengeTarget(challengeDesc),
                    progress: 0,
                    reward: 50,
                    color: CARD_COLORS[cardColorIndex]
                };
            }
        }

        function updateDailyChallengeDisplay() {
            const challengeDisplay = document.getElementById('dailyChallengeDisplay');
            if (!challengeDisplay) return;

            // Show empty state if challenge is completed
            if (gameState.dailyChallengeCompleted) {
                challengeDisplay.innerHTML = `
                    <div class="challenge-empty-state">
                        <div class="challenge-empty-icon">🎉</div>
                        <div class="challenge-empty-title">Great job! You've completed today's challenge.</div>
                        <div class="challenge-empty-desc">Come back tomorrow for a new one!</div>
                    </div>
                `;
                return;
            }

            if (!gameState.dailyChallenge) {
                challengeDisplay.innerHTML = `
                    <div class="daily-challenge-card">
                        <div class="challenge-title">📅 No Challenge Today</div>
                        <div class="challenge-desc">Check back tomorrow for a new challenge!</div>
                        <div class="challenge-progress-container">
                            <div class="challenge-progress-label">Progress: 0/0</div>
                            <div class="challenge-progress-bar">
                                <div class="challenge-progress-fill" style="width: 0%"></div>
                            </div>
                        </div>
                        <div class="challenge-reward">🎁 Reward: 0 points</div>
                    </div>
                `;
                return;
            }

            const challenge = gameState.dailyChallenge;
            const progressPercent = Math.min(100, (challenge.progress / challenge.target) * 100);
            const cardColor = challenge.color || 'var(--daily-card-purple)';

            challengeDisplay.innerHTML = `
                <div class="daily-challenge-card" style="background: ${cardColor};">
                    <div class="challenge-title">📅 ${challenge.name}</div>
                    <div class="challenge-desc">${challenge.desc}</div>
                    <div class="challenge-progress-container">
                        <div class="challenge-progress-label">Progress: ${challenge.progress}/${challenge.target}</div>
                        <div class="challenge-progress-bar">
                            <div class="challenge-progress-fill" style="width: ${progressPercent}%"></div>
                        </div>
                    </div>
                    <div class="challenge-reward">🎁 Reward: ${challenge.reward} points</div>
                </div>
            `;
        }

        // Stats expansion toggle
        function toggleStatsExpansion() {
            const collapsed = document.getElementById('statsCollapsed');
            const expanded = document.getElementById('statsExpanded');
            const toggle = document.getElementById('statsToggle');
            
            if (expanded.style.display === 'none') {
                // Show expanded view
                collapsed.style.display = 'none';
                expanded.style.display = 'grid';
                toggle.textContent = '▼';
                toggle.classList.add('expanded');
            } else {
                // Show collapsed view
                collapsed.style.display = 'grid';
                expanded.style.display = 'none';
                toggle.textContent = '▼';
                toggle.classList.remove('expanded');
            }
        }

        // Daily Challenge expansion toggle
        function toggleDailyChallengeExpansion() {
            const content = document.getElementById('dailyChallengeContent');
            const toggle = document.getElementById('dailyChallengeToggle');
            
            if (content.style.display === 'none') {
                // Show content
                content.style.display = 'block';
                toggle.textContent = '▼';
                toggle.classList.add('expanded');
            } else {
                // Hide content
                content.style.display = 'none';
                toggle.textContent = '▼';
                toggle.classList.remove('expanded');
            }
        }

        // Tab switching
        function switchToTab(tabName) {
            // Hide all tab contents
            document.querySelectorAll('.tab-content').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Remove active state from all tabs
            document.querySelectorAll('.pill-tab').forEach(tab => {
                tab.setAttribute('aria-selected', 'false');
            });
            
            // Show selected tab content
            const targetTab = document.getElementById(tabName + 'Tab');
            if (targetTab) {
                targetTab.classList.add('active');
            }
            
            // Set active state on clicked tab
            event.target.setAttribute('aria-selected', 'true');
        }

        // Shop sub-tab switching
        function switchShopSubTab(subTabName) {
            // Hide all shop sub-tab contents
            document.querySelectorAll('.shop-sub-content').forEach(content => {
                content.classList.remove('active');
            });
            
            // Remove active state from all shop sub-tabs
            document.querySelectorAll('.pill-tab-shop').forEach(tab => {
                tab.classList.remove('active');
            });
            
            // Show selected sub-tab content
            const targetContent = document.getElementById(subTabName + 'SubTabContent');
            if (targetContent) {
                targetContent.classList.add('active');
            }
            
            // Set active state on clicked sub-tab
            event.target.classList.add('active');
            
            // Update content based on sub-tab
            if (subTabName === 'shop') {
                updateShopDisplay();
            } else if (subTabName === 'owned') {
                updateOwnedItemsDisplay();
            } else if (subTabName === 'themes') {
                updateThemesDisplay();
            }
        }

        // Battle items definition (synced with battle system)
        const battleItems = {
            defense_refill: {
                id: 'defense_refill',
                name: 'Shield',
                emoji: '🛡️',
                description: 'Adds +20 Defense in next battle',
                cost: 60,
                effect: 'defense',
                value: 20
            },
            fireball: {
                id: 'fireball',
                name: 'Fireball',
                emoji: '🔥',
                description: 'Powerful ranged attack (Max: 10)',
                cost: 100,
                effect: 'attack',
                value: 30,
                levelRequired: 10,
                maxQuantity: 10
            },
            spark: {
                id: 'spark',
                name: 'Spark',
                emoji: '⚡',
                description: 'Electric ranged attack, slightly weaker than fireball (Max: 10)',
                cost: 80,
                effect: 'attack',
                value: 25,
                levelRequired: 7,
                maxQuantity: 10
            },
            health_potion: {
                id: 'health_potion',
                name: 'Potion',
                emoji: '🧪',
                description: 'Instantly restores 20 HP in battle',
                cost: 20,
                effect: 'heal',
                value: 20
            },
            attack_refill: {
                id: 'attack_refill',
                name: 'Power Boost',
                emoji: '⚡',
                description: 'Refills +30 Attack for your gauge',
                cost: 50,
                effect: 'attack_gauge',
                value: 30
            }
        };

        // Update shop items display
        function updateShopDisplay() {
            const grid = document.getElementById('shopItemsGrid');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            // Render each battle item as a shop card
            Object.values(battleItems).forEach(item => {
                const currentQuantity = gameState.battleInventory[item.id] || 0;
                const isLocked = item.levelRequired && gameState.jerryLevel < item.levelRequired;
                const isMaxed = item.maxQuantity && currentQuantity >= item.maxQuantity;
                const canAfford = (gameState.jerryXP || 0) >= item.cost;
                
                const card = document.createElement('div');
                card.className = 'shop-item-card';
                
                // Add locked or maxed styling
                if (isLocked) {
                    card.style.opacity = '0.5';
                    card.style.cursor = 'not-allowed';
                } else if (isMaxed) {
                    card.style.opacity = '0.7';
                }
                
                let buttonText = 'Buy Now';
                let buttonDisabled = '';
                
                if (isLocked) {
                    buttonText = `🔒 Level ${item.levelRequired}`;
                    buttonDisabled = 'disabled style="opacity: 0.5; cursor: not-allowed;"';
                } else if (isMaxed) {
                    buttonText = '✅ Maxed Out';
                    buttonDisabled = 'disabled style="opacity: 0.5; cursor: not-allowed;"';
                } else if (!canAfford) {
                    buttonText = 'Not Enough XP';
                    buttonDisabled = 'disabled style="opacity: 0.7;"';
                }
                
                // Show quantity if item has max quantity
                const quantityDisplay = item.maxQuantity ? `<div style="font-size: 12px; color: #999; margin-top: 4px;">${currentQuantity}/${item.maxQuantity} owned</div>` : '';
                
                card.innerHTML = `
                    <div class="shop-item-emoji">${item.emoji}</div>
                    <div class="shop-item-name">${item.name}</div>
                    <div class="shop-item-description">${item.description}</div>
                    ${quantityDisplay}
                    <div class="shop-item-cost">${item.cost} XP</div>
                    <button class="buy-now-btn" data-item-id="${item.id}" ${buttonDisabled}>
                        ${buttonText}
                    </button>
                `;
                
                // Add event listener to button
                const button = card.querySelector('.buy-now-btn');
                if (button && !button.disabled) {
                    button.addEventListener('click', (e) => {
                        e.preventDefault();
                        e.stopPropagation();
                        buyItem(item.id);
                    });
                }
                
                grid.appendChild(card);
            });
        }

        // Update owned items display (synced with battleInventory) - matches shop styling
        function updateOwnedItemsDisplay() {
            const grid = document.getElementById('ownedItemsGrid');
            const countBadge = document.getElementById('ownedItemCount');
            if (!grid) return;
            
            grid.innerHTML = '';
            
            // Count total items
            let totalItems = 0;
            Object.keys(gameState.battleInventory).forEach(itemId => {
                totalItems += gameState.battleInventory[itemId] || 0;
            });
            
            if (countBadge) {
                countBadge.textContent = `${totalItems} item${totalItems !== 1 ? 's' : ''}`;
            }
            
            // Render each owned battle item using same style as shop
            Object.keys(gameState.battleInventory).forEach(itemId => {
                const count = gameState.battleInventory[itemId];
                if (count > 0) {
                    const item = battleItems[itemId];
                    if (!item) return;
                    
                    const card = document.createElement('div');
                    card.className = 'shop-item-card'; // Use same class as shop items
                    
                    // Show quantity display
                    const quantityDisplay = item.maxQuantity ? `<div style="font-size: 12px; color: #999; margin-top: 4px;">${count}/${item.maxQuantity} owned</div>` : `<div style="font-size: 12px; color: #999; margin-top: 4px;">${count} owned</div>`;
                    
                    card.innerHTML = `
                        <div class="shop-item-emoji">${item.emoji}</div>
                        <div class="shop-item-name">${item.name}</div>
                        <div class="shop-item-description">${item.description}</div>
                        ${quantityDisplay}
                        <button class="buy-now-btn" onclick="useItemFromShop('${itemId}')">
                            Use Now
                        </button>
                    `;
                    grid.appendChild(card);
                }
            });
            
            // Show empty state if no items
            if (totalItems === 0) {
                grid.innerHTML = `
                    <div style="text-align: center; padding: 40px 20px; color: #999;">
                        <p style="font-size: 16px;">🎒 No items yet!</p>
                        <p style="font-size: 14px; margin-top: 12px;">Buy items from the Shop tab to use in battles.</p>
                    </div>
                `;
            }
        }

        // Buy item from shop
        function buyItem(itemId) {
            const item = battleItems[itemId];
            if (!item) return;
            
            // Check level requirement
            if (item.levelRequired && gameState.jerryLevel < item.levelRequired) {
                alert(`🔒 ${item.name} unlocks at Level ${item.levelRequired}! Current level: ${gameState.jerryLevel}`);
                return;
            }
            
            // Check max quantity
            const currentQuantity = gameState.battleInventory[itemId] || 0;
            if (item.maxQuantity && currentQuantity >= item.maxQuantity) {
                alert(`⚠️ You already have the maximum (${item.maxQuantity}) ${item.name}s!`);
                return;
            }
            
            // Check if player has enough XP
            if ((gameState.jerryXP || 0) < item.cost) {
                alert(`Not enough XP! You need ${item.cost} XP to buy ${item.name}.`);
                return;
            }
            
            // Deduct XP
            gameState.jerryXP = (gameState.jerryXP || 0) - item.cost;
            
            // Add item to battle inventory
            if (!gameState.battleInventory[itemId]) {
                gameState.battleInventory[itemId] = 0;
            }
            gameState.battleInventory[itemId]++;
            
            // Track that this item has been unlocked (for battle button visibility)
            if (!gameState.unlockedBattleItems) {
                gameState.unlockedBattleItems = [];
            }
            if (!gameState.unlockedBattleItems.includes(itemId)) {
                gameState.unlockedBattleItems.push(itemId);
            }
            
            // Save and update displays
            saveGameState();
            updateUI(); // Update all UI elements including XP
            updateShopDisplay(); // Refresh shop to show updated quantities
            updateOwnedItemsDisplay();
            
            // Show success message
            const remaining = item.maxQuantity ? ` (${currentQuantity + 1}/${item.maxQuantity})` : '';
            alert(`✅ ${item.name} purchased!${remaining} Check the Owned tab to use it.`);
        }

        // Use item from shop (opens battle or uses immediately)
        function useItemFromShop(itemId) {
            const item = battleItems[itemId];
            if (!item || !gameState.battleInventory[itemId] || gameState.battleInventory[itemId] <= 0) {
                alert('⚠️ Item not available!');
                return;
            }
            
            // Handle healing items (can be used outside of battle)
            if (item.effect === 'heal') {
                // Check if monster needs healing
                const maxHP = 100;
                
                // Use the SAME logic as updateUI display: gameState.health || 75
                // This ensures we read the same HP value that's shown to the user
                const currentHP = gameState.health || 75;
                
                console.log('Potion Debug - Before:', {
                    currentHP: currentHP,
                    healthType: typeof gameState.health,
                    healthValue: gameState.health
                });
                
                if (currentHP >= maxHP) {
                    alert('💚 Your monster is already at full health!');
                    return;
                }
                
                // Use healing item
                gameState.battleInventory[itemId]--;
                const healAmount = Number(item.value);
                const newHP = Math.min(maxHP, currentHP + healAmount);
                const actualHealed = newHP - currentHP;
                
                console.log('Potion Debug - Calculation:', {
                    healAmount: healAmount,
                    currentHP: currentHP,
                    newHP: newHP,
                    actualHealed: actualHealed
                });
                
                // Set new health as a number (ensure it's never 0 unless actually dead)
                gameState.health = Number(newHP);
                
                // If gameState.health was 0 before, make sure it's now properly set
                if (gameState.health === 0) {
                    gameState.health = newHP;
                }
                
                console.log('Potion Debug - After:', {
                    newHealth: gameState.health,
                    healthType: typeof gameState.health
                });
                
                // Save immediately to persist the heal
                saveGameState();
                
                // Prevent energy drain from running for 2 seconds after healing
                window.justUsedPotion = true;
                setTimeout(() => {
                    window.justUsedPotion = false;
                }, 2000);
                
                // Update all displays
                updateOwnedItemsDisplay();
                updateShopDisplay();
                updateUI();
                
                // Force update the health display
                const healthFill = document.querySelector('.health-fill');
                const healthText = document.querySelector('.health-text');
                if (healthFill) {
                    healthFill.style.width = `${gameState.health}%`;
                }
                if (healthText) {
                    healthText.textContent = `${Math.round(gameState.health)}/100`;
                }
                
                alert(`${item.emoji} ${item.name} used! Healed ${actualHealed} HP.\n\nBefore: ${currentHP} HP\nAfter: ${gameState.health} HP`);
                return;
            }
            
            // Handle battle items (attack, defense, etc.)
            if (item.effect === 'attack' || item.effect === 'defense' || item.effect === 'attack_gauge') {
                alert(`🎮 ${item.name} is ready!\n\nThis item will be automatically available in your next battle.\n\nComplete a task to trigger a battle and use it!`);
                return;
            }
            
            // Default message for other items
            alert(`🎮 ${item.name} will be available in your next battle!`);
        }

        // Modal functions
        function openCreateTaskModal() {
            document.getElementById('createTaskModal').classList.add('active');
            resetForm();
        }

        function closeModal() {
            document.getElementById('createTaskModal').classList.remove('active');
            resetForm();
        }

        function openQuickTaskModal() {
            document.getElementById('quickTaskModal').classList.add('active');
            populateQuickTaskCategories();
        }

        function closeQuickTaskModal() {
            document.getElementById('quickTaskModal').classList.remove('active');
        }

        function openChangeNameModal() {
            const modal = document.getElementById('changeNameModal');
            const input = document.getElementById('newCreatureName');
            input.value = gameState.rockName;
            modal.classList.add('active');
            setTimeout(() => {
                input.focus();
                input.select();
            }, 100);
        }

        function closeChangeNameModal() {
            document.getElementById('changeNameModal').classList.remove('active');
        }

        function saveNewCreatureName() {
            const input = document.getElementById('newCreatureName');
            const newName = input.value.trim();
            
            // Validation
            if (!newName) {
                alert('Please enter a name for your Task Pal!');
                return;
            }
            if (newName.length > 20) {
                alert('Name must be 20 characters or less!');
                return;
            }
            
            // Update game state
            gameState.rockName = newName;
            saveGameState();
            updateUI();
            
            // Close modal and show success
            closeChangeNameModal();
            showSuccessMessage(`Task Pal renamed to ${newName}!`);
        }

        function populateQuickTaskCategories() {
            const container = document.getElementById('quickTaskCategories');
            if (!container) return;
            
            container.innerHTML = '';
            
            Object.keys(quickTasksDatabase).forEach(categoryKey => {
                const category = quickTasksDatabase[categoryKey];
                
                const categorySection = document.createElement('div');
                categorySection.style.marginBottom = '32px';
                categorySection.style.marginTop = categoryKey === Object.keys(quickTasksDatabase)[0] ? '24px' : '0px';
                categorySection.innerHTML = `
                    <div style="display: flex; align-items: center; gap: 8px; margin-bottom: 20px; padding: 12px; background: transparent; border: none; border-radius: 0;">
                        <div style="font-size: 20px;">${category.emoji}</div>
                        <div style="font-size: 16px; font-weight: 600; color: var(--text-primary);">${category.name}</div>
                    </div>
                    <div style="display: grid; gap: 8px;">
                        ${category.tasks.map(task => `
                            <div style="display: flex; align-items: center; gap: 12px; padding: 12px; background: var(--bg-secondary); border: 1px solid var(--border-light); border-radius: 12px; cursor: pointer; transition: all 0.2s ease;" onclick="addQuickTask('${task.id}', '${categoryKey}')" onmouseover="this.style.borderColor='var(--accent-primary)'" onmouseout="this.style.borderColor='var(--border-light)'">
                                <div style="font-size: 20px; width: 32px; height: 32px; display: flex; align-items: center; justify-content: center; background: var(--bg-tertiary); border-radius: 8px;">${task.emoji}</div>
                                <div style="flex: 1;">
                                    <div style="font-size: 14px; font-weight: 600; color: var(--text-primary);">${task.title}</div>
                                    <div style="font-size: 12px; color: var(--text-secondary);">${category.name}</div>
                                </div>
                                <div style="font-size: 10px; font-weight: 600; color: white; background: #007AFF; padding: 3px 6px; border-radius: 6px;">+${task.points} pts</div>
                            </div>
                        `).join('')}
                    </div>
                `;
                
                container.appendChild(categorySection);
            });
        }

        // Task management functions
        function selectCategory(category) {
            document.querySelectorAll('[data-category]').forEach(el => el.classList.remove('selected'));
            const element = document.querySelector(`[data-category="${category}"]`);
            if (element) {
                element.classList.add('selected');
                selectedCategory = category;
            }
        }

        function selectDifficulty(difficulty) {
            document.querySelectorAll('[data-difficulty]').forEach(el => el.classList.remove('selected'));
            const element = document.querySelector(`[data-difficulty="${difficulty}"]`);
            if (element) {
                element.classList.add('selected');
                selectedDifficulty = difficulty;
            }
        }

        function selectPriority(priority) {
            document.querySelectorAll('[data-priority]').forEach(el => el.classList.remove('selected'));
            const element = document.querySelector(`[data-priority="${priority}"]`);
            if (element) {
                element.classList.add('selected');
                selectedPriority = priority;
            }
        }

        function resetForm() {
            document.getElementById('taskForm').reset();
            document.querySelectorAll('.selection-item').forEach(el => el.classList.remove('selected'));
            selectedCategory = null;
            selectedDifficulty = null;
            selectedPriority = null;
            editingTaskIndex = null;
            document.querySelector('.modal-title').textContent = 'Create Task';
            // Reset native datetime-local input
            document.getElementById('taskDueDate').value = '';
        }

        // Date picker now uses native HTML5 datetime-local input

        function createTask() {
            const title = document.getElementById('taskTitle').value.trim();
            const description = document.getElementById('taskDescription').value.trim();
            const dueDateInput = document.getElementById('taskDueDate').value;
            
            // Convert native datetime-local value to ISO format
            let dueDate = null;
            if (dueDateInput) {
                dueDate = new Date(dueDateInput).toISOString();
            }
            
            if (!title) {
                alert('Please enter a task title');
                return;
            }
            
            if (!selectedCategory) {
                alert('Please select a category');
                return;
            }
            
            if (!selectedDifficulty) {
                alert('Please select a difficulty');
                return;
            }
            
            if (!selectedPriority) {
                alert('Please select a priority');
                return;
            }
            
            const pointsMap = { easy: 2, medium: 5, hard: 10 };
            
            const task = {
                title,
                description,
                category: selectedCategory,
                difficulty: selectedDifficulty,
                priority: selectedPriority,
                points: pointsMap[selectedDifficulty],
                dueDate: dueDate || null,
                createdAt: new Date().toISOString(),
                completed: false
            };
            
            if (editingTaskIndex !== null) {
                gameState.tasks[editingTaskIndex] = task;
                console.log('📝 Task updated:', task);
                showSuccessMessage('Task updated successfully!');
            } else {
                gameState.tasks.push(task);
                gameState.totalTasksCreated += 1;
                console.log('📝 New task created:', task);
                console.log('📝 Total tasks now:', gameState.tasks.length);
                showSuccessMessage('Task created successfully!');
            }
            
            saveGameState();
            
            // Check energy after creating task
            checkAndUpdateEnergy();
            
            // Schedule notifications for the new/updated task
            if (window.notificationManager && task.dueDate) {
                const taskIndex = editingTaskIndex !== null ? editingTaskIndex : gameState.tasks.length - 1;
                window.notificationManager.scheduleTaskNotifications(task, taskIndex);
            }
            
            updateUI();
            updateTasksDisplay();
            closeModal();
        }

        function completeTask(index) {
            const task = gameState.tasks[index];
            if (!task) return;
            
            // Clear notifications for this task
            if (window.notificationManager) {
                window.notificationManager.clearTaskNotifications(index);
            }
            
            // Store old level for level up detection
            const oldLevel = gameState.level;
            
            // Track today's completions
            const today = new Date().toDateString();
            if (gameState.lastDayTracked !== today) {
                gameState.completedTasksToday = 0;
                gameState.lastDayTracked = today;
            }
            gameState.completedTasksToday++;
            
            // Update streak
            updateStreak();
            
            // Calculate points with streak multiplier
            const basePoints = task.points || 5;
            const multipliedPoints = Math.floor(basePoints * gameState.streakMultiplier);
            
            // Add points and health
            gameState.taskPoints += multipliedPoints;
            gameState.health = Math.min(100, gameState.health + 10);
            gameState.completedTasks++;
            
            // Add XP (with boost if active)
            let xpToAdd = basePoints * 2;
            if (gameState.xpBoostActive) {
                xpToAdd *= 2;
                gameState.xpBoostActive = false;  // Consume boost
                delete gameState.xpBoostExpiry;
                showSuccessMessage('⭐ XP Boost consumed! 2x XP earned!');
            }
            addJerryXP(xpToAdd);
            
            // Track achievement progress before removing task
            if (window.achievementTracker) {
                window.achievementTracker.trackTaskCompletion(task, false);
                window.achievementTracker.trackOnTimeTask(task);
            }
            
            // Remove task
            gameState.tasks.splice(index, 1);
            
            // Update daily challenge progress
            updateChallengeProgress(task, false);
            
            // Show completion message with random variation
            const randomMsg = getRandomCompletionMessage(false);
            const streakBonus = gameState.streakMultiplier > 1 ? `${gameState.streakMultiplier}x streak! ` : '';
            showSuccessMessage(`${randomMsg.emoji} ${randomMsg.message}`, `${streakBonus}+${multipliedPoints} points earned!`);
            
            saveGameState();
            
            // Check energy after completing task (should increase since task is done)
            checkAndUpdateEnergy();
            
            updateUI();
            updateTasksDisplay();
            updateQuickTasksDisplay();
            
            // Fire confetti
            console.log('🎯 Regular task completed, firing confetti...');
            if (window.fireConfetti) {
                window.fireConfetti();
            } else {
                console.warn('Confetti function not available');
            }
            
            // 30% chance to trigger battle
            if (Math.random() < 0.3) {
                setTimeout(() => {
                    if (typeof window.startTestBattle === 'function') {
                        console.log('⚔️ Battle triggered after task completion!');
                        try {
                            window.startTestBattle();
                        } catch(e) {
                            console.error('Battle trigger error:', e);
                        }
                    } else {
                        console.warn('Battle system not loaded yet');
                    }
                }, 2000); // Wait 2 seconds after confetti
            }
            
            // Show dialogue after a brief delay
            setTimeout(() => {
                const newLevel = gameState.level;
                if (newLevel > oldLevel) {
                    // Level up dialogue takes priority
                    const dialogue = getDialogueForContext('levelUp');
                    showSpeechBubble(dialogue);
                } else {
                    // Regular task completion dialogue
                    const dialogue = getDialogueForContext('taskComplete', { category: task.category });
                    showSpeechBubble(dialogue);
                }
            }, 1000);
        }

        function editTask(index) {
            const task = gameState.tasks[index];
            if (!task) return;
            
            editingTaskIndex = index;
            
            // Populate form
            document.getElementById('taskTitle').value = task.title || '';
            document.getElementById('taskDescription').value = task.description || '';
            
            // Format dueDate for datetime-local input (requires YYYY-MM-DDTHH:MM format)
            if (task.dueDate) {
                const date = new Date(task.dueDate);
                const year = date.getFullYear();
                const month = String(date.getMonth() + 1).padStart(2, '0');
                const day = String(date.getDate()).padStart(2, '0');
                const hours = String(date.getHours()).padStart(2, '0');
                const minutes = String(date.getMinutes()).padStart(2, '0');
                document.getElementById('taskDueDate').value = `${year}-${month}-${day}T${hours}:${minutes}`;
            } else {
                document.getElementById('taskDueDate').value = '';
            }
            
            // Select options
            if (task.category) selectCategory(task.category);
            if (task.difficulty) selectDifficulty(task.difficulty);
            if (task.priority) selectPriority(task.priority);
            
            // Update modal title
            document.querySelector('.modal-title').textContent = 'Edit Task';
            
            // Show modal
            openCreateTaskModal();
        }

        function deleteTask(index) {
            if (confirm('Are you sure you want to delete this task?')) {
                // Clear notifications for this task
                if (window.notificationManager) {
                    window.notificationManager.clearTaskNotifications(index);
                }
                
                gameState.tasks.splice(index, 1);
                saveGameState();
                updateUI();
                showSuccessMessage('Task deleted!');
            }
        }

        function addQuickTask(taskId, categoryKey) {
            const category = quickTasksDatabase[categoryKey];
            const task = category.tasks.find(t => t.id === taskId);
            
            if (!task) return;
            
            // Check if task already exists
            const exists = gameState.selectedQuickTasks.some(t => t.id === taskId);
            if (exists) {
                showSuccessMessage('Task already added!');
                return;
            }
            
            // Add task with category info
            const quickTask = {
                ...task,
                categoryName: category.name,
                categoryEmoji: category.emoji
            };
            
            gameState.selectedQuickTasks.push(quickTask);
            gameState.totalTasksCreated += 1;
            
            // Track start time for quick task achievement
            if (window.achievementTracker) {
                window.achievementTracker.trackQuickTaskStart(taskId);
            }
            
            saveGameState();
            updateUI();
            updateQuickTasksDisplay();
            closeQuickTaskModal();
            showSuccessMessage(`Added "${task.title}" to quick tasks!`);
        }

        function completeQuickTask(taskId) {
            const taskIndex = gameState.selectedQuickTasks.findIndex(t => t.id === taskId);
            if (taskIndex === -1) return;
            
            const task = gameState.selectedQuickTasks[taskIndex];
            
            // Track today's completions
            const today = new Date().toDateString();
            if (gameState.lastDayTracked !== today) {
                gameState.completedTasksToday = 0;
                gameState.lastDayTracked = today;
            }
            gameState.completedTasksToday++;
            
            // Update streak
            updateStreak();
            
            // Calculate points with streak multiplier
            const basePoints = task.points || 3;
            const multipliedPoints = Math.floor(basePoints * gameState.streakMultiplier);
            
            // Add points and health
            gameState.taskPoints += multipliedPoints;
            gameState.health = Math.min(100, gameState.health + 10);
            gameState.completedTasks++;
            
            // Add XP (with boost if active)
            let xpToAdd = basePoints * 2;
            if (gameState.xpBoostActive) {
                xpToAdd *= 2;
                gameState.xpBoostActive = false;  // Consume boost
                delete gameState.xpBoostExpiry;
                showSuccessMessage('⭐ XP Boost consumed! 2x XP earned!');
            }
            addJerryXP(xpToAdd);
            
            // Show completion message with random variation
            const randomMsg = getRandomCompletionMessage(true);
            const streakBonus = gameState.streakMultiplier > 1 ? `${gameState.streakMultiplier}x streak! ` : '';
            showSuccessMessage(`${randomMsg.emoji} ${randomMsg.message}`, `${streakBonus}+${multipliedPoints} points earned!`);
            
            // Track completed quick task
            if (!gameState.completedQuickTasks) {
                gameState.completedQuickTasks = [];
            }
            gameState.completedQuickTasks.push({
                ...task,
                completedAt: new Date().toISOString()
            });
            
            // Track achievement progress
            if (window.achievementTracker) {
                window.achievementTracker.trackQuickTaskComplete(taskId);
                window.achievementTracker.trackTaskCompletion(task, true);
            }
            
            // Remove task from pending
            gameState.selectedQuickTasks.splice(taskIndex, 1);
            
            // Update daily challenge progress
            updateChallengeProgress(task, true);
            
            saveGameState();
            
            // Check energy after completing task (should increase since task is done)
            checkAndUpdateEnergy();
            
            updateUI();
            updateTasksDisplay();
            updateQuickTasksDisplay();
            
            // Fire confetti
            console.log('⚡ Quick task completed, firing confetti...');
            if (window.fireConfetti) {
                window.fireConfetti();
            } else {
                console.warn('Confetti function not available');
            }
            
            // 30% chance to trigger battle
            if (Math.random() < 0.3) {
                setTimeout(() => {
                    if (typeof window.startTestBattle === 'function') {
                        console.log('⚔️ Battle triggered after quick task completion!');
                        try {
                            window.startTestBattle();
                        } catch(e) {
                            console.error('Battle trigger error:', e);
                        }
                    } else {
                        console.warn('Battle system not loaded yet');
                    }
                }, 2000); // Wait 2 seconds after confetti
            }
        }

        function removeQuickTask(taskId) {
            const taskIndex = gameState.selectedQuickTasks.findIndex(t => t.id === taskId);
            if (taskIndex !== -1) {
                gameState.selectedQuickTasks.splice(taskIndex, 1);
                saveGameState();
                updateUI();
                updateQuickTasksDisplay();
                showSuccessMessage('Quick task removed!');
            }
        }

        // Streak system
        function updateStreak() {
            const today = new Date().toDateString();
            const lastCompletion = gameState.lastCompletionDate;
            
            if (!lastCompletion) {
                gameState.currentStreak = 1;
                gameState.lastCompletionDate = today;
            } else if (lastCompletion === today) {
                return;
            } else {
                const lastDate = new Date(lastCompletion);
                const todayDate = new Date(today);
                const daysDiff = Math.floor((todayDate - lastDate) / (1000 * 60 * 60 * 24));
                
                if (daysDiff === 1) {
                    gameState.currentStreak++;
                    gameState.lastCompletionDate = today;
                } else {
                    gameState.currentStreak = 1;
                    gameState.lastCompletionDate = today;
                }
            }
            
            if (gameState.currentStreak > gameState.bestStreak) {
                gameState.bestStreak = gameState.currentStreak;
            }
            
            updateStreakMultiplier();
        }

        function updateStreakMultiplier() {
            if (gameState.currentStreak >= 7) {
                gameState.streakMultiplier = 3;
            } else if (gameState.currentStreak >= 3) {
                gameState.streakMultiplier = 2;
            } else {
                gameState.streakMultiplier = 1;
            }
        }

        function addJerryXP(xp) {
            gameState.jerryXP += xp;
            
            while (gameState.jerryXP >= gameState.jerryXPToNext) {
                levelUpJerry();
            }
            
            // Refresh shop display to update affordability
            if (typeof updateShopDisplay === 'function') {
                updateShopDisplay();
            }
        }

        function levelUpJerry() {
            gameState.jerryXP -= gameState.jerryXPToNext;
            gameState.jerryLevel++;
            
            gameState.jerryXPToNext = Math.floor(100 * Math.pow(1.2, gameState.jerryLevel - 1));
            
            showSuccessMessage(`🎉 ${gameState.rockName} leveled up!`, `Now Level ${gameState.jerryLevel}!`);
            
            if (window.fireConfetti) {
                window.fireConfetti();
            }
        }

        // Buy item from shop
        function buyItem(itemId) {
            const item = battleItems[itemId];
            if (!item) return;
            
            // Check level requirement
            if (item.levelRequired && gameState.jerryLevel < item.levelRequired) {
                alert(`🔒 ${item.name} unlocks at Level ${item.levelRequired}! Current level: ${gameState.jerryLevel}`);
                return;
            }
            
            // Check max quantity (removed - allow unlimited purchases)
            // if (item.maxQuantity) {
            //     const currentQuantity = gameState.battleInventory[item.id] || 0;
            //     if (currentQuantity >= item.maxQuantity) {
            //         alert(`⚠️ You already have the maximum quantity of ${item.name} (${item.maxQuantity})`);
            //         return;
            //     }
            // }
            
            // Check if user has enough XP
            if ((gameState.jerryXP || 0) < item.cost) {
                alert(`⚠️ Not enough XP! You need ${item.cost} XP but only have ${gameState.jerryXP || 0} XP.`);
                return;
            }
            
            // Deduct XP
            gameState.jerryXP -= item.cost;
            
            // Add item to battle inventory
            if (!gameState.battleInventory) {
                gameState.battleInventory = {};
            }
            if (!gameState.battleInventory[itemId]) {
                gameState.battleInventory[itemId] = 0;
            }
            
            const currentQuantity = gameState.battleInventory[itemId];
            gameState.battleInventory[itemId]++;
            
            // Track that this item has been unlocked (for battle button visibility)
            if (!gameState.unlockedBattleItems) {
                gameState.unlockedBattleItems = [];
            }
            if (!gameState.unlockedBattleItems.includes(itemId)) {
                gameState.unlockedBattleItems.push(itemId);
            }
            
            // Save and update displays
            saveGameState();
            updateUI(); // Update all UI elements including XP
            updateShopDisplay(); // Refresh shop to show updated quantities
            updateOwnedItemsDisplay();
            
            // Show success message
            const remaining = item.maxQuantity ? ` (${currentQuantity + 1}/${item.maxQuantity})` : '';
            alert(`✅ ${item.name} purchased!${remaining} Check the Owned tab to use it.`);
        }



        // Smooth scroll to pet rock function
        function scrollToPetRock() {
            const petRockHeader = document.querySelector('.pet-rock-header');
            if (petRockHeader) {
                petRockHeader.scrollIntoView({ 
                    behavior: 'smooth', 
                    block: 'center' 
                });
            }
        }

        // Settings functions
        function toggleDarkMode() {
            gameState.darkMode = !gameState.darkMode;
            
            if (gameState.darkMode) {
                document.documentElement.setAttribute('data-theme', 'dark');
            } else {
                document.documentElement.removeAttribute('data-theme');
            }
            
            saveGameState();
            updateSettingsDisplay();
        }

        async function toggleNotifications() {
            gameState.notifications = !gameState.notifications;
            
            if (gameState.notifications) {
                // Request permission when enabling
                if (window.notificationManager) {
                    const granted = await window.notificationManager.requestPermission();
                    if (!granted) {
                        gameState.notifications = false;
                        showSuccessMessage('Notification permission denied. Please enable in browser settings.');
                        saveGameState();
                        updateSettingsDisplay();
                        return;
                    }
                    // Reschedule all notifications
                    window.notificationManager.rescheduleAllNotifications();
                }
            } else {
                // Clear all notifications when disabling
                if (window.notificationManager) {
                    window.notificationManager.clearAllNotifications();
                }
            }
            
            saveGameState();
            updateSettingsDisplay();
            showSuccessMessage(`Notifications ${gameState.notifications ? 'enabled' : 'disabled'}!`);
        }

        function shareEtsyStore() {
            showSuccessMessage('Etsy store link copied to clipboard!');
        }

        function showResetOptions() {
            if (confirm('Are you sure you want to reset all progress? This cannot be undone.')) {
                // Clear all localStorage including onboarding
                localStorage.clear();
                location.reload();
            }
        }

        // Name editing is now handled via Settings modal

        // Tab navigation function
        function showTab(tabName) {
            // Hide all sections
            const sections = ['home', 'achievements', 'rockshop', 'settings'];
            sections.forEach(section => {
                const element = document.querySelector(`[data-tab="${section}"]`);
                if (element) {
                    element.style.display = 'none';
                }
            });
            
            // Show selected section
            const selectedSection = document.querySelector(`[data-tab="${tabName}"]`);
            if (selectedSection) {
                selectedSection.style.display = 'block';
            }
            
            // Update tab buttons
            document.querySelectorAll('.pill-tab').forEach(tab => {
                tab.classList.remove('active');
            });
            
            const activeTab = document.querySelector(`[onclick="showTab('${tabName}')"]`);
            if (activeTab) {
                activeTab.classList.add('active');
            }
            
            // Refresh shop display when opening shop tab to show current XP
            if (tabName === 'rockshop' && typeof updateShopDisplay === 'function') {
                updateShopDisplay();
            }
        }



        // Success message
        // Get random completion message
        function getRandomCompletionMessage(isQuickTask = false) {
            const quickTaskMessages = [
                { emoji: '⚡', message: 'Lightning fast!', subtitle: 'Quick task crushed!' },
                { emoji: '🚀', message: 'Boom! Done!', subtitle: 'Quick task completed!' },
                { emoji: '💨', message: 'Speed demon!', subtitle: 'That was quick!' },
                { emoji: '✨', message: 'Nailed it!', subtitle: 'Quick win secured!' },
                { emoji: '🔥', message: 'On fire!', subtitle: 'Quick task done!' },
                { emoji: '💪', message: 'Crushing it!', subtitle: 'Quick task finished!' },
                { emoji: '🎯', message: 'Bullseye!', subtitle: 'Quick task complete!' },
                { emoji: '⭐', message: 'Star performance!', subtitle: 'Quick task knocked out!' },
                { emoji: '🌟', message: 'Brilliant!', subtitle: 'Quick task accomplished!' },
                { emoji: '💫', message: 'Stellar work!', subtitle: 'Quick task wrapped up!' },
                { emoji: '🎊', message: 'Fantastic!', subtitle: 'Quick task conquered!' },
                { emoji: '🏆', message: 'Champion move!', subtitle: 'Quick task demolished!' },
                { emoji: '💥', message: 'Pow!', subtitle: 'Quick task obliterated!' },
                { emoji: '🎪', message: 'Show stopper!', subtitle: 'Quick task handled!' },
                { emoji: '🌈', message: 'Amazing!', subtitle: 'Quick task mastered!' }
            ];
            
            const regularTaskMessages = [
                { emoji: '🎉', message: 'Task completed!', subtitle: 'Great work!' },
                { emoji: '✅', message: 'Mission accomplished!', subtitle: 'Task done!' },
                { emoji: '🏆', message: 'Victory!', subtitle: 'Task conquered!' },
                { emoji: '💪', message: 'Crushed it!', subtitle: 'Task finished!' },
                { emoji: '🌟', message: 'Outstanding!', subtitle: 'Task complete!' },
                { emoji: '🎯', message: 'Target hit!', subtitle: 'Task achieved!' },
                { emoji: '🚀', message: 'Launched to success!', subtitle: 'Task accomplished!' },
                { emoji: '⭐', message: 'Superb!', subtitle: 'Task wrapped up!' },
                { emoji: '💫', message: 'Excellent work!', subtitle: 'Task finished!' },
                { emoji: '🔥', message: 'Blazing through!', subtitle: 'Task demolished!' },
                { emoji: '✨', message: 'Magnificent!', subtitle: 'Task completed!' },
                { emoji: '🎊', message: 'Celebration time!', subtitle: 'Task done!' },
                { emoji: '🌈', message: 'Wonderful!', subtitle: 'Task nailed!' },
                { emoji: '💥', message: 'Boom!', subtitle: 'Task crushed!' },
                { emoji: '🎪', message: 'Spectacular!', subtitle: 'Task mastered!' },
                { emoji: '🏅', message: 'Medal worthy!', subtitle: 'Task completed!' },
                { emoji: '🎖️', message: 'Heroic effort!', subtitle: 'Task conquered!' },
                { emoji: '👏', message: 'Bravo!', subtitle: 'Task accomplished!' },
                { emoji: '🙌', message: 'Hands up!', subtitle: 'Task finished!' },
                { emoji: '💯', message: 'Perfect!', subtitle: 'Task done!' }
            ];
            
            const messages = isQuickTask ? quickTaskMessages : regularTaskMessages;
            return messages[Math.floor(Math.random() * messages.length)];
        }

        function showSuccessMessage(message, subtitle = '') {
            const successDiv = document.createElement('div');
            successDiv.className = 'success-message';
            
            // Extract emoji from message if present
            const emojiMatch = message.match(/^([\u{1F300}-\u{1F9FF}]|[\u{2600}-\u{26FF}]|[\u{2700}-\u{27BF}])\s*/u);
            let emoji = '🎉';
            let mainMessage = message;
            
            if (emojiMatch) {
                emoji = emojiMatch[1];
                mainMessage = message.replace(emojiMatch[0], '').trim();
            }
            
            successDiv.innerHTML = `
                <div class="success-message-emoji">${emoji}</div>
                <div class="success-message-content">
                    <div class="success-message-title">${mainMessage}</div>
                    ${subtitle ? `<div class="success-message-subtitle">${subtitle}</div>` : ''}
                </div>
            `;
            
            document.body.appendChild(successDiv);
            
            setTimeout(() => {
                successDiv.remove();
            }, 3000);
        }

        // Confetti system
        function initializeConfetti() {
            const canvas = document.getElementById("confetti-canvas");
            const ctx = canvas.getContext("2d");
            let particles = [];
            let animationFrame;

            function resize() {
                canvas.width = window.innerWidth;
                canvas.height = window.innerHeight;
            }
            window.addEventListener("resize", resize);
            resize();

            function createParticle(x, y) {
                return {
                    x,
                    y,
                    dx: Math.random() * 6 - 3,
                    dy: Math.random() * -5 - 2,
                    size: Math.random() * 6 + 4,
                    color: `hsl(${Math.random() * 360}, 80%, 60%)`,
                    life: 100
                };
            }

            function render() {
                ctx.clearRect(0, 0, canvas.width, canvas.height);
                particles.forEach((p, i) => {
                    p.x += p.dx;
                    p.y += p.dy;
                    p.dy += 0.1;
                    p.life--;

                    ctx.fillStyle = p.color;
                    ctx.fillRect(p.x, p.y, p.size, p.size);

                    if (p.life <= 0) particles.splice(i, 1);
                });
                if (particles.length > 0) {
                    animationFrame = requestAnimationFrame(render);
                } else {
                    ctx.clearRect(0, 0, canvas.width, canvas.height);
                    if (animationFrame) {
                        cancelAnimationFrame(animationFrame);
                        animationFrame = null;
                    }
                }
            }

            window.fireConfetti = function() {
                console.log('🎉 Confetti fired! Particles before:', particles.length);
                const centerX = window.innerWidth / 2;
                const centerY = window.innerHeight / 2;
                
                for (let i = 0; i < 50; i++) {
                    particles.push(createParticle(
                        centerX + (Math.random() - 0.5) * 100,
                        centerY + (Math.random() - 0.5) * 100
                    ));
                }
                
                console.log('🎉 Confetti particles after:', particles.length);
                
                // Always start animation, even if one is already running
                if (!animationFrame) {
                    console.log('🎉 Starting new confetti animation');
                    render();
                } else {
                    console.log('🎉 Animation already running, particles added');
                }
            };
        }

        // Close modals when clicking outside
        window.addEventListener('click', function(event) {
            const createModal = document.getElementById('createTaskModal');
            const quickModal = document.getElementById('quickTaskModal');
            const changeNameModal = document.getElementById('changeNameModal');
            
            if (event.target === createModal) {
                closeModal();
            }
            if (event.target === quickModal) {
                closeQuickTaskModal();
            }
            if (event.target === changeNameModal) {
                closeChangeNameModal();
            }
        });

        // Initialize app
        document.addEventListener('DOMContentLoaded', function() {
            try {
                loadGameState();
                generateDailyChallenge();
                
                // Initialize selectedQuickTasks if it doesn't exist
                if (!gameState.selectedQuickTasks) {
                    gameState.selectedQuickTasks = [];
                }
                
                // Apply dark mode if enabled
                if (gameState.darkMode) {
                    document.documentElement.setAttribute('data-theme', 'dark');
                }
                

                // Initialize confetti system
                initializeConfetti();
                
                // Initialize shop display
                updateShopDisplay();
                
                // Initialize the complete app with dialogue system
                initializeApp();
                
                // Reschedule notifications for all tasks on app load
                if (window.notificationManager && gameState.notifications) {
                    setTimeout(() => {
                        window.notificationManager.rescheduleAllNotifications();
                    }, 1500);
                }
                
                // Ensure sprite is loaded after initialization
                setTimeout(() => {
                    const spritePrefix = localStorage.getItem('heroSpritePrefix');
                    if (spritePrefix) {
                        const mainHeroSprite = document.getElementById('mainHeroSprite');
                        if (mainHeroSprite) {
                            mainHeroSprite.src = `assets/heroes/${spritePrefix}_Idle_4.png`;
                            mainHeroSprite.style.opacity = '1';
                        }
                    } else {
                        const mainHeroSprite = document.getElementById('mainHeroSprite');
                        if (mainHeroSprite) {
                            mainHeroSprite.style.opacity = '1';
                        }
                    }
                }, 100);
            } catch (error) {
                console.error('Initialization error:', error);
            }
            
            // Always hide loading screen regardless of errors
            setTimeout(() => {
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.classList.add('hidden');
                }
            }, 3000);
        });

        // --- Tooltip Function ---
        function showTooltip(message) {
          const tooltip = document.getElementById('taskPalTooltip');
          if (!tooltip) return;
          tooltip.textContent = message;
          tooltip.classList.add('visible');
          clearTimeout(window.tooltipTimer);
          window.tooltipTimer = setTimeout(() => {
            tooltip.classList.remove('visible');
          }, 50000); // 50 seconds
        }

        // --- Inject 🫤 Mood and Update Logic ---
        document.addEventListener('DOMContentLoaded', () => {
          const moodTracker = document.getElementById('moodTracker');
          if (moodTracker && !moodTracker.dataset.enhanced) {
            const moods = ['😊', '😢', '😡', '🫤'];
            const container = document.createElement('div');
            container.className = 'mood-options';
            moods.forEach(mood => {
              const btn = document.createElement('button');
              btn.textContent = mood;
              btn.className = 'mood-btn';
              btn.onclick = () => handleMoodSelection(mood);
              container.appendChild(btn);
            });
            moodTracker.innerHTML = '<p style="text-align:center;font-weight:600;margin-bottom:8px;">How are you feeling?</p>';
            moodTracker.appendChild(container);
            moodTracker.dataset.enhanced = 'true';
          }
        });

        // --- Handle Mood Selection ---
        function handleMoodSelection(mood) {
          const moodTracker = document.getElementById('moodTracker');
          if (moodTracker) moodTracker.style.display = 'none';

          let message = '';
          switch (mood) {
            case '😊': message = 'Glad to see you happy!'; break;
            case '😢': message = 'It\'s okay to feel down sometimes. You got this!'; break;
            case '😡': message = 'Take a deep breath. You\'re doing fine.'; break;
            case '🫤': message = 'Hang in there — neutral days still count!'; break;
            default: message = 'Keep going!';
          }
          showTooltip(message);
        }
</script>


    <!-- Task Monsters Game Modules -->
    <script type="module" src="js/main.js"></script>
    
    <!-- Game Message Display -->
    <div id="gameMessage" class="hidden"></div>
    
    
    <!-- Dark Theme CSS -->
    <link rel="stylesheet" href="css/dark-theme.css?v=2">
    
    <!-- Battle System CSS -->
    <link rel="stylesheet" href="css/battle.css?v=2">
    
    <!-- Quest Giver CSS -->
    <link rel="stylesheet" href="css/questGiver.css?v=1">
    
    <!-- Quest Tasks CSS -->
    <link rel="stylesheet" href="css/questTasks.css">
    
    <!-- Background Manager for time-based backgrounds -->
    <script src="js/backgroundManager.js"></script>
    <script src="js/themeManager.js"></script>
    
    <!-- Battle System Modules -->
    <script src="js/enemy.js"></script>
    <script src="js/enemy-init.js"></script>
    <script src="js/battleUI.js"></script>
    <script src="js/battleManager.js"></script>
    <script src="js/battleInit.js"></script>
    <script src="js/questTaskManager.js"></script>
    <script src="js/questGiver.js?v=2"></script>
    <script src="js/notificationManager.js"></script>
    <script src="js/achievementTracker.js"></script>
    
    <!-- Hide loading screen after page loads -->
    <script>
        window.addEventListener('load', function() {
            setTimeout(function() {
                const loadingScreen = document.getElementById('loadingScreen');
                if (loadingScreen) {
                    loadingScreen.classList.add('hidden');
                }
                // Onboarding check is handled by checkOnboardingStatus() function
            }, 3000);
        });

// ========================================
// ONBOARDING SYSTEM
// ========================================

(function() {
    let selectedMonster = null;
    let monsterName = '';
    
    const monsters = {
        luna: {
            name: 'Luna',
            title: 'The Wise Night Owl',
            description: 'Perfect for night owls and deep thinkers. Luna helps you tackle complex tasks with wisdom and patience.',
            tags: ['Calm', 'Intelligent'],
            sprite: 'assets/heroes/Owlet_Monster_Idle_4.png',
            suggestions: ['Luna', 'Sage', 'Wisdom', 'Nova', 'Athena', 'Echo']
        },
        benny: {
            name: 'Benny',
            title: 'The Gentle Giant',
            description: 'Strong and dependable. Benny helps you power through big projects with steady determination.',
            tags: ['Energetic', 'Loyal'],
            sprite: 'assets/heroes/Dude_Monster_Idle_4.png',
            suggestions: ['Benny', 'Titan', 'Boulder', 'Atlas', 'Rocky', 'Tank']
        },
        nova: {
            name: 'Nova',
            title: 'The Fiery Achiever',
            description: 'Energetic and ambitious. Nova motivates you to crush goals and achieve greatness at lightning speed.',
            tags: ['Curious', 'Optimistic'],
            sprite: 'assets/heroes/Pink_Monster_Idle_4.png',
            suggestions: ['Nova', 'Blaze', 'Jet', 'Aster', 'Rayne', 'Ember']
        }
    };
    
    function checkOnboardingStatus() {
        const hasChosen = localStorage.getItem('hasChosenMonster');
        console.log('Checking onboarding status. hasChosenMonster:', hasChosen);
        
        const overlay = document.getElementById('onboardingOverlay');
        
        if (!overlay) {
            console.error('Onboarding overlay not found!');
            return;
        }
        
        if (!hasChosen || hasChosen !== 'true') {
            console.log('Onboarding needed. Waiting for page load...');
            
            // Function to show onboarding
            const showOnboarding = () => {
                console.log('Attempting to show onboarding...');
                setTimeout(() => {
                    overlay.classList.remove('hidden');
                    console.log('Onboarding overlay displayed!');
                    console.log('Overlay classes:', overlay.className);
                }, 3100); // Wait for loading screen to finish (3000ms + 100ms buffer)
            };
            
            // Try multiple approaches to ensure it works
            if (document.readyState === 'complete') {
                console.log('Document already loaded, showing onboarding immediately');
                showOnboarding();
            } else {
                console.log('Waiting for window load event...');
                window.addEventListener('load', showOnboarding);
            }
        } else {
            console.log('User has already chosen a monster. Skipping onboarding.');
        }
    }
    
    function selectMonster(monsterId) {
        selectedMonster = monsterId;
        
        // Remove selected class from all cards
        document.querySelectorAll('.monster-card').forEach(card => {
            card.classList.remove('selected');
        });
        
        // Add selected class to chosen card
        const card = document.getElementById(monsterId + 'Card');
        if (card) {
            card.classList.add('selected');
        }
        
        // Enable continue button
        const continueBtn = document.getElementById('continueButton');
        if (continueBtn) {
            continueBtn.disabled = false;
            continueBtn.textContent = 'Continue';
        }
    }
    
    function goToStep2() {
        if (!selectedMonster) return;
        
        const monster = monsters[selectedMonster];
        
        // Hide step 1, show step 2
        document.getElementById('step1').classList.remove('active');
        document.getElementById('step2').classList.add('active');
        
        // Update step 2 content
        document.getElementById('selectedAvatar').className = 'selected-monster-avatar ' + selectedMonster;
        document.getElementById('selectedSprite').src = monster.sprite;
        document.getElementById('selectedName').textContent = monster.name;
        document.getElementById('selectedTitle').textContent = monster.title;
        document.getElementById('selectedDescription').textContent = monster.description;
        
        const tagsContainer = document.getElementById('selectedTags');
        tagsContainer.innerHTML = '';
        monster.tags.forEach(tag => {
            const tagSpan = document.createElement('span');
            tagSpan.className = 'monster-tag ' + selectedMonster;
            tagSpan.textContent = tag;
            tagsContainer.appendChild(tagSpan);
        });
        
        // Set default name
        monsterName = monster.name;
        document.getElementById('monsterNameInput').value = monsterName;
        
        // Update continue button
        const continueBtn = document.getElementById('continueButton');
        continueBtn.disabled = false;
        continueBtn.textContent = 'Continue';
    }
    
    function selectSuggestion(suggestion) {
        monsterName = suggestion;
        document.getElementById('monsterNameInput').value = suggestion;
        
        // Highlight selected chip
        document.querySelectorAll('.suggestion-chip').forEach(chip => {
            chip.classList.remove('selected');
            if (chip.textContent === suggestion) {
                chip.classList.add('selected');
            }
        });
    }
    
    function goToStep3() {
        monsterName = document.getElementById('monsterNameInput').value.trim();
        if (!monsterName) {
            monsterName = monsters[selectedMonster].name;
        }
        
        // Hide step 2, show step 3
        document.getElementById('step2').classList.remove('active');
        document.getElementById('step3').classList.add('active');
        
        // Update step 3 content
        const monster = monsters[selectedMonster];
        document.getElementById('confirmAvatar').className = 'selected-monster-avatar ' + selectedMonster;
        document.getElementById('confirmSprite').src = monster.sprite;
        document.getElementById('confirmName').textContent = monsterName;
        
        // Update continue button
        const continueBtn = document.getElementById('continueButton');
        continueBtn.textContent = "Let's Go!";
        continueBtn.disabled = false;
    }
    
    function completeOnboarding() {
        // Save to localStorage
        localStorage.setItem('hasChosenMonster', 'true');
        localStorage.setItem('selectedMonster', selectedMonster);
        localStorage.setItem('monsterName', monsterName);
        localStorage.setItem('rockName', monsterName);
        
        // Update hero sprites based on selection
        updateHeroSprites();
        
        // Hide onboarding
        document.getElementById('onboardingOverlay').classList.add('hidden');
        
        // Update hero name in the UI
        updateHeroName();
        
        // Reload to apply changes
        window.location.reload();
    }
    
    function updateHeroSprites() {
        const spriteMap = {
            luna: 'Owlet_Monster',
            benny: 'Dude_Monster',
            nova: 'Pink_Monster'
        };
        
        const prefix = spriteMap[selectedMonster];
        localStorage.setItem('heroSpritePrefix', prefix);
    }
    
    function updateHeroName() {
        const levelLabel = document.getElementById('levelLabel');
        if (levelLabel) {
            const level = gameState.level || 1;
            levelLabel.textContent = `${monsterName} | Level ${level}`;
        }
    }
    
    function loadSavedMonster() {
        const savedMonster = localStorage.getItem('selectedMonster');
        const savedName = localStorage.getItem('monsterName');
        const spritePrefix = localStorage.getItem('heroSpritePrefix') || 'Pink_Monster';
        
        if (savedMonster && savedName) {
            // Update all hero sprites
            const mainHeroSprite = document.getElementById('mainHeroSprite');
            if (mainHeroSprite) {
                mainHeroSprite.src = `assets/heroes/${spritePrefix}_Idle_4.png`;
                mainHeroSprite.style.opacity = '1';
            }
            
            const heroSprite = document.getElementById('heroSprite');
            if (heroSprite) {
                heroSprite.src = `assets/heroes/${spritePrefix}_Idle_4.png`;
            }
            
            // Update name
            const levelLabel = document.getElementById('levelLabel');
            if (levelLabel) {
                const level = gameState.level || 1;
                levelLabel.textContent = `${savedName} | Level ${level}`;
            }
        }
    }
    
    // Initialize onboarding
    document.addEventListener('DOMContentLoaded', function() {
        // Check if onboarding should be shown
        checkOnboardingStatus();
        
        // Load saved monster if exists
        loadSavedMonster();
        
        // Monster card click handlers
        document.getElementById('lunaCard').addEventListener('click', () => selectMonster('luna'));
        document.getElementById('bennyCard').addEventListener('click', () => selectMonster('benny'));
        document.getElementById('novaCard').addEventListener('click', () => selectMonster('nova'));
        
        // Continue button handler
        const continueBtn = document.getElementById('continueButton');
        continueBtn.addEventListener('click', function() {
            const step1 = document.getElementById('step1');
            const step2 = document.getElementById('step2');
            const step3 = document.getElementById('step3');
            
            if (step1.classList.contains('active')) {
                goToStep2();
            } else if (step2.classList.contains('active')) {
                goToStep3();
            } else if (step3.classList.contains('active')) {
                completeOnboarding();
            }
        });
        
        // Back button handlers
        document.getElementById('backToStep1').addEventListener('click', function() {
            document.getElementById('step2').classList.remove('active');
            document.getElementById('step1').classList.add('active');
            const continueBtn = document.getElementById('continueButton');
            continueBtn.textContent = 'Continue';
            continueBtn.disabled = !selectedMonster;
        });
        
        document.getElementById('backToStep2').addEventListener('click', function() {
            document.getElementById('step3').classList.remove('active');
            document.getElementById('step2').classList.add('active');
            const continueBtn = document.getElementById('continueButton');
            continueBtn.textContent = 'Continue';
            continueBtn.disabled = false;
        });
        
        // Name input handler
        document.getElementById('monsterNameInput').addEventListener('input', function(e) {
            monsterName = e.target.value.trim();
        });
    });
})();

    </script>

</body>
</html>
