/*! Task Rock - Rock Shop runtime (non-destructive) */
(function(){const N="TR_SHOP_V1",L={points:["taskPoints","trTaskPoints","TR_POINTS","TR:userPoints","trUserPoints"],profile:["trUserProfile","userProfile","TR:userProfile"],inventory:"TR:inventory",equipped:"TR:equipped",purchases:"TR:purchases"};const D=[{id:"blue_hat",name:"Blue Cap",slot:"hat",cost:50,img:"assets/hats/blue-hat.png",cssVars:{"--tr-hat-top":"-22%","--tr-hat-width":"60%"}}];let a=null;function p(t){const n=parseInt(t,10);return isNaN(n)?null:n}function s(t){for(const n of t){const e=localStorage.getItem(n);if(e==null)continue;try{if(/^\s*{/.test(e)){const r=JSON.parse(e);if(r&&typeof r.points=="number")return{key:n,type:"json.points",value:r.points,obj:r};if(r&&r.points&&typeof r.points=="string"&&!isNaN(parseInt(r.points,10)))return{key:n,type:"json.points",value:parseInt(r.points,10),obj:r}}}catch{}const r=p(e);if(r!=null)return{key:n,type:"number",value:r}}return null}function o(){if(a&&typeof a.get=="function"){try{return a.get()}catch{}}const t=s(L.points);if(t)return t.value;const n=s(L.profile);if(n)return n.value;const e=p(localStorage.getItem("TR:points"));return e??0}function i(t){if(a&&typeof a.set=="function"){try{a.set(t)}catch{}}const n=s(L.points);if(n){n.type==="number"?localStorage.setItem(n.key,String(t)):n.type==="json.points"&&(()=>{try{const e=n.obj||JSON.parse(localStorage.getItem(n.key));e.points=t,localStorage.setItem(n.key,JSON.stringify(e))}catch{}})()}else{const e=s(L.profile);if(e&&e.type==="json.points")try{const r=e.obj||JSON.parse(localStorage.getItem(e.key));r.points=t,localStorage.setItem(e.key,JSON.stringify(r))}catch{}else localStorage.setItem("TR:points",String(t))}window.dispatchEvent(new CustomEvent("tr:points:changed",{detail:{points:t}}));typeof window.updatePointsUI=="function"&&(()=>{try{window.updatePointsUI(t)}catch{}})()}function c(t){a&&typeof a.subscribe=="function"&&(()=>{try{a.subscribe(t)}catch{}})();window.addEventListener("tr:points:changed",e=>t(e.detail.points))}window.TRShop=window.TRShop||{},window.TRShop.setPointsAdapter=t=>{a=t||null};function d(t,n){try{const e=localStorage.getItem(t);return e?JSON.parse(e):n}catch{return n}}function m(t,n){localStorage.setItem(t,JSON.stringify(n))}function u(){return new Set(d(L.inventory,[]))}function g(t){m(L.inventory,Array.from(t))}function h(){return d(L.equipped,{})}function S(t){m(L.equipped,t)}function y(){return new Set(d(L.purchases,[]))}function v(t){m(L.purchases,Array.from(t))}function l(t,n=document){return n.querySelector(t)}function f(t,n=document){return Array.from(n.querySelectorAll(t))}function b(){return l("[data-pet-rock]")||l("#petRockWrapper")||l(".creature-container")}function E(){const t=b();if(!t)return null;let n=t.querySelector(".tr-equipment-layer");return n||(n=document.createElement("div"),n.className="tr-equipment-layer",t.appendChild(n)),n}function T(t){if(typeof window.showConfirmation=="function"){try{return window.showConfirmation(t)}catch{}}if(typeof window.showToast=="function"){try{return window.showToast(t)}catch{}}console.info("[Rock Shop]",t)}function q(){const t=f("[data-item-id]"),n=[];for(const e of t){const r=e.getAttribute("data-item-id"),w=parseInt(e.getAttribute("data-cost"),10),A=e.getAttribute("data-slot")||x(e)||"misc",O=D.find(C=>C.id===r);n.push(O?{...O,cost:isNaN(w)?(O.cost||0):w,el:e,slot:A}:{id:r,name:e.getAttribute("data-item-name")||r,cost:isNaN(w)?0:w,slot:A,el:e})}return n.find(e=>e.id==="blue_hat")||n.push({...D[0],el:document.querySelector('[data-item-id="blue_hat"]')}),n}function x(t){let n=t;for(let e=0;e<4&&n;e++)n=n.parentElement;const r=n?(n.textContent||"").toLowerCase():"";return r.includes("hat")?"hat":r.includes("accessor")?"accessory":r.includes("paint")?"paint":null}function k(t){const n=E();if(!n)return;for(;n.firstChild;)n.removeChild(n.firstChild);if(t.hat){const e=_(t.hat);if(e&&e.img){const r=document.createElement("img");r.className="tr-equip tr-hat",r.alt=e.name||"Equipped Hat",r.src=e.img,e.cssVars&&(()=>{for(const w in e.cssVars)n.style.setProperty(w,e.cssVars[w])})(),n.appendChild(r)}}}let P=[];function _(t){return P.find(n=>n.id===t)||D.find(n=>n.id===t)}function R(t){return o()>=t}function H(t){const n=u();if(n.has(t.id))return!0;if(!R(t.cost))return!1;const e=o()-t.cost;i(e),n.add(t.id),g(n);const r=y();return r.add(t.id),v(r),T(`Purchased ${t.name||t.id}.`),!0}function I(t){const n=u();if(!n.has(t.id)){const r=H(t);if(!r)return T("Not enough points to purchase.")}const e=h();e[t.slot]=t.id,S(e),k(e),T(`${t.name||t.id} equipped.`)}function B(t){const n=h();n[t]&&(delete n[t],S(n),k(n),T(`${t[0].toUpperCase()+t.slice(1)} unequipped.`))}function Q(t,n,e,r){t&&(t.classList.toggle("tr-owned",n.has(e.id)),t.classList.toggle("tr-equipped",r[e.slot]===e.id),(!n.has(e.id)&&!R(e.cost)?(t.classList.add("tr-locked"),t.setAttribute("aria-disabled","true")):(t.classList.remove("tr-locked"),t.removeAttribute("aria-disabled")),t.addEventListener("click",w=>{if(t.getAttribute("aria-disabled")==="true")return T("You don't have enough points for this item.");const A=u();if(!A.has(e.id)){if(!H(e))return;(e.slot==="hat"||e.slot==="accessory"||e.slot==="paint")&&I(e)}else{const O=h();O[e.slot]===e.id?B(e.slot):I(e)}requestAnimationFrame(z)},{once:!1})))}function z(){const t=u(),n=h();for(const e of P)Q(e.el,t,e,n)}c(()=>z());function J(){try{P=q(),k(h()),z();const t=document.querySelector("#rockShop,[data-rock-shop]")||document.body,n=new MutationObserver(()=>{P=q(),z()});n.observe(t,{childList:!0,subtree:!0})}catch(t){console.warn("TR Rock Shop failed to initialize:",t)}}document.readyState==="loading"?document.addEventListener("DOMContentLoaded",J):J();})();